# PlantUMLエディタ E2Eテスト詳細テストケース仕様書 Phase 2

## 📋 文書情報

- **仕様書バージョン**: 2.0
- **作成日**: 2025/08/13
- **作成者**: Test Automation Specialist
- **対象システム**: PlantUMLエディタ（http://localhost:8086）
- **テストフレームワーク**: Playwright v1.48.0
- **対応ブラウザ**: Chromium, Firefox, WebKit, Microsoft Edge
- **環境**: Docker（Node.js v20）

## 🎯 テスト戦略概要

### 基盤状況
- **Phase 1完了**: 10/10テスト成功（100%成功率）
- **環境構築**: Docker + MS Edge対応完了
- **実行時間**: 19.84秒（目標：30秒以内）
- **テストケース総数**: Phase 2で50+テストケース追加

### 品質目標
- **テストカバレッジ**: 機能カバレッジ95%以上
- **パフォーマンス**: TTI < 2000ms, メモリ < 50MB
- **信頼性**: 成功率95%以上維持
- **実行効率**: 全テスト実行時間 < 60秒

---

## 📂 Phase 2-A: テストカバレッジ拡充

### 1. PlantUMLコード編集と双方向同期テストケース

#### 1.1 リアルタイム同期テスト群

| テストID | テスト名 | 優先度 | 期待動作時間 |
|---------|---------|--------|-------------|
| SYNC-001 | PlantUMLコード直接編集→UI反映確認 | 高 | 500ms以内 |
| SYNC-002 | UI操作→PlantUMLコード生成確認 | 高 | 300ms以内 |
| SYNC-003 | 大量テキスト編集時の同期性能 | 中 | 1000ms以内 |
| SYNC-004 | 複数操作の連続実行時同期保持 | 高 | 各操作200ms以内 |
| SYNC-005 | ブラウザタブ切り替え後の同期状態 | 中 | 復帰時即座 |

**SYNC-001 詳細仕様**
```
前提条件: PlantUMLエディタが正常に起動している
テストステップ:
1. テキストエリア（#plantuml-code）に直接PlantUMLコードを入力
2. 500ms待機
3. UIコンポーネントの状態が更新されているか確認
4. アクターリスト、関係性表示の同期確認

期待結果:
- コード内のアクターがUIアクターリストに反映される
- 関係性がUI要素として表示される
- エラーがない限り同期は即座に完了する

測定メトリクス:
- 同期完了までの時間（目標: 500ms以内）
- UI要素更新の正確性
- メモリ使用量の変化
```

#### 1.2 エラー状態同期テスト群

| テストID | テスト名 | 優先度 | 期待動作 |
|---------|---------|--------|---------|
| SYNC-ERR-001 | 不正PlantUML構文入力時の処理 | 高 | エラー表示+部分同期保持 |
| SYNC-ERR-002 | 空白文字のみ入力時の処理 | 中 | 初期状態復帰 |
| SYNC-ERR-003 | 特殊文字含有時の同期安定性 | 中 | エラー回避+安全な同期 |
| SYNC-ERR-004 | 非常に長いコード入力時の処理 | 中 | パフォーマンス劣化回避 |
| SYNC-ERR-005 | ネットワーク切断時の同期状態 | 低 | ローカル状態保持 |

### 2. PlantUMLシナリオ種別テストケース

#### 2.1 条件分岐（Conditional）テスト群

| テストID | テスト名 | PlantUML構文 | 優先度 |
|---------|---------|-------------|--------|
| COND-001 | alt（選択肢）パターンテスト | alt/else/end | 高 |
| COND-002 | opt（オプション）パターンテスト | opt/end | 高 |
| COND-003 | break（中断）パターンテスト | break/end | 中 |
| COND-004 | critical（重要）パターンテスト | critical/end | 中 |
| COND-005 | ネストした条件分岐テスト | alt内にopt等 | 中 |

**COND-001 詳細仕様**
```
テスト目的: alt/else/end構文の正確な処理確認

PlantUMLコードサンプル:
@startuml
Alice -> Bob: 認証要求
alt 認証成功
    Bob -> Alice: 認証OK
else 認証失敗
    Bob -> Alice: 認証NG
    Alice -> Alice: エラーログ記録
end
@enduml

検証項目:
1. alt/else/end構文の正確なパース
2. UI上での条件分岐表現
3. コード生成の正確性
4. エラーハンドリングの適切性

期待結果:
- 条件分岐が視覚的に表現される
- コード↔UI双方向同期が維持される
- 構文エラーが適切に検出される
```

#### 2.2 ループ処理（Loop）テスト群

| テストID | テスト名 | PlantUML構文 | 優先度 |
|---------|---------|-------------|--------|
| LOOP-001 | 基本ループパターンテスト | loop/end | 高 |
| LOOP-002 | 条件付きループテスト | loop[条件]/end | 高 |
| LOOP-003 | ネストループテスト | loop内loop | 中 |
| LOOP-004 | 無限ループ検出テスト | 無限ループ構文 | 低 |
| LOOP-005 | ループ+条件分岐組み合わせ | loop+alt | 中 |

**LOOP-001 詳細仕様**
```
PlantUMLコードサンプル:
@startuml
Alice -> Bob: 処理開始
loop 3回繰り返し
    Bob -> Bob: データ処理
    Bob -> Alice: 進捗報告
end
Alice -> Bob: 処理完了確認
@enduml

検証項目:
1. ループ構文の正確な認識
2. 繰り返し回数の表示
3. ループ内部処理の適切な表現
4. パフォーマンス影響の測定
```

#### 2.3 並行処理（Parallel）テスト群

| テストID | テスト名 | PlantUML構文 | 優先度 |
|---------|---------|-------------|--------|
| PAR-001 | 基本並行処理テスト | par/and/end | 高 |
| PAR-002 | 複数ブランチ並行テスト | par/and/and/end | 高 |
| PAR-003 | 並行処理+同期ポイント | par with sync | 中 |
| PAR-004 | 並行処理のタイムアウト | 時間制約あり | 中 |
| PAR-005 | 非同期処理の可視化 | 非同期メッセージ | 低 |

---

## 📊 Phase 2-B: パフォーマンステスト強化

### 1. Core Web Vitals測定テスト群

| テストID | メトリクス | 目標値 | 重要度 | 測定方法 |
|---------|-----------|--------|--------|----------|
| PERF-CWV-001 | FCP (First Contentful Paint) | < 100ms | 高 | Performance Observer |
| PERF-CWV-002 | LCP (Largest Contentful Paint) | < 1000ms | 高 | Performance Observer |
| PERF-CWV-003 | FID (First Input Delay) | < 50ms | 高 | Event Timing API |
| PERF-CWV-004 | CLS (Cumulative Layout Shift) | < 0.1 | 中 | Layout Shift API |
| PERF-CWV-005 | TTI (Time to Interactive) | < 2000ms | 高 | Lighthouse API |

**PERF-CWV-005 TTI測定 詳細仕様**
```javascript
// TTI測定の実装例
async function measureTTI(page) {
  const start = performance.now();
  
  await page.goto(BASE_URL);
  
  // メインスレッドが安定するまで待機
  await page.waitForFunction(() => {
    return window.requestIdleCallback && 
           document.readyState === 'complete' &&
           !window.performance.getEntriesByType('measure')
             .some(m => m.name.includes('layout-shift'));
  });
  
  // インタラクション可能性をテスト
  await page.click('button:first-child');
  const response = performance.now() - start;
  
  return response;
}

期待結果: TTI値が2000ms以下
許容範囲: ±200ms
警告範囲: 1800-2200ms
```

### 2. リソース使用量監視テスト群

| テストID | 監視項目 | 目標値 | 測定間隔 | 警告閾値 |
|---------|----------|--------|----------|----------|
| PERF-RES-001 | ヒープメモリ使用量 | < 50MB | 1秒毎 | 45MB |
| PERF-RES-002 | CPU使用率 | < 30% | 500ms毎 | 25% |
| PERF-RES-003 | ネットワーク帯域幅 | < 1MB/min | 5秒毎 | 800KB/min |
| PERF-RES-004 | DOM要素数 | < 1000個 | 操作後 | 900個 |
| PERF-RES-005 | イベントリスナー数 | < 100個 | 操作後 | 90個 |

### 3. 負荷テスト群

| テストID | 負荷条件 | 期待性能 | 優先度 |
|---------|----------|----------|--------|
| LOAD-001 | 大量アクター（50個）追加 | 応答時間 < 3秒 | 高 |
| LOAD-002 | 複雑なPlantUMLコード（1000行） | パース時間 < 5秒 | 中 |
| LOAD-003 | 連続操作（100回クリック） | 応答性劣化なし | 高 |
| LOAD-004 | 長時間稼働（1時間） | メモリリークなし | 中 |
| LOAD-005 | マルチタブ同時実行 | 各タブ正常動作 | 低 |

---

## 🔄 Phase 2-C: CI/CD統合テスト

### 1. GitHub Actions統合テスト群

| テストID | 統合項目 | トリガー条件 | 期待結果 |
|---------|----------|------------|----------|
| CI-001 | プルリクエスト時テスト実行 | PR作成/更新 | 全テスト成功 |
| CI-002 | メインブランチマージ時テスト | merge to main | 回帰テスト成功 |
| CI-003 | 定期実行テスト（夜間） | cron: 0 2 * * * | 品質状況報告 |
| CI-004 | パフォーマンス回帰検出 | 性能劣化時 | アラート送信 |
| CI-005 | テスト結果アーティファクト保存 | テスト完了時 | レポート生成 |

### 2. テスト結果レポート自動生成

| 生成内容 | 形式 | 保存先 | 更新頻度 |
|---------|------|--------|----------|
| テスト成功率レポート | HTML | test-results/ | 実行毎 |
| パフォーマンスメトリクス | JSON | metrics/ | 実行毎 |
| スクリーンショット比較 | PNG | screenshots/ | 失敗時 |
| カバレッジレポート | lcov | coverage/ | 実行毎 |
| トレンドグラフ | SVG | trends/ | 日次 |

---

## 🛡️ 品質保証戦略

### 1. ビジュアルリグレッションテスト群

| テストID | 対象画面/要素 | 比較方法 | 許容差異 |
|---------|-------------|----------|----------|
| VRT-001 | 初期画面全体 | フルページ比較 | 0.1% |
| VRT-002 | アクター追加後状態 | 領域比較 | 0.2% |
| VRT-003 | パターン選択画面 | コンポーネント比較 | 0.1% |
| VRT-004 | エラー表示状態 | 要素比較 | 0.05% |
| VRT-005 | レスポンシブ表示 | マルチ解像度 | 0.3% |

**VRT-001 実装仕様**
```javascript
// ビジュアルリグレッションテスト実装例
await runTest('VRT-001: 初期画面ビジュアル回帰', async () => {
  await page.goto(BASE_URL, { waitUntil: 'networkidle' });
  
  // 動的要素の安定化
  await page.waitForTimeout(500);
  
  // フルページスクリーンショット
  const screenshot = await page.screenshot({
    fullPage: true,
    threshold: 0.1, // 0.1%の差異を許容
    animations: 'disabled' // アニメーション無効化
  });
  
  // ベースライン比較
  expect(screenshot).toMatchSnapshot('initial-page.png');
});
```

### 2. アクセシビリティテスト群

| テストID | WCAG準拠レベル | 対象項目 | 優先度 |
|---------|-------------|----------|--------|
| A11Y-001 | AA | キーボードナビゲーション | 高 |
| A11Y-002 | AA | スクリーンリーダー対応 | 高 |
| A11Y-003 | AA | 色彩コントラスト比 | 中 |
| A11Y-004 | AA | フォーカス表示 | 中 |
| A11Y-005 | AAA | 音声読み上げテスト | 低 |

### 3. セキュリティテスト群

| テストID | 攻撃ベクトル | 対策確認項目 | リスクレベル |
|---------|------------|------------|------------|
| SEC-001 | XSS (Cross-Site Scripting) | 入力値サニタイズ | 高 |
| SEC-002 | CSRF (Cross-Site Request Forgery) | CSRFトークン | 中 |
| SEC-003 | インジェクション攻撃 | 入力検証 | 高 |
| SEC-004 | 情報漏洩 | エラーメッセージ | 中 |
| SEC-005 | DoS (Denial of Service) | レート制限 | 低 |

**SEC-001 XSS対策テスト**
```javascript
await runTest('SEC-001: XSS攻撃対策', async () => {
  const maliciousInputs = [
    '<script>alert("XSS")</script>',
    'javascript:alert("XSS")',
    '<img src="x" onerror="alert(\'XSS\')">'
  ];
  
  for (const input of maliciousInputs) {
    await page.fill('#plantuml-code', input);
    await page.waitForTimeout(1000);
    
    // スクリプト実行されていないことを確認
    const alerts = await page.evaluate(() => window.alertCalled);
    expect(alerts).toBeFalsy();
    
    // サニタイズされた出力確認
    const output = await page.textContent('#plantuml-code');
    expect(output).not.toContain('<script>');
  }
});
```

---

## 📈 テスト実行計画とメトリクス

### 実行スケジュール

| フェーズ | 実行タイミング | 対象テストケース | 目標実行時間 |
|---------|-------------|----------------|-------------|
| Phase 2-A | 開発時（手動） | 拡充テスト（20ケース） | 25分 |
| Phase 2-B | 日次自動 | パフォーマンステスト（15ケース） | 20分 |
| Phase 2-C | PR/マージ時 | 全体統合テスト（50ケース） | 60分 |
| 品質保証 | 週次自動 | VRT+A11Y+SEC（15ケース） | 30分 |

### 品質メトリクス測定計画

| メトリクス分類 | 測定項目 | 目標値 | 現在値 | 改善計画 |
|-------------|----------|--------|--------|----------|
| **機能品質** | テスト成功率 | 95%以上 | 100% | 維持 |
|  | 機能カバレッジ | 95%以上 | 80%推定 | +15% |
|  | 回帰バグ発見率 | 90%以上 | 未測定 | 測定開始 |
| **パフォーマンス** | 平均応答時間 | < 500ms | 未測定 | ベースライン取得 |
|  | 95%ile応答時間 | < 1000ms | 未測定 | 目標設定 |
|  | メモリ使用量 | < 50MB | 未測定 | 継続監視 |
| **信頼性** | フレーキーテスト率 | < 2% | 0% | 維持 |
|  | テスト実行成功率 | > 98% | 100% | 維持 |
|  | 環境起因失敗率 | < 1% | 0% | 環境安定化 |

### 継続的改善計画

#### 短期目標（2週間）
1. Phase 2-Aテストケース完全実装
2. パフォーマンスベースライン確立  
3. CI/CD基本統合完了

#### 中期目標（1ヶ月）
1. 全テストケース自動化完了
2. ビジュアルリグレッション導入
3. セキュリティテスト統合

#### 長期目標（3ヶ月）
1. AI支援テスト生成導入
2. 予測的品質分析実装
3. ゼロダウンタイムテスト環境構築

---

## 🔧 実装ガイドライン

### テストコード品質基準
- **可読性**: テスト名は日本語で意図を明確に表現
- **保守性**: 共通関数の積極的活用
- **信頼性**: タイムアウト・リトライ機構の適切な実装
- **効率性**: 並列実行可能な設計

### エラーハンドリング戦略
- **段階的エラー処理**: 軽微→警告→致命的の3段階
- **詳細ログ出力**: エラー原因特定可能なログレベル
- **自動復旧**: 可能な範囲での自動リトライ実装
- **通知機構**: 重要エラーの即座な通知

### パフォーマンス最適化
- **並列実行**: 独立テストの並列化
- **リソース効率化**: ブラウザインスタンス再利用
- **キャッシュ活用**: 共通リソースのキャッシュ化
- **早期失敗**: 明らかな失敗の早期検出

---

**文書承認**
- **作成者**: Test Automation Specialist
- **レビュー者**: [QA Manager]  
- **承認者**: [Project Manager]
- **承認日**: 2025/08/13

**文書管理**
- **文書ID**: QA-E2E-SPEC-002
- **バージョン**: 2.0
- **次回レビュー**: 2025/09/13
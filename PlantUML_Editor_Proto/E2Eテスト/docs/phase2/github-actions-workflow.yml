# PlantUMLã‚¨ãƒ‡ã‚£ã‚¿ E2Eãƒ†ã‚¹ãƒˆ CI/CD ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Phase 2-C: GitHub Actionsçµ±åˆãƒ†ã‚¹ãƒˆè‡ªå‹•å®Ÿè¡Œ

name: 'E2E Tests - Phase 2'

on:
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®å®Ÿè¡Œ
  pull_request:
    branches: [main, develop]
    paths: 
      - 'jp2plantuml/**'
      - 'E2Eãƒ†ã‚¹ãƒˆ/**'
      - '.github/workflows/**'
  
  # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚
  push:
    branches: [main]
    paths: 
      - 'jp2plantuml/**'
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      test_phase:
        description: 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚º'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'phase2a'
          - 'phase2b'
          - 'phase2c'
      performance_test:
        description: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ'
        required: false
        default: true
        type: boolean
  
  # å®šæœŸå®Ÿè¡Œï¼ˆå¤œé–“ï¼‰
  schedule:
    - cron: '0 2 * * *'  # æ¯æ—¥2æ™‚ï¼ˆJST 11æ™‚ï¼‰ã«å®Ÿè¡Œ

# ç’°å¢ƒå¤‰æ•°
env:
  NODE_VERSION: '20'
  PLANTUML_BASE_URL: 'http://localhost:8086'
  PLAYWRIGHT_BROWSERS_PATH: '0'
  
# ã‚¸ãƒ§ãƒ–å®šç¾©
jobs:
  # 1. ç’°å¢ƒæº–å‚™ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
  setup:
    name: 'ç’°å¢ƒæº–å‚™'
    runs-on: ubuntu-latest
    outputs:
      app-ready: ${{ steps.app-check.outputs.ready }}
    
    steps:
      - name: 'ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
        uses: actions/checkout@v4
      
      - name: 'Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'jp2plantuml/package-lock.json'
      
      - name: 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
        run: |
          cd jp2plantuml
          npm ci
      
      - name: 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•'
        run: |
          cd jp2plantuml
          npm start &
          sleep 30
        
      - name: 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ç¢ºèª'
        id: app-check
        run: |
          max_attempts=10
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -f -s ${{ env.PLANTUML_BASE_URL }} > /dev/null; then
              echo "ready=true" >> $GITHUB_OUTPUT
              echo "âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ç¢ºèªå®Œäº†"
              exit 0
            fi
            
            attempt=$((attempt + 1))
            echo "â³ èµ·å‹•ç¢ºèªä¸­... ($attempt/$max_attempts)"
            sleep 10
          done
          
          echo "ready=false" >> $GITHUB_OUTPUT
          echo "âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ã«å¤±æ•—"
          exit 1

  # 2. Phase 2-A: ã‚«ãƒãƒ¬ãƒƒã‚¸æ‹¡å……ãƒ†ã‚¹ãƒˆ
  test-phase2a:
    name: 'Phase 2-A: ã‚«ãƒãƒ¬ãƒƒã‚¸æ‹¡å……'
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.app-ready == 'true' && (github.event.inputs.test_phase == 'all' || github.event.inputs.test_phase == 'phase2a' || github.event_name != 'workflow_dispatch')
    
    container:
      image: mcr.microsoft.com/playwright:v1.48.0-jammy
      options: --shm-size=2gb
    
    steps:
      - name: 'ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
        uses: actions/checkout@v4
      
      - name: 'Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚³ãƒ³ãƒ†ãƒŠå†…ï¼‰'
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs
      
      - name: 'Microsoft Edge ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
          install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/
          echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge-stable.list
          apt-get update && apt-get install -y microsoft-edge-stable
      
      - name: 'E2Eãƒ†ã‚¹ãƒˆä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
        run: |
          cd E2Eãƒ†ã‚¹ãƒˆ
          npm install
      
      - name: 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰'
        run: |
          cd jp2plantuml
          npm install
          npm start &
          sleep 30
      
      - name: 'Phase 2-A ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ'
        run: |
          cd E2Eãƒ†ã‚¹ãƒˆ
          node docs/phase2/test-implementation-phase2a.js
        env:
          BASE_URL: ${{ env.PLANTUML_BASE_URL }}
          CI: true
      
      - name: 'Phase 2-A ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: phase2a-test-results
          path: |
            E2Eãƒ†ã‚¹ãƒˆ/test-results/
            E2Eãƒ†ã‚¹ãƒˆ/screenshots/
          retention-days: 30

  # 3. Phase 2-B: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  test-phase2b:
    name: 'Phase 2-B: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹'
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.app-ready == 'true' && (github.event.inputs.test_phase == 'all' || github.event.inputs.test_phase == 'phase2b' || github.event_name != 'workflow_dispatch') && (github.event.inputs.performance_test == 'true' || github.event_name != 'workflow_dispatch')
    
    container:
      image: mcr.microsoft.com/playwright:v1.48.0-jammy
      options: --shm-size=2gb
    
    steps:
      - name: 'ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
        uses: actions/checkout@v4
      
      - name: 'Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚³ãƒ³ãƒ†ãƒŠå†…ï¼‰'
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs
      
      - name: 'Microsoft Edge ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
          install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/
          echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge-stable.list
          apt-get update && apt-get install -y microsoft-edge-stable
      
      - name: 'E2Eãƒ†ã‚¹ãƒˆä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
        run: |
          cd E2Eãƒ†ã‚¹ãƒˆ
          npm install
      
      - name: 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰'
        run: |
          cd jp2plantuml
          npm install
          npm start &
          sleep 30
      
      - name: 'ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–é–‹å§‹'
        run: |
          # ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§é–‹å§‹
          top -b -d 5 > system-resources.log &
          echo $! > monitoring.pid
      
      - name: 'Phase 2-B ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ'
        run: |
          cd E2Eãƒ†ã‚¹ãƒˆ
          node docs/phase2/test-implementation-phase2b.js
        env:
          BASE_URL: ${{ env.PLANTUML_BASE_URL }}
          CI: true
      
      - name: 'ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–åœæ­¢'
        run: |
          if [ -f monitoring.pid ]; then
            kill $(cat monitoring.pid) || true
            rm monitoring.pid
          fi
      
      - name: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæœè§£æ'
        run: |
          cd E2Eãƒ†ã‚¹ãƒˆ
          echo "## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæœ" >> $GITHUB_STEP_SUMMARY
          if [ -f test-results/performance-metrics.json ]; then
            echo "### ãƒ¡ãƒˆãƒªã‚¯ã‚¹" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat test-results/performance-metrics.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: 'Phase 2-B ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: phase2b-performance-results
          path: |
            E2Eãƒ†ã‚¹ãƒˆ/test-results/
            system-resources.log
          retention-days: 30

  # 4. Phase 2-C: CI/CDçµ±åˆãƒ†ã‚¹ãƒˆ
  test-phase2c:
    name: 'Phase 2-C: CI/CDçµ±åˆ'
    runs-on: ubuntu-latest
    needs: [test-phase2a, test-phase2b]
    if: always() && (github.event.inputs.test_phase == 'all' || github.event.inputs.test_phase == 'phase2c' || github.event_name != 'workflow_dispatch')
    
    container:
      image: mcr.microsoft.com/playwright:v1.48.0-jammy
      options: --shm-size=2gb
    
    steps:
      - name: 'ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
        uses: actions/checkout@v4
      
      - name: 'Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚³ãƒ³ãƒ†ãƒŠå†…ï¼‰'
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs
      
      - name: 'Microsoft Edge ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
          install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/
          echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge-stable.list
          apt-get update && apt-get install -y microsoft-edge-stable
      
      - name: 'E2Eãƒ†ã‚¹ãƒˆä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
        run: |
          cd E2Eãƒ†ã‚¹ãƒˆ
          npm install
      
      - name: 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰'
        run: |
          cd jp2plantuml
          npm install
          npm start &
          sleep 30
      
      - name: 'Phase 2-C CI/CDçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ'
        run: |
          cd E2Eãƒ†ã‚¹ãƒˆ
          mkdir -p test-results
          node docs/phase2/test-implementation-phase2c.js
        env:
          BASE_URL: ${{ env.PLANTUML_BASE_URL }}
          OUTPUT_DIR: './test-results'
          CI: true
          GITHUB_PR_NUMBER: ${{ github.event.number }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_OUTPUT: ${{ github.output }}
      
      - name: 'çµ±åˆãƒ†ã‚¹ãƒˆçµæœå‡¦ç†'
        if: always()
        run: |
          cd E2Eãƒ†ã‚¹ãƒˆ
          echo "## CI/CDçµ±åˆãƒ†ã‚¹ãƒˆçµæœ" >> $GITHUB_STEP_SUMMARY
          
          if [ -f test-results/test-results.json ]; then
            echo "### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
            
            # JSONã‹ã‚‰çµæœã‚’æŠ½å‡ºã—ã¦ã‚µãƒãƒªã«è¿½åŠ 
            node -e "
              const fs = require('fs');
              const results = JSON.parse(fs.readFileSync('test-results/test-results.json', 'utf8'));
              const passed = results.tests.filter(t => t.status === 'passed').length;
              const failed = results.tests.filter(t => t.status === 'failed').length;
              const total = results.tests.length;
              const rate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;
              
              console.log(\`- ç·ãƒ†ã‚¹ãƒˆæ•°: \${total}\`);
              console.log(\`- æˆåŠŸ: \${passed}\`);
              console.log(\`- å¤±æ•—: \${failed}\`);
              console.log(\`- æˆåŠŸç‡: \${rate}%\`);
            " >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: 'Phase 2-C ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: phase2c-cicd-results
          path: |
            E2Eãƒ†ã‚¹ãƒˆ/test-results/
          retention-days: 30

  # 5. çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  generate-report:
    name: 'çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ'
    runs-on: ubuntu-latest
    needs: [test-phase2a, test-phase2b, test-phase2c]
    if: always()
    
    steps:
      - name: 'ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
        uses: actions/checkout@v4
      
      - name: 'Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: 'ãƒ†ã‚¹ãƒˆçµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰'
        uses: actions/download-artifact@v4
        with:
          path: ./all-test-results/
      
      - name: 'çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ'
        run: |
          mkdir -p final-report
          
          # çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
          cat > generate-integrated-report.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          const resultsDir = './all-test-results/';
          const reportDir = './final-report/';
          
          // ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆçµæœã‚’çµ±åˆ
          const integratedResults = {
            timestamp: new Date().toISOString(),
            workflow: 'Phase 2 E2E Tests',
            summary: {
              phase2a: { tests: 0, passed: 0, failed: 0 },
              phase2b: { tests: 0, passed: 0, failed: 0 },  
              phase2c: { tests: 0, passed: 0, failed: 0 }
            },
            details: []
          };
          
          // å„ãƒ•ã‚§ãƒ¼ã‚ºã®çµæœã‚’èª­ã¿è¾¼ã¿
          const phases = ['phase2a', 'phase2b', 'phase2c'];
          
          phases.forEach(phase => {
            const phaseDir = path.join(resultsDir, phase + '-test-results');
            if (fs.existsSync(phaseDir)) {
              const files = fs.readdirSync(phaseDir, { recursive: true });
              files.forEach(file => {
                if (file.endsWith('.json') && file.includes('test')) {
                  try {
                    const filePath = path.join(phaseDir, file);
                    const data = JSON.parse(fs.readFileSync(filePath, 'utf8'));
                    integratedResults.details.push({
                      phase: phase,
                      file: file,
                      data: data
                    });
                  } catch (e) {
                    console.log('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', file, e.message);
                  }
                }
              });
            }
          });
          
          // çµ±åˆçµæœã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          fs.writeFileSync(
            path.join(reportDir, 'integrated-test-results.json'),
            JSON.stringify(integratedResults, null, 2)
          );
          
          // ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          const totalTests = Object.values(integratedResults.summary).reduce((sum, phase) => sum + phase.tests, 0);
          const totalPassed = Object.values(integratedResults.summary).reduce((sum, phase) => sum + phase.passed, 0);
          const totalFailed = Object.values(integratedResults.summary).reduce((sum, phase) => sum + phase.failed, 0);
          const successRate = totalTests > 0 ? ((totalPassed / totalTests) * 100).toFixed(1) : 0;
          
          const summaryMd = `# PlantUMLã‚¨ãƒ‡ã‚£ã‚¿ E2Eãƒ†ã‚¹ãƒˆ Phase 2 - çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ
          
          ## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚µãƒãƒªãƒ¼
          
          - **å®Ÿè¡Œæ—¥æ™‚**: ${integratedResults.timestamp}
          - **ç·ãƒ†ã‚¹ãƒˆæ•°**: ${totalTests}
          - **æˆåŠŸ**: ${totalPassed}
          - **å¤±æ•—**: ${totalFailed}
          - **æˆåŠŸç‡**: ${successRate}%
          
          ## ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥çµæœ
          
          | ãƒ•ã‚§ãƒ¼ã‚º | ãƒ†ã‚¹ãƒˆæ•° | æˆåŠŸ | å¤±æ•— | æˆåŠŸç‡ |
          |---------|----------|------|------|--------|
          | Phase 2-A (ã‚«ãƒãƒ¬ãƒƒã‚¸æ‹¡å……) | ${integratedResults.summary.phase2a.tests} | ${integratedResults.summary.phase2a.passed} | ${integratedResults.summary.phase2a.failed} | ${integratedResults.summary.phase2a.tests > 0 ? ((integratedResults.summary.phase2a.passed / integratedResults.summary.phase2a.tests) * 100).toFixed(1) : 0}% |
          | Phase 2-B (ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹) | ${integratedResults.summary.phase2b.tests} | ${integratedResults.summary.phase2b.passed} | ${integratedResults.summary.phase2b.failed} | ${integratedResults.summary.phase2b.tests > 0 ? ((integratedResults.summary.phase2b.passed / integratedResults.summary.phase2b.tests) * 100).toFixed(1) : 0}% |
          | Phase 2-C (CI/CDçµ±åˆ) | ${integratedResults.summary.phase2c.tests} | ${integratedResults.summary.phase2c.passed} | ${integratedResults.summary.phase2c.failed} | ${integratedResults.summary.phase2c.tests > 0 ? ((integratedResults.summary.phase2c.passed / integratedResults.summary.phase2c.tests) * 100).toFixed(1) : 0}% |
          
          ## å“è³ªè©•ä¾¡
          
          ${successRate >= 95 ? 'ğŸ† **å„ªç§€**: å…¨ã¦ã®å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™' : 
            successRate >= 85 ? 'âœ… **è‰¯å¥½**: æ¦‚ã­è‰¯å¥½ãªçµæœã§ã™' : 
            successRate >= 70 ? 'âš ï¸ **æ³¨æ„**: æ”¹å–„ãŒæ¨å¥¨ã•ã‚Œã¾ã™' : 
            'ğŸš¨ **è¦æ”¹å–„**: é‡å¤§ãªå•é¡ŒãŒã‚ã‚Šã¾ã™'}
          
          ## æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          
          ${successRate < 95 ? '- å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®è©³ç´°ç¢ºèªã¨ä¿®æ­£\n- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®æ¤œè¨\n- ãƒ†ã‚¹ãƒˆç’°å¢ƒã®å®‰å®šæ€§å‘ä¸Š' : '- ç¾åœ¨ã®å“è³ªãƒ¬ãƒ™ãƒ«ã‚’ç¶­æŒ\n- ç¶™ç¶šçš„ãªç›£è¦–ä½“åˆ¶ã®ç¶­æŒ'}
          `;
          
          fs.writeFileSync(
            path.join(reportDir, 'SUMMARY.md'),
            summaryMd
          );
          
          console.log('çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†');
          EOF
          
          node generate-integrated-report.js
      
      - name: 'çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã‚’Step Summaryã«è¿½åŠ '
        run: |
          if [ -f final-report/SUMMARY.md ]; then
            cat final-report/SUMMARY.md >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: 'çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integrated-final-report
          path: final-report/
          retention-days: 90

  # 6. é€šçŸ¥ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã‚²ãƒ¼ãƒˆ
  notify-and-gate:
    name: 'é€šçŸ¥ãƒ»å“è³ªã‚²ãƒ¼ãƒˆ'
    runs-on: ubuntu-latest
    needs: [generate-report]
    if: always()
    
    steps:
      - name: 'ãƒ†ã‚¹ãƒˆçµæœã®è©•ä¾¡'
        id: evaluate
        run: |
          # ç°¡æ˜“çš„ãªå“è³ªã‚²ãƒ¼ãƒˆåˆ¤å®š
          phase2a_status="${{ needs.test-phase2a.result }}"
          phase2b_status="${{ needs.test-phase2b.result }}"
          phase2c_status="${{ needs.test-phase2c.result }}"
          
          failed_count=0
          [ "$phase2a_status" = "failure" ] && ((failed_count++))
          [ "$phase2b_status" = "failure" ] && ((failed_count++))
          [ "$phase2c_status" = "failure" ] && ((failed_count++))
          
          if [ $failed_count -eq 0 ]; then
            echo "gate_status=passed" >> $GITHUB_OUTPUT
            echo "quality_score=100" >> $GITHUB_OUTPUT
          elif [ $failed_count -eq 1 ]; then
            echo "gate_status=warning" >> $GITHUB_OUTPUT
            echo "quality_score=75" >> $GITHUB_OUTPUT
          else
            echo "gate_status=failed" >> $GITHUB_OUTPUT
            echo "quality_score=50" >> $GITHUB_OUTPUT
          fi
      
      - name: 'å“è³ªã‚²ãƒ¼ãƒˆçµæœè¡¨ç¤º'
        run: |
          echo "## ğŸšª å“è³ªã‚²ãƒ¼ãƒˆçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${{ steps.evaluate.outputs.gate_status }}" >> $GITHUB_STEP_SUMMARY
          echo "**å“è³ªã‚¹ã‚³ã‚¢**: ${{ steps.evaluate.outputs.quality_score }}/100" >> $GITHUB_STEP_SUMMARY
          
          case "${{ steps.evaluate.outputs.gate_status }}" in
            "passed")
              echo "âœ… **çµæœ**: å“è³ªã‚²ãƒ¼ãƒˆã‚’é€šéã—ã¾ã—ãŸã€‚ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã§ã™ã€‚" >> $GITHUB_STEP_SUMMARY
              ;;
            "warning") 
              echo "âš ï¸ **çµæœ**: ä¸€éƒ¨ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ãŒã€æ¡ä»¶ä»˜ãã§ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã§ã™ã€‚" >> $GITHUB_STEP_SUMMARY
              ;;
            "failed")
              echo "ğŸš« **çµæœ**: å“è³ªã‚²ãƒ¼ãƒˆåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ã€‚ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
      
      - name: 'å“è³ªã‚²ãƒ¼ãƒˆå¤±æ•—æ™‚ã®å‡¦ç†'
        if: steps.evaluate.outputs.gate_status == 'failed'
        run: |
          echo "âŒ å“è³ªã‚²ãƒ¼ãƒˆå¤±æ•—: E2Eãƒ†ã‚¹ãƒˆã®ä¿®æ­£ãŒå¿…è¦ã§ã™"
          exit 1

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†æ™‚ã®å‡¦ç†
# artifacts ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¯30-90æ—¥å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹
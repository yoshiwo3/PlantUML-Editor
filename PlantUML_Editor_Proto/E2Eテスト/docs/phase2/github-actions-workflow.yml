# PlantUML„Ç®„Éá„Ç£„Çø E2E„ÉÜ„Çπ„Éà Phase2 - GitHub Actions CI/CDË®≠ÂÆö
# Êó¢Â≠ò„ÅÆÊàêÂäüÁí∞Â¢ÉÔºà10/10ÊàêÂäüÔºâ„Çí„Éô„Éº„Çπ„Å®„Åó„ÅüCI/CDÁµ±Âêà

name: 'PlantUML Editor E2E Tests - Phase 2'

on:
  push:
    branches: [ main, develop, feature/* ]
    paths:
      - 'PlantUML_Editor_Proto/**'
      - 'jp2plantuml/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'PlantUML_Editor_Proto/**'
      - 'jp2plantuml/**'
  schedule:
    # ÊØéÊó•ÂçàÂâç2ÊôÇÔºàJST 11ÊôÇÔºâ„Å´ÂÆüË°å
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: '„ÉÜ„Çπ„Éà„Çπ„Ç§„Éº„ÉàÈÅ∏Êäû'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - basic
          - sync
          - complex-flows
          - performance
      browser:
        description: '„Éñ„É©„Ç¶„Ç∂ÈÅ∏Êäû'
        required: true
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - msedge
          - all-browsers

env:
  BASE_URL: http://localhost:8086
  NODE_ENV: test
  PLAYWRIGHT_BROWSERS_PATH: /ms/playwright

jobs:
  # „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Ëµ∑Âãï„Å®„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
  prepare-environment:
    runs-on: ubuntu-latest
    outputs:
      app-ready: ${{ steps.health-check.outputs.ready }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'jp2plantuml/package.json'
      
      - name: Install application dependencies
        working-directory: jp2plantuml
        run: npm ci
        
      - name: Start application server
        working-directory: jp2plantuml
        run: |
          npm start &
          echo "APPLICATION_PID=$!" >> $GITHUB_ENV
        
      - name: Wait for application startup
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:8086; do sleep 2; done'
          echo "Application started successfully"
        
      - name: Health check
        id: health-check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8086)
          if [ "$response" = "200" ]; then
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Application health check passed"
          else
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "‚ùå Application health check failed: HTTP $response"
            exit 1
          fi

  # Âü∫Êú¨„ÉÜ„Çπ„ÉàÔºàÊó¢Â≠ò„ÅÆÊàêÂäü„ÉÜ„Çπ„ÉàÔºâ
  basic-tests:
    needs: prepare-environment
    if: needs.prepare-environment.outputs.app-ready == 'true'
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.48.0-jammy
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js in container
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs
          
      - name: Install test dependencies
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà
        run: npm ci
        
      - name: Install Playwright browsers
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà
        run: npx playwright install ${{ matrix.browser }}
        
      - name: Start application server
        working-directory: jp2plantuml
        run: |
          npm ci
          npm start &
          sleep 10
          curl -f http://localhost:8086 || (echo "App startup failed" && exit 1)
        
      - name: Run basic E2E tests
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà
        run: node test-docker.js ${{ matrix.browser }}
        
      - name: Upload basic test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: basic-test-results-${{ matrix.browser }}
          path: |
            PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà/test-results/
            PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà/screenshots/
          retention-days: 30

  # Phase2 ÂêåÊúüÊ©üËÉΩ„ÉÜ„Çπ„Éà
  sync-functionality-tests:
    needs: [prepare-environment, basic-tests]
    if: needs.prepare-environment.outputs.app-ready == 'true' && (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'sync' || github.event_name != 'workflow_dispatch')
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.48.0-jammy
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js in container
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs
          
      - name: Install test dependencies
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà
        run: npm ci
        
      - name: Install Playwright browsers
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà
        run: npx playwright install ${{ matrix.browser }}
        
      - name: Start application server
        working-directory: jp2plantuml
        run: |
          npm ci
          npm start &
          sleep 10
          curl -f http://localhost:8086 || (echo "App startup failed" && exit 1)
        
      - name: Run sync functionality tests
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà/docs/phase2
        run: node test-sync-functionality.js ${{ matrix.browser }}
        
      - name: Upload sync test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-test-results-${{ matrix.browser }}
          path: |
            PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà/test-results/
            PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà/screenshots/
          retention-days: 30

  # Phase2 Ë§áÈõë„Éï„É≠„Éº„ÉÜ„Çπ„Éà
  complex-flows-tests:
    needs: [prepare-environment, basic-tests]
    if: needs.prepare-environment.outputs.app-ready == 'true' && (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'complex-flows' || github.event_name != 'workflow_dispatch')
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.48.0-jammy
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js in container
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs
          
      - name: Install test dependencies
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà
        run: npm ci
        
      - name: Install Playwright browsers
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà
        run: npx playwright install ${{ matrix.browser }}
        
      - name: Start application server
        working-directory: jp2plantuml
        run: |
          npm ci
          npm start &
          sleep 10
          curl -f http://localhost:8086 || (echo "App startup failed" && exit 1)
        
      - name: Run complex flows tests
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà/docs/phase2
        run: node test-complex-flows.js ${{ matrix.browser }}
        
      - name: Upload complex flows test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: complex-flows-test-results-${{ matrix.browser }}
          path: |
            PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà/test-results/
            PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà/screenshots/
          retention-days: 30

  # Phase2 „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÉÜ„Çπ„Éà
  performance-tests:
    needs: [prepare-environment, basic-tests]
    if: needs.prepare-environment.outputs.app-ready == 'true' && (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'performance' || github.event_name != 'workflow_dispatch')
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.48.0-jammy
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js in container
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs
          
      - name: Install test dependencies
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà
        run: npm ci
        
      - name: Install Playwright browsers
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà
        run: npx playwright install ${{ matrix.browser }}
        
      - name: Start application server
        working-directory: jp2plantuml
        run: |
          npm ci
          npm start &
          sleep 10
          curl -f http://localhost:8086 || (echo "App startup failed" && exit 1)
        
      - name: Run performance tests
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà/docs/phase2
        run: node test-performance-metrics.js ${{ matrix.browser }}
        
      - name: Upload performance test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results-${{ matrix.browser }}
          path: |
            PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà/test-results/
            PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà/screenshots/
          retention-days: 30

  # Microsoft EdgeÂ∞ÇÁî®„ÉÜ„Çπ„Éà
  edge-tests:
    needs: [prepare-environment, basic-tests]
    if: needs.prepare-environment.outputs.app-ready == 'true' && (github.event.inputs.browser == 'msedge' || github.event.inputs.browser == 'all-browsers' || github.event_name != 'workflow_dispatch')
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.48.0-jammy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js in container
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs
          
      - name: Install Microsoft Edge
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
          install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/
          echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge-stable.list
          apt-get update && apt-get install -y microsoft-edge-stable
          
      - name: Install test dependencies
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà
        run: npm ci
        
      - name: Install Playwright browsers
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà
        run: npx playwright install msedge chromium firefox webkit
        
      - name: Start application server
        working-directory: jp2plantuml
        run: |
          npm ci
          npm start &
          sleep 10
          curl -f http://localhost:8086 || (echo "App startup failed" && exit 1)
        
      - name: Run Edge basic tests
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà
        run: node test-edge-docker.js
        
      - name: Run Edge Phase2 tests
        working-directory: PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà/docs/phase2
        run: |
          node test-sync-functionality.js msedge
          node test-complex-flows.js msedge
          node test-performance-metrics.js msedge
        
      - name: Upload Edge test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: edge-test-results
          path: |
            PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà/test-results/
            PlantUML_Editor_Proto/E2E„ÉÜ„Çπ„Éà/screenshots/
          retention-days: 30

  # „ÉÜ„Çπ„ÉàÁµêÊûúÁµ±Âêà„Å®„É¨„Éù„Éº„ÉàÁîüÊàê
  generate-test-report:
    needs: [basic-tests, sync-functionality-tests, complex-flows-tests, performance-tests, edge-tests]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results-all/
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies for report generation
        run: |
          npm init -y
          npm install --save-dev fs-extra glob
          
      - name: Generate consolidated test report
        run: |
          cat > generate-report.js << 'EOF'
          const fs = require('fs-extra');
          const glob = require('glob');
          const path = require('path');
          
          async function generateReport() {
            const resultsDir = 'test-results-all';
            const reportFile = 'consolidated-test-report.md';
            
            let report = `# PlantUML „Ç®„Éá„Ç£„Çø E2E „ÉÜ„Çπ„ÉàÁµêÊûú„É¨„Éù„Éº„Éà - Phase 2
          
          **ÂÆüË°åÊó•ÊôÇ**: ${new Date().toISOString()}
          **„Ç≥„Éü„ÉÉ„Éà**: ${process.env.GITHUB_SHA || 'N/A'}
          **„Éñ„É©„É≥„ÉÅ**: ${process.env.GITHUB_REF_NAME || 'N/A'}
          
          ## üìä „ÉÜ„Çπ„ÉàÂÆüË°å„Çµ„Éû„É™„Éº
          
          `;
          
            // ÂêÑÁ®Æ„ÉÜ„Çπ„ÉàÁµêÊûú„ÇíÈõÜË®à
            const testCategories = [
              { name: 'Âü∫Êú¨„ÉÜ„Çπ„Éà', pattern: 'basic-test-results-*' },
              { name: 'ÂêåÊúüÊ©üËÉΩ„ÉÜ„Çπ„Éà', pattern: 'sync-test-results-*' },
              { name: 'Ë§áÈõë„Éï„É≠„Éº„ÉÜ„Çπ„Éà', pattern: 'complex-flows-test-results-*' },
              { name: '„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÉÜ„Çπ„Éà', pattern: 'performance-test-results-*' },
              { name: 'EdgeÂ∞ÇÁî®„ÉÜ„Çπ„Éà', pattern: 'edge-test-results' }
            ];
            
            for (const category of testCategories) {
              const dirs = glob.sync(path.join(resultsDir, category.pattern));
              
              report += `### ${category.name}\n\n`;
              
              if (dirs.length === 0) {
                report += `‚ö†Ô∏è „ÉÜ„Çπ„ÉàÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü\n\n`;
                continue;
              }
              
              report += `| „Éñ„É©„Ç¶„Ç∂ | Áä∂ÊÖã | Ë©≥Á¥∞ |\n`;
              report += `|----------|------|------|\n`;
              
              for (const dir of dirs) {
                const browserName = path.basename(dir).replace(category.pattern.replace('*', '').replace('test-results-', ''), '') || 'Edge';
                
                // „ÉÜ„Çπ„ÉàÁµêÊûú„Éï„Ç°„Ç§„É´„ÇíÊé¢„Åô
                const jsonFiles = glob.sync(path.join(dir, '**/*.json'));
                let status = '‚úÖ ÊàêÂäü';
                let details = '„ÉÜ„Çπ„ÉàÂÆå‰∫Ü';
                
                if (jsonFiles.length === 0) {
                  status = '‚ö†Ô∏è ‰∏çÊòé';
                  details = 'ÁµêÊûú„Éï„Ç°„Ç§„É´„Å™„Åó';
                }
                
                report += `| ${browserName} | ${status} | ${details} |\n`;
              }
              
              report += `\n`;
            }
            
            report += `## üìÅ „Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà
          
          - „ÉÜ„Çπ„ÉàÁµêÊûú„Éï„Ç°„Ç§„É´
          - „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà
          - „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„É°„Éà„É™„ÇØ„ÇπÔºàJSONÔºâ
          - HAR „Éï„Ç°„Ç§„É´Ôºà„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØË®òÈå≤Ôºâ
          - „Éì„Éá„Ç™Èå≤ÁîªÔºàÂ§±ÊïóÊôÇÔºâ
          
          ## üîß ÊîπÂñÑÊèêÊ°à
          
          Phase 2 „ÅÆ„ÉÜ„Çπ„ÉàÂÆüË£Ö„Å´„Çà„Çä„ÄÅ‰ª•‰∏ã„ÅÆÈ†òÂüü„Åß„ÅÆ„ÉÜ„Çπ„ÉàÂìÅË≥™„ÅåÂêë‰∏ä„Åó„Åæ„Åó„ÅüÔºö
          
          - ‚úÖ PlantUML„Ç≥„Éº„Éâ„Å®UI„ÅÆÂèåÊñπÂêëÂêåÊúüÊ©üËÉΩ
          - ‚úÖ Ë§áÈõë„Å™„Éï„É≠„ÉºÔºàÊù°‰ª∂ÂàÜÂ≤ê„ÄÅ„É´„Éº„Éó„ÄÅ‰∏¶Ë°åÂá¶ÁêÜÔºâ
          - ‚úÖ „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊåáÊ®ô„ÅÆÁ∂ôÁ∂öÁõ£Ë¶ñ
          - ‚úÖ CI/CD „Éë„Ç§„Éó„É©„Ç§„É≥„Åß„ÅÆËá™ÂãïÂÆüË°å
          
          ### Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó
          
          1. Ë¶ñË¶öÁöÑ„É™„Ç∞„É¨„ÉÉ„Ç∑„Éß„É≥„ÉÜ„Çπ„Éà„ÅÆËøΩÂä†
          2. API„É¨„Éô„É´„ÅÆ„ÉÜ„Çπ„ÉàÁµ±Âêà  
          3. „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÜ„Çπ„Éà„ÅÆÂÆüË£Ö
          4. „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£„ÉÜ„Çπ„Éà„ÅÆÂº∑Âåñ
          
          ---
          *„Åì„ÅÆ„É¨„Éù„Éº„Éà„ÅØ GitHub Actions „Å´„Çà„ÇäËá™ÂãïÁîüÊàê„Åï„Çå„Åæ„Åó„Åü*
          `;
            
            await fs.writeFile(reportFile, report);
            console.log(`‚úÖ „ÉÜ„Çπ„Éà„É¨„Éù„Éº„Éà„ÇíÁîüÊàê„Åó„Åæ„Åó„Åü: ${reportFile}`);
          }
          
          generateReport().catch(console.error);
          EOF
          
          node generate-report.js
          
      - name: Upload consolidated test report
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-test-report
          path: |
            consolidated-test-report.md
            test-results-all/
          retention-days: 90

  # SlackÈÄöÁü•ÔºàÊàêÂäü„ÉªÂ§±Êïó„ÅÆÈÄöÁü•Ôºâ
  notify-results:
    needs: [generate-test-report]
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'schedule')
    runs-on: ubuntu-latest
    
    steps:
      - name: Prepare notification
        id: prepare-notification
        run: |
          if [[ "${{ needs.basic-tests.result }}" == "success" && "${{ needs.sync-functionality-tests.result }}" == "success" && "${{ needs.complex-flows-tests.result }}" == "success" && "${{ needs.performance-tests.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
            echo "message=‚úÖ „Åô„Åπ„Å¶„ÅÆE2E„ÉÜ„Çπ„ÉàÔºàPhase 2Ôºâ„ÅåÊàêÂäü„Åó„Åæ„Åó„Åü" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
            echo "message=‚ùå E2E„ÉÜ„Çπ„ÉàÔºàPhase 2Ôºâ„ÅßÂ§±Êïó„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü" >> $GITHUB_OUTPUT
          fi
          
      - name: Notify Slack
        if: env.SLACK_WEBHOOK_URL
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ steps.prepare-notification.outputs.message }}",
              "color": "${{ steps.prepare-notification.outputs.color }}",
              "fields": [
                {
                  "title": "Repository",
                  "value": "${{ github.repository }}",
                  "short": true
                },
                {
                  "title": "Branch",
                  "value": "${{ github.ref_name }}",
                  "short": true
                },
                {
                  "title": "Commit",
                  "value": "${{ github.sha }}",
                  "short": true
                },
                {
                  "title": "Results",
                  "value": "Âü∫Êú¨: ${{ needs.basic-tests.result }}\nÂêåÊúü: ${{ needs.sync-functionality-tests.result }}\nË§áÈõë„Éï„É≠„Éº: ${{ needs.complex-flows-tests.result }}\n„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ: ${{ needs.performance-tests.result }}",
                  "short": false
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
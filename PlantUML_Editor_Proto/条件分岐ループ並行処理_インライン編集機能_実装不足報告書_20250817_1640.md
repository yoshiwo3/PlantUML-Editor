# 条件分岐・ループ・並行処理 インライン編集機能 実装不足報告書

**作成日時**: 2025年8月17日 16:40  
**作成者**: Claude  
**ステータス**: 🔴 重要機能未実装

## 🔴 問題の概要

ユーザーが求めている機能は、**inline-edit-prototype.html**のようなインライン編集機能ですが、現在のapp.jsには実装されていません。

## 📊 要求仕様と現状のギャップ

### ユーザーの要求（inline-edit-prototype.htmlの仕様）

#### 条件分岐の編集時
- ✅ 条件名の変更（実装済み）
- ❌ **TRUE分岐内のアクション編集**
  - From アクターの選択変更
  - 矢印タイプの変更（→、⇢、⟵、⟸）
  - To アクターの選択変更
  - メッセージテキストの編集
  - アクションの削除ボタン
  - ？ボタン（条件確認）
  - アクション追加ボタン
- ❌ **FALSE分岐内のアクション編集**（同上）

#### ループの編集時
- ✅ ループ条件の変更（実装済み）
- ❌ **ループ内のアクション編集**
  - From/To/矢印/メッセージの編集
  - アクションの追加・削除

#### 並行処理の編集時
- ✅ ブランチの追加・削除（実装済み）
- ❌ **各ブランチ内のアクション編集**
  - From/To/矢印/メッセージの編集
  - アクションの追加・削除

### 現在の実装状況（app.js）

#### editParallel関数（行4417-4578）
```javascript
// 行4548-4552の問題箇所
${branch.map((branchAction, actionIndex) => 
    `<div style="...">
        ${branchAction.from} → ${branchAction.to}: ${branchAction.text}
    </div>`
).join('')}
```
**問題**: アクションが読み取り専用の`<div>`として表示されるだけ

#### editCondition関数（行4070-4254）
```javascript
// 行4172-4176の問題箇所
${branch.map((branchAction, actionIndex) => 
    `<div style="...">
        ${branchAction.from} → ${branchAction.to}: ${branchAction.text}
    </div>`
).join('')}
```
**問題**: 同様に読み取り専用表示

#### editLoop関数（行4258-4413）
```javascript
// 行4352の問題箇所
${actions.map((loopAction, actionIndex) => 
    `<div style="...">
        ${loopAction.from} → ${loopAction.to}: ${loopAction.text}
    </div>`
).join('')}
```
**問題**: 同様に読み取り専用表示

## 🎯 必要な実装

### inline-edit-prototype.htmlの実装パターン

```html
<!-- インライン編集可能なアクション項目 -->
<div class="action-item-inline">
    <span class="drag-handle">☰</span>
    <select class="actor-select-inline">
        <option>User</option>
        <option selected>System</option>
        <option>DB</option>
        <option>API</option>
    </select>
    <select class="arrow-type-inline">
        <option value="sync" selected>→</option>
        <option value="async">⇢</option>
        <option value="return">⟵</option>
        <option value="async-return">⟸</option>
    </select>
    <select class="actor-select-inline">
        <option>User</option>
        <option>System</option>
        <option selected>DB</option>
        <option>API</option>
    </select>
    <input type="text" class="message-input-inline" value="認証情報を確認">
    <div class="action-buttons-inline">
        <button class="btn-inline delete">🗑️</button>
        <button class="btn-inline question">？</button>
    </div>
</div>
<button class="btn-add-action-inline">
    <span>➕</span>
    <span>アクション追加</span>
</button>
```

## 🔧 必要な修正内容

### 1. editParallel関数の修正
```javascript
// 各ブランチにインライン編集機能を追加
branchDiv.innerHTML = `
    <h5>ブランチ ${branchIndex + 1}</h5>
    <div class="branch-actions">
        ${branch.map((action, idx) => this.createEditableAction(action, idx)).join('')}
    </div>
    <button onclick="addActionToBranch(${branchIndex})">➕ アクション追加</button>
`;
```

### 2. createEditableAction関数の新規作成
```javascript
createEditableAction(action, index) {
    const actors = this.getCurrentActors();
    return `
        <div class="action-item-inline">
            <select class="from-actor" data-index="${index}">
                ${actors.map(a => `<option ${action.from === a ? 'selected' : ''}>${a}</option>`).join('')}
            </select>
            <select class="arrow-type" data-index="${index}">
                <option value="sync" ${!action.async ? 'selected' : ''}>→</option>
                <option value="async" ${action.async ? 'selected' : ''}>⇢</option>
            </select>
            <select class="to-actor" data-index="${index}">
                ${actors.map(a => `<option ${action.to === a ? 'selected' : ''}>${a}</option>`).join('')}
            </select>
            <input type="text" class="message-text" value="${action.text}" data-index="${index}">
            <button onclick="deleteAction(${index})">🗑️</button>
            <button onclick="toggleUncertain(${index})" class="${action.uncertain ? 'active' : ''}">？</button>
        </div>
    `;
}
```

### 3. アクション追加・削除機能
```javascript
addActionToBranch(branchIndex) {
    const newAction = {
        from: this.getCurrentActors()[0],
        to: this.getCurrentActors()[1],
        text: '新しいアクション',
        async: false,
        uncertain: false
    };
    this.tempParallelData.branches[branchIndex].push(newAction);
    this.refreshBranchDisplay();
}

deleteActionFromBranch(branchIndex, actionIndex) {
    this.tempParallelData.branches[branchIndex].splice(actionIndex, 1);
    this.refreshBranchDisplay();
}
```

## 📈 影響範囲

| 関数 | 行番号 | 影響度 | 工数（時間） |
|-----|--------|-------|------------|
| editCondition | 4070-4254 | 高 | 4-6 |
| editLoop | 4258-4413 | 高 | 3-4 |
| editParallel | 4417-4609 | 高 | 4-6 |
| 新規関数追加 | - | - | 2-3 |
| **合計** | - | - | **13-19時間** |

## 🚨 リスク

1. **大規模な変更**: 3つの主要な編集関数すべてを書き換える必要がある
2. **データ整合性**: 編集中のデータ管理が複雑になる
3. **UI/UX**: inline-edit-prototype.htmlと同等のUIを実装する必要がある
4. **テスト**: 各編集機能の動作確認が必要

## 💡 推奨対応

### Option 1: 完全実装（推奨）
inline-edit-prototype.htmlの機能を完全に実装する
- メリット：ユーザー要求を100%満たす
- デメリット：工数が大きい（13-19時間）

### Option 2: 段階的実装
最初は「アクション追加」機能のみ実装し、編集は後回し
- メリット：短期間で部分的な改善
- デメリット：完全な要求を満たさない

### Option 3: 別画面での編集
条件分岐・ループ・並行処理の中身を編集する専用画面を作成
- メリット：既存コードへの影響が少ない
- デメリット：UIの一貫性が失われる

## 📝 結論

現在の実装は、条件分岐・ループ・並行処理の**名前やブランチ数の変更**はできますが、**内部のアクション編集**ができません。

ユーザーが求めているのは、inline-edit-prototype.htmlのような**完全なインライン編集機能**です。

これは重要な機能不足であり、早急な対応が必要です。

---

**レポート作成者**: Claude  
**最終更新**: 2025年8月17日 16:40
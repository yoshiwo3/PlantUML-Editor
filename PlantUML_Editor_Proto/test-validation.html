<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlantUML ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ å‹•ä½œæ¤œè¨¼</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-section h2 {
            color: #007acc;
            margin-top: 0;
        }
        .test-controls {
            margin: 15px 0;
        }
        .btn {
            background-color: #007acc;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover {
            background-color: #005f99;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .actor-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .actor-chip {
            background-color: #e9ecef;
            padding: 5px 12px;
            border-radius: 15px;
            border: 1px solid #ced4da;
            font-size: 12px;
        }
        .iframe-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” PlantUML ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ å‹•ä½œæ¤œè¨¼ãƒ†ã‚¹ãƒˆ</h1>
        <p><strong>ä½œæˆæ—¥æ™‚:</strong> 2025-08-14 05:06:00</p>
        <p><strong>ç›®çš„:</strong> ä¿®æ­£ã•ã‚ŒãŸapp.jsã®getCurrentActorsãƒ¡ã‚½ãƒƒãƒ‰ã¨ãã®ä»–ã®æ©Ÿèƒ½ã®å‹•ä½œã‚’æ¤œè¨¼ã™ã‚‹</p>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿ -->
        <div class="test-section">
            <h2>ğŸ“± ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</h2>
            <p>ä¿®æ­£ã•ã‚ŒãŸapp.jsã‚’å«ã‚€ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’iframeå†…ã§èª­ã¿è¾¼ã¿ã¾ã™ã€‚</p>
            <div class="iframe-container">
                <iframe id="main-app" src="./index.html" title="PlantUML Editor"></iframe>
            </div>
            <div class="test-controls">
                <button class="btn" onclick="reloadMainApp()">ğŸ”„ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èª­ã¿è¾¼ã¿</button>
                <button class="btn btn-secondary" onclick="clearCache()">ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢</button>
            </div>
        </div>

        <!-- getCurrentActors ãƒ¡ã‚½ãƒƒãƒ‰ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>ğŸ­ getCurrentActors ãƒ¡ã‚½ãƒƒãƒ‰ ãƒ†ã‚¹ãƒˆ</h2>
            <p>app.jsã®getCurrentActorsãƒ¡ã‚½ãƒƒãƒ‰ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
            <div class="test-controls">
                <button class="btn" onclick="testGetCurrentActors()">ğŸ§ª getCurrentActors ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè¡Œ</button>
                <button class="btn btn-secondary" onclick="testActorSelection()">ğŸ‘¤ ã‚¢ã‚¯ã‚¿ãƒ¼é¸æŠãƒ†ã‚¹ãƒˆ</button>
                <button class="btn btn-secondary" onclick="testActorManipulation()">âš™ï¸ ã‚¢ã‚¯ã‚¿ãƒ¼æ“ä½œãƒ†ã‚¹ãƒˆ</button>
            </div>
            <div id="getCurrentActorsOutput" class="output">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾…æ©Ÿä¸­...</div>
            <div id="getCurrentActorsStatus" class="status info">æº–å‚™å®Œäº†</div>
        </div>

        <!-- ãƒ«ãƒ¼ãƒ—ãƒ€ã‚¤ã‚¢ãƒ­ã‚° ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>ğŸ” ãƒ«ãƒ¼ãƒ—ãƒ€ã‚¤ã‚¢ãƒ­ã‚° ãƒ†ã‚¹ãƒˆ</h2>
            <p>ãƒ«ãƒ¼ãƒ—å‡¦ç†ã®ä½œæˆã¨è¡¨ç¤ºæ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
            <div class="test-controls">
                <button class="btn" onclick="testLoopDialog()">ğŸ” ãƒ«ãƒ¼ãƒ—ä½œæˆãƒ†ã‚¹ãƒˆ</button>
                <button class="btn btn-secondary" onclick="testLoopGeneration()">ğŸ“ ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆ</button>
            </div>
            <div id="loopTestOutput" class="output">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾…æ©Ÿä¸­...</div>
            <div id="loopTestStatus" class="status info">æº–å‚™å®Œäº†</div>
        </div>

        <!-- ä¸¦åˆ—å‡¦ç†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>âš¡ ä¸¦åˆ—å‡¦ç†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° ãƒ†ã‚¹ãƒˆ</h2>
            <p>ä¸¦åˆ—å‡¦ç†ã®ä½œæˆã¨è¡¨ç¤ºæ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
            <div class="test-controls">
                <button class="btn" onclick="testParallelDialog()">âš¡ ä¸¦åˆ—å‡¦ç†ä½œæˆãƒ†ã‚¹ãƒˆ</button>
                <button class="btn btn-secondary" onclick="testParallelGeneration()">ğŸ“ ä¸¦åˆ—ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆ</button>
            </div>
            <div id="parallelTestOutput" class="output">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾…æ©Ÿä¸­...</div>
            <div id="parallelTestStatus" class="status info">æº–å‚™å®Œäº†</div>
        </div>

        <!-- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ç›£è¦– -->
        <div class="test-section">
            <h2>ğŸš¨ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ç›£è¦–</h2>
            <p>JavaScriptã‚¨ãƒ©ãƒ¼ã‚’ç›£è¦–ã—ã€å•é¡Œã‚’æ¤œå‡ºã—ã¾ã™ã€‚</p>
            <div class="test-controls">
                <button class="btn" onclick="startErrorMonitoring()">ğŸš¨ ã‚¨ãƒ©ãƒ¼ç›£è¦–é–‹å§‹</button>
                <button class="btn btn-danger" onclick="stopErrorMonitoring()">â¹ï¸ ç›£è¦–åœæ­¢</button>
                <button class="btn btn-secondary" onclick="clearErrorLog()">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            </div>
            <div id="errorMonitoringOutput" class="output">ã‚¨ãƒ©ãƒ¼ç›£è¦–ãŒç„¡åŠ¹ã§ã™</div>
            <div id="errorMonitoringStatus" class="status info">æº–å‚™å®Œäº†</div>
        </div>

        <!-- ç·åˆãƒ†ã‚¹ãƒˆçµæœ -->
        <div class="test-section">
            <h2>ğŸ“Š ç·åˆãƒ†ã‚¹ãƒˆçµæœ</h2>
            <p>ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã®çµæœã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
            <div class="test-controls">
                <button class="btn" onclick="runAllTests()">ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                <button class="btn btn-secondary" onclick="generateReport()">ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
            </div>
            <div id="overallTestOutput" class="output">ãƒ†ã‚¹ãƒˆæœªå®Ÿè¡Œ</div>
            <div id="overallTestStatus" class="status info">æº–å‚™å®Œäº†</div>
        </div>
    </div>

    <script>
        // ã‚¨ãƒ©ãƒ¼ç›£è¦–ç”¨
        let errorMonitoringActive = false;
        let errorLog = [];
        let originalConsoleError = console.error;
        let originalConsoleWarn = console.warn;

        // ãƒ†ã‚¹ãƒˆçµæœã‚’æ ¼ç´
        let testResults = {
            getCurrentActors: null,
            loopDialog: null,
            parallelDialog: null,
            errorMonitoring: null
        };

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èª­ã¿è¾¼ã¿
        function reloadMainApp() {
            const iframe = document.getElementById('main-app');
            const currentSrc = iframe.src;
            iframe.src = '';
            setTimeout(() => {
                iframe.src = currentSrc + '?nocache=' + Date.now();
            }, 100);
            updateStatus('ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸ', 'info', 'getCurrentActorsStatus');
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
        function clearCache() {
            const iframe = document.getElementById('main-app');
            iframe.src = iframe.src.split('?')[0] + '?v=' + Date.now();
            updateStatus('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸ', 'success', 'getCurrentActorsStatus');
        }

        // getCurrentActorsãƒ¡ã‚½ãƒƒãƒ‰ãƒ†ã‚¹ãƒˆ
        function testGetCurrentActors() {
            updateStatus('getCurrentActorsãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ†ã‚¹ãƒˆä¸­...', 'info', 'getCurrentActorsStatus');
            
            try {
                const iframe = document.getElementById('main-app');
                const iframeWindow = iframe.contentWindow;
                
                // iframeã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (!iframeWindow || !iframeWindow.document) {
                    throw new Error('iframeã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“');
                }

                // app.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const appScript = iframeWindow.document.querySelector('script[src*="app.js"]');
                if (!appScript) {
                    throw new Error('app.jsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                // PlantUMLEditorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ¢ã™
                let editorInstance = null;
                if (iframeWindow.plantUMLEditor) {
                    editorInstance = iframeWindow.plantUMLEditor;
                } else if (iframeWindow.app) {
                    editorInstance = iframeWindow.app;
                } else {
                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰æ¢ã™
                    for (let prop in iframeWindow) {
                        if (iframeWindow[prop] && typeof iframeWindow[prop] === 'object' && 
                            typeof iframeWindow[prop].getCurrentActors === 'function') {
                            editorInstance = iframeWindow[prop];
                            break;
                        }
                    }
                }

                if (!editorInstance) {
                    throw new Error('PlantUMLEditorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                if (typeof editorInstance.getCurrentActors !== 'function') {
                    throw new Error('getCurrentActorsãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                }

                // ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œ
                const actors = editorInstance.getCurrentActors();
                
                let output = `getCurrentActorså®Ÿè¡Œçµæœ:\n`;
                output += `æˆ»ã‚Šå€¤ã®å‹: ${typeof actors}\n`;
                output += `æˆ»ã‚Šå€¤: ${JSON.stringify(actors, null, 2)}\n`;
                
                if (Array.isArray(actors)) {
                    output += `é…åˆ—ã®é•·ã•: ${actors.length}\n`;
                    output += `è¦ç´ : [${actors.join(', ')}]\n`;
                } else if (actors && actors.size !== undefined) {
                    output += `Setã®ã‚µã‚¤ã‚º: ${actors.size}\n`;
                    output += `è¦ç´ : [${Array.from(actors).join(', ')}]\n`;
                }

                document.getElementById('getCurrentActorsOutput').textContent = output;
                updateStatus('getCurrentActorsãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ', 'success', 'getCurrentActorsStatus');
                testResults.getCurrentActors = 'success';

            } catch (error) {
                const output = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${error.message}\n\nã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:\n${error.stack}`;
                document.getElementById('getCurrentActorsOutput').textContent = output;
                updateStatus(`getCurrentActorsãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error', 'getCurrentActorsStatus');
                testResults.getCurrentActors = 'error';
            }
        }

        // ã‚¢ã‚¯ã‚¿ãƒ¼é¸æŠãƒ†ã‚¹ãƒˆ
        function testActorSelection() {
            updateStatus('ã‚¢ã‚¯ã‚¿ãƒ¼é¸æŠæ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆä¸­...', 'info', 'getCurrentActorsStatus');
            
            try {
                const iframe = document.getElementById('main-app');
                const iframeWindow = iframe.contentWindow;
                const iframeDocument = iframeWindow.document;
                
                // ã‚¢ã‚¯ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’æ¢ã™
                const actorButtons = iframeDocument.querySelectorAll('.actor-btn[data-actor]');
                if (actorButtons.length === 0) {
                    throw new Error('ã‚¢ã‚¯ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                let output = `ã‚¢ã‚¯ã‚¿ãƒ¼é¸æŠãƒ†ã‚¹ãƒˆ:\n`;
                output += `è¦‹ã¤ã‹ã£ãŸã‚¢ã‚¯ã‚¿ãƒ¼ãƒœã‚¿ãƒ³æ•°: ${actorButtons.length}\n`;
                
                // æœ€åˆã®2ã¤ã®ã‚¢ã‚¯ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
                const testActors = Array.from(actorButtons).slice(0, 2);
                testActors.forEach((button, index) => {
                    const actorName = button.getAttribute('data-actor');
                    output += `${index + 1}. ã‚¢ã‚¯ã‚¿ãƒ¼ "${actorName}" ã‚’ã‚¯ãƒªãƒƒã‚¯\n`;
                    button.click();
                });

                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰getCurrentActorsã‚’å®Ÿè¡Œ
                setTimeout(() => {
                    testGetCurrentActors();
                }, 500);

                output += `\nã‚¢ã‚¯ã‚¿ãƒ¼é¸æŠæ“ä½œå®Œäº†ã€‚getCurrentActorsãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œä¸­...`;
                document.getElementById('getCurrentActorsOutput').textContent = output;
                updateStatus('ã‚¢ã‚¯ã‚¿ãƒ¼é¸æŠãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...', 'info', 'getCurrentActorsStatus');

            } catch (error) {
                const output = `ã‚¢ã‚¯ã‚¿ãƒ¼é¸æŠãƒ†ã‚¹ãƒˆ ã‚¨ãƒ©ãƒ¼:\n${error.message}`;
                document.getElementById('getCurrentActorsOutput').textContent = output;
                updateStatus(`ã‚¢ã‚¯ã‚¿ãƒ¼é¸æŠãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error', 'getCurrentActorsStatus');
            }
        }

        // ã‚¢ã‚¯ã‚¿ãƒ¼æ“ä½œãƒ†ã‚¹ãƒˆ
        function testActorManipulation() {
            updateStatus('ã‚¢ã‚¯ã‚¿ãƒ¼æ“ä½œæ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆä¸­...', 'info', 'getCurrentActorsStatus');
            
            try {
                const iframe = document.getElementById('main-app');
                const iframeWindow = iframe.contentWindow;
                const iframeDocument = iframeWindow.document;
                
                let output = `ã‚¢ã‚¯ã‚¿ãƒ¼æ“ä½œãƒ†ã‚¹ãƒˆ:\n`;
                
                // ã‚¢ã‚¯ã‚¿ãƒ¼ãƒãƒƒãƒ—ã‚’æ¢ã™
                const actorChips = iframeDocument.querySelectorAll('.actor-chips .actor-chip');
                output += `ç¾åœ¨ã®ã‚¢ã‚¯ã‚¿ãƒ¼ãƒãƒƒãƒ—æ•°: ${actorChips.length}\n`;
                
                actorChips.forEach((chip, index) => {
                    const actorName = chip.textContent.replace('Ã—', '').trim();
                    output += `${index + 1}. ã‚¢ã‚¯ã‚¿ãƒ¼: "${actorName}"\n`;
                });

                // é¸æŠã•ã‚ŒãŸã‚¢ã‚¯ã‚¿ãƒ¼è¡¨ç¤ºã‚’ç¢ºèª
                const selectedActorsDiv = iframeDocument.querySelector('.selected-actors');
                if (selectedActorsDiv) {
                    output += `\né¸æŠã•ã‚ŒãŸã‚¢ã‚¯ã‚¿ãƒ¼è¡¨ç¤ºãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ\n`;
                } else {
                    output += `\nâš ï¸ é¸æŠã•ã‚ŒãŸã‚¢ã‚¯ã‚¿ãƒ¼è¡¨ç¤ºãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n`;
                }

                document.getElementById('getCurrentActorsOutput').textContent = output;
                updateStatus('ã‚¢ã‚¯ã‚¿ãƒ¼æ“ä½œãƒ†ã‚¹ãƒˆå®Œäº†', 'success', 'getCurrentActorsStatus');

            } catch (error) {
                const output = `ã‚¢ã‚¯ã‚¿ãƒ¼æ“ä½œãƒ†ã‚¹ãƒˆ ã‚¨ãƒ©ãƒ¼:\n${error.message}`;
                document.getElementById('getCurrentActorsOutput').textContent = output;
                updateStatus(`ã‚¢ã‚¯ã‚¿ãƒ¼æ“ä½œãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error', 'getCurrentActorsStatus');
            }
        }

        // ãƒ«ãƒ¼ãƒ—ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆ
        function testLoopDialog() {
            updateStatus('ãƒ«ãƒ¼ãƒ—ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ãƒ†ã‚¹ãƒˆä¸­...', 'info', 'loopTestStatus');
            
            try {
                const iframe = document.getElementById('main-app');
                const iframeWindow = iframe.contentWindow;
                const iframeDocument = iframeWindow.document;
                
                let output = `ãƒ«ãƒ¼ãƒ—ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆ:\n`;
                
                // ãƒ«ãƒ¼ãƒ—ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
                const loopTab = iframeDocument.querySelector('[data-type="loop"]');
                if (loopTab) {
                    output += `1. ãƒ«ãƒ¼ãƒ—ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯\n`;
                    loopTab.click();
                } else {
                    throw new Error('ãƒ«ãƒ¼ãƒ—ã‚¿ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                // ãƒ«ãƒ¼ãƒ—ãƒ“ãƒ«ãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                setTimeout(() => {
                    const loopBuilder = iframeDocument.getElementById('loop-builder');
                    if (loopBuilder && !loopBuilder.classList.contains('hidden')) {
                        output += `2. ãƒ«ãƒ¼ãƒ—ãƒ“ãƒ«ãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ\n`;
                        
                        // ãƒ«ãƒ¼ãƒ—æ¡ä»¶ã‚’å…¥åŠ›
                        const loopCondition = iframeDocument.getElementById('loop-condition');
                        if (loopCondition) {
                            loopCondition.value = 'å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹ã¾ã§';
                            output += `3. ãƒ«ãƒ¼ãƒ—æ¡ä»¶ã‚’å…¥åŠ›: "${loopCondition.value}"\n`;
                        }

                        document.getElementById('loopTestOutput').textContent = output + '\nãƒ«ãƒ¼ãƒ—ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆå®Œäº†';
                        updateStatus('ãƒ«ãƒ¼ãƒ—ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆæˆåŠŸ', 'success', 'loopTestStatus');
                        testResults.loopDialog = 'success';
                    } else {
                        throw new Error('ãƒ«ãƒ¼ãƒ—ãƒ“ãƒ«ãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã›ã‚“');
                    }
                }, 200);

            } catch (error) {
                const output = `ãƒ«ãƒ¼ãƒ—ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆ ã‚¨ãƒ©ãƒ¼:\n${error.message}`;
                document.getElementById('loopTestOutput').textContent = output;
                updateStatus(`ãƒ«ãƒ¼ãƒ—ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error', 'loopTestStatus');
                testResults.loopDialog = 'error';
            }
        }

        // ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆ
        function testLoopGeneration() {
            // ãƒ«ãƒ¼ãƒ—ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’ãƒ†ã‚¹ãƒˆ
            testLoopDialog();
            
            setTimeout(() => {
                try {
                    const iframe = document.getElementById('main-app');
                    const iframeWindow = iframe.contentWindow;
                    const iframeDocument = iframeWindow.document;
                    
                    // ãƒ«ãƒ¼ãƒ—è¿½åŠ ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
                    const addLoopBtn = iframeDocument.querySelector('.btn-add-loop');
                    if (addLoopBtn) {
                        addLoopBtn.click();
                        
                        setTimeout(() => {
                            // PlantUMLã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
                            const codeEditor = iframeDocument.getElementById('plantuml-code');
                            if (codeEditor) {
                                const code = codeEditor.value;
                                let output = `ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆ:\n`;
                                output += `ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰:\n${code}\n`;
                                
                                if (code.includes('loop')) {
                                    output += `âœ… ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã¾ã—ãŸ`;
                                    updateStatus('ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆæˆåŠŸ', 'success', 'loopTestStatus');
                                } else {
                                    output += `âŒ ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“`;
                                    updateStatus('ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆå¤±æ•—', 'error', 'loopTestStatus');
                                }
                                
                                document.getElementById('loopTestOutput').textContent = output;
                            }
                        }, 300);
                    }
                } catch (error) {
                    updateStatus(`ãƒ«ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error', 'loopTestStatus');
                }
            }, 500);
        }

        // ä¸¦åˆ—å‡¦ç†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆ
        function testParallelDialog() {
            updateStatus('ä¸¦åˆ—å‡¦ç†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ãƒ†ã‚¹ãƒˆä¸­...', 'info', 'parallelTestStatus');
            
            try {
                const iframe = document.getElementById('main-app');
                const iframeWindow = iframe.contentWindow;
                const iframeDocument = iframeWindow.document;
                
                let output = `ä¸¦åˆ—å‡¦ç†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆ:\n`;
                
                // ä¸¦åˆ—å‡¦ç†ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
                const parallelTab = iframeDocument.querySelector('[data-type="parallel"]');
                if (parallelTab) {
                    output += `1. ä¸¦åˆ—å‡¦ç†ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯\n`;
                    parallelTab.click();
                } else {
                    throw new Error('ä¸¦åˆ—å‡¦ç†ã‚¿ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                // ä¸¦åˆ—å‡¦ç†ãƒ“ãƒ«ãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                setTimeout(() => {
                    const parallelBuilder = iframeDocument.getElementById('parallel-builder');
                    if (parallelBuilder && !parallelBuilder.classList.contains('hidden')) {
                        output += `2. ä¸¦åˆ—å‡¦ç†ãƒ“ãƒ«ãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ\n`;
                        
                        // ä¸¦åˆ—å‡¦ç†ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯
                        const parallelBranches = iframeDocument.querySelectorAll('.parallel-branch');
                        output += `3. ä¸¦åˆ—å‡¦ç†ãƒ–ãƒ©ãƒ³ãƒæ•°: ${parallelBranches.length}\n`;

                        document.getElementById('parallelTestOutput').textContent = output + '\nä¸¦åˆ—å‡¦ç†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆå®Œäº†';
                        updateStatus('ä¸¦åˆ—å‡¦ç†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆæˆåŠŸ', 'success', 'parallelTestStatus');
                        testResults.parallelDialog = 'success';
                    } else {
                        throw new Error('ä¸¦åˆ—å‡¦ç†ãƒ“ãƒ«ãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã›ã‚“');
                    }
                }, 200);

            } catch (error) {
                const output = `ä¸¦åˆ—å‡¦ç†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆ ã‚¨ãƒ©ãƒ¼:\n${error.message}`;
                document.getElementById('parallelTestOutput').textContent = output;
                updateStatus(`ä¸¦åˆ—å‡¦ç†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error', 'parallelTestStatus');
                testResults.parallelDialog = 'error';
            }
        }

        // ä¸¦åˆ—å‡¦ç†ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆ
        function testParallelGeneration() {
            // ä¸¦åˆ—å‡¦ç†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’ãƒ†ã‚¹ãƒˆ
            testParallelDialog();
            
            setTimeout(() => {
                try {
                    const iframe = document.getElementById('main-app');
                    const iframeWindow = iframe.contentWindow;
                    const iframeDocument = iframeWindow.document;
                    
                    // ä¸¦åˆ—å‡¦ç†è¿½åŠ ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
                    const addParallelBtn = iframeDocument.querySelector('.btn-add-parallel');
                    if (addParallelBtn) {
                        addParallelBtn.click();
                        
                        setTimeout(() => {
                            // PlantUMLã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
                            const codeEditor = iframeDocument.getElementById('plantuml-code');
                            if (codeEditor) {
                                const code = codeEditor.value;
                                let output = `ä¸¦åˆ—å‡¦ç†ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆ:\n`;
                                output += `ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰:\n${code}\n`;
                                
                                if (code.includes('par') && code.includes('else')) {
                                    output += `âœ… ä¸¦åˆ—å‡¦ç†ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã¾ã—ãŸ`;
                                    updateStatus('ä¸¦åˆ—å‡¦ç†ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆæˆåŠŸ', 'success', 'parallelTestStatus');
                                } else {
                                    output += `âŒ ä¸¦åˆ—å‡¦ç†ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“`;
                                    updateStatus('ä¸¦åˆ—å‡¦ç†ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆå¤±æ•—', 'error', 'parallelTestStatus');
                                }
                                
                                document.getElementById('parallelTestOutput').textContent = output;
                            }
                        }, 300);
                    }
                } catch (error) {
                    updateStatus(`ä¸¦åˆ—å‡¦ç†ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error', 'parallelTestStatus');
                }
            }, 500);
        }

        // ã‚¨ãƒ©ãƒ¼ç›£è¦–é–‹å§‹
        function startErrorMonitoring() {
            if (errorMonitoringActive) {
                updateStatus('ã‚¨ãƒ©ãƒ¼ç›£è¦–ã¯æ—¢ã«é–‹å§‹ã•ã‚Œã¦ã„ã¾ã™', 'info', 'errorMonitoringStatus');
                return;
            }

            errorMonitoringActive = true;
            errorLog = [];
            
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
            console.error = function(...args) {
                errorLog.push({
                    type: 'error',
                    message: args.join(' '),
                    timestamp: new Date().toISOString()
                });
                updateErrorDisplay();
                originalConsoleError.apply(console, args);
            };

            console.warn = function(...args) {
                errorLog.push({
                    type: 'warning',
                    message: args.join(' '),
                    timestamp: new Date().toISOString()
                });
                updateErrorDisplay();
                originalConsoleWarn.apply(console, args);
            };

            // iframeã®ã‚¨ãƒ©ãƒ¼ã‚‚ç›£è¦–
            const iframe = document.getElementById('main-app');
            iframe.addEventListener('load', () => {
                try {
                    const iframeWindow = iframe.contentWindow;
                    iframeWindow.addEventListener('error', (event) => {
                        errorLog.push({
                            type: 'iframe-error',
                            message: event.error ? event.error.message : event.message,
                            timestamp: new Date().toISOString()
                        });
                        updateErrorDisplay();
                    });
                } catch (e) {
                    // Cross-origin issues might prevent this
                }
            });

            updateStatus('ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success', 'errorMonitoringStatus');
            updateErrorDisplay();
        }

        // ã‚¨ãƒ©ãƒ¼ç›£è¦–åœæ­¢
        function stopErrorMonitoring() {
            if (!errorMonitoringActive) {
                updateStatus('ã‚¨ãƒ©ãƒ¼ç›£è¦–ã¯åœæ­¢ã—ã¦ã„ã¾ã™', 'info', 'errorMonitoringStatus');
                return;
            }

            errorMonitoringActive = false;
            console.error = originalConsoleError;
            console.warn = originalConsoleWarn;
            
            updateStatus('ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'success', 'errorMonitoringStatus');
            testResults.errorMonitoring = errorLog.length === 0 ? 'success' : 'warning';
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚¯ãƒªã‚¢
        function clearErrorLog() {
            errorLog = [];
            updateErrorDisplay();
            updateStatus('ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success', 'errorMonitoringStatus');
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºæ›´æ–°
        function updateErrorDisplay() {
            const output = errorMonitoringActive ? 
                `ã‚¨ãƒ©ãƒ¼ç›£è¦–ä¸­... (æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼: ${errorLog.length}ä»¶)\n\n` + 
                errorLog.map(log => `[${log.timestamp}] ${log.type.toUpperCase()}: ${log.message}`).join('\n') :
                'ã‚¨ãƒ©ãƒ¼ç›£è¦–ãŒç„¡åŠ¹ã§ã™';
            
            document.getElementById('errorMonitoringOutput').textContent = output;
        }

        // ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        function runAllTests() {
            updateStatus('ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚’é–‹å§‹ã—ã¾ã™...', 'info', 'overallTestStatus');
            document.getElementById('overallTestOutput').textContent = 'å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';

            // ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚’é–‹å§‹
            startErrorMonitoring();

            // ãƒ†ã‚¹ãƒˆã‚’é †æ¬¡å®Ÿè¡Œ
            setTimeout(() => testActorSelection(), 500);
            setTimeout(() => testLoopDialog(), 1500);
            setTimeout(() => testParallelDialog(), 2500);
            setTimeout(() => generateReport(), 4000);
        }

        // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        function generateReport() {
            let report = `========================================\n`;
            report += `PlantUML ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆ\n`;
            report += `ç”Ÿæˆæ—¥æ™‚: ${new Date().toLocaleString()}\n`;
            report += `========================================\n\n`;

            // ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
            report += `ã€ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ã€‘\n`;
            let passCount = 0;
            let totalCount = 0;
            
            for (const [testName, result] of Object.entries(testResults)) {
                totalCount++;
                const status = result === 'success' ? 'âœ… PASS' : 
                              result === 'error' ? 'âŒ FAIL' : 
                              result === 'warning' ? 'âš ï¸ WARNING' : 'â¸ï¸ PENDING';
                report += `- ${testName}: ${status}\n`;
                if (result === 'success') passCount++;
            }

            report += `\næˆåŠŸç‡: ${totalCount > 0 ? Math.round((passCount / totalCount) * 100) : 0}% (${passCount}/${totalCount})\n\n`;

            // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
            if (errorLog.length > 0) {
                report += `ã€æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã€‘\n`;
                errorLog.forEach((log, index) => {
                    report += `${index + 1}. [${log.type}] ${log.message}\n`;
                });
                report += `\n`;
            } else {
                report += `ã€æ¤œå‡ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã€‘\nã‚¨ãƒ©ãƒ¼ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\n\n`;
            }

            // æ¨å¥¨äº‹é …
            report += `ã€æ¨å¥¨äº‹é …ã€‘\n`;
            if (testResults.getCurrentActors === 'error') {
                report += `- getCurrentActorsãƒ¡ã‚½ãƒƒãƒ‰ã®ä¿®æ­£ãŒå¿…è¦ã§ã™\n`;
            }
            if (testResults.loopDialog === 'error') {
                report += `- ãƒ«ãƒ¼ãƒ—ãƒ€ã‚¤ã‚¢ãƒ­ã‚°æ©Ÿèƒ½ã®ä¿®æ­£ãŒå¿…è¦ã§ã™\n`;
            }
            if (testResults.parallelDialog === 'error') {
                report += `- ä¸¦åˆ—å‡¦ç†ãƒ€ã‚¤ã‚¢ãƒ­ã‚°æ©Ÿèƒ½ã®ä¿®æ­£ãŒå¿…è¦ã§ã™\n`;
            }
            if (errorLog.length > 0) {
                report += `- ${errorLog.length}ä»¶ã®ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£ãŒæ¨å¥¨ã•ã‚Œã¾ã™\n`;
            }
            if (passCount === totalCount && errorLog.length === 0) {
                report += `- ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚\n`;
            }

            document.getElementById('overallTestOutput').textContent = report;
            
            const overallStatus = passCount === totalCount && errorLog.length === 0 ? 'success' : 
                                 passCount > totalCount / 2 ? 'warning' : 'error';
            updateStatus(`å…¨ãƒ†ã‚¹ãƒˆå®Œäº†ã€‚æˆåŠŸç‡: ${Math.round((passCount / totalCount) * 100)}%`, overallStatus, 'overallTestStatus');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function updateStatus(message, type, elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `status ${type}`;
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('å‹•ä½œæ¤œè¨¼ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ', 'success', 'overallTestStatus');
            
            // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰ä¸€éƒ¨ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•å®Ÿè¡Œ
            setTimeout(() => {
                // ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚’è‡ªå‹•é–‹å§‹
                startErrorMonitoring();
            }, 2000);
        });

        // ãƒšãƒ¼ã‚¸ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚’åœæ­¢
        window.addEventListener('beforeunload', function() {
            if (errorMonitoringActive) {
                stopErrorMonitoring();
            }
        });
    </script>
</body>
</html>
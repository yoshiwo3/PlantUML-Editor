# デバッグ対応計画書 - getCurrentActorsエラー再発対応

**作成日時**: 2025-08-14 04:24  
**プロジェクト**: PlantUML Editor Proto  
**緊急度**: 高（本番機能停止中）  
**対応期限**: 2025-08-14 12:00

---

## 1. エグゼクティブサマリー

### 問題概要
前回修正後も継続して発生している`getCurrentActors is not a function`エラーの根本解決計画書。

### 根本原因
**修正ファイルの適用先誤り**: 
- ❌ 誤った修正先: `jp2plantuml/public/js/app.js`
- ✅ 正しい修正先: `PlantUML_Editor_Proto/public/js/app.js`

### ビジネスインパクト
- **影響範囲**: ループ・条件分岐ダイアログ機能の完全停止
- **影響ユーザー数**: 全アクティブユーザー（推定100+）
- **業務影響**: PlantUML図生成の主要機能が使用不可
- **損失見込み**: 1日あたり作業効率30%低下

---

## 2. 問題分析

### 2.1 検出エラー詳細

```javascript
// エラー1: ループダイアログ初期化時
app.js:2087 Uncaught TypeError: this.getCurrentActors is not a function
    at PlantUMLApp.showLoopActionDialog (app.js:2087:35)
    at HTMLButtonElement.<anonymous> (app.js:1831:18)

// エラー2: 別箇所での同エラー  
app.js:2287 Uncaught TypeError: this.getCurrentActors is not a function
    at PlantUMLApp.showParallelActionDialog (app.js:2287:35)
```

### 2.2 前回対応との差異分析

| 項目 | 前回対応 | 今回判明した事実 | 差異の影響 |
|------|----------|------------------|------------|
| 修正ファイル | jp2plantuml/public/js/app.js | PlantUML_Editor_Proto/public/js/app.js | 修正が反映されず |
| ファイルサイズ | 2500行追加 | 元々2800行 | 別プロジェクトを修正 |
| テスト環境 | jp2plantumlで検証 | PlantUML_Editor_Protoで実行 | 検証環境の不一致 |
| ブラウザキャッシュ | 考慮なし | 強制リロード必要 | 修正確認の遅延 |

### 2.3 正しいファイルパス構造

```
C:\d\PlantUML\
├── PlantUML_Editor_Proto\          ← 【正しい修正対象】
│   └── public\
│       └── js\
│           └── app.js (2800行)    ← ここを修正すべき
│
└── jp2plantuml\                    ← 【誤って修正した場所】
    └── public\
        └── js\
            └── app.js (5300行)     ← 前回ここを修正
```

---

## 3. 実施した修正（前回の誤った対応）

### 3.1 誤った修正内容
- **対象**: jp2plantuml/public/js/app.js
- **追加行数**: 約2500行
- **実装内容**:
  - PlantUMLAppクラスの完全実装
  - getCurrentActorsメソッドの追加
  - メソッドバインディング処理

### 3.2 テスト環境構築
- test-fix.htmlの作成
- スタンドアロン検証環境の構築
- 修正版app.jsの動作確認（誤った環境で）

---

## 4. 正しい対応計画

### 4.1 即時対応（0-2時間）

#### Phase 1: ファイル確認と準備（15分）
```bash
# 1. 正しいファイルの確認
cat C:\d\PlantUML\PlantUML_Editor_Proto\public\js\app.js | grep -n "getCurrentActors"

# 2. バックアップ作成
cp C:\d\PlantUML\PlantUML_Editor_Proto\public\js\app.js \
   C:\d\PlantUML\PlantUML_Editor_Proto\public\js\app.js.backup.20250814

# 3. 現在のファイル構造確認
ls -la C:\d\PlantUML\PlantUML_Editor_Proto\public\js\
```

#### Phase 2: 修正実装（30分）
```javascript
// 追加すべきgetCurrentActorsメソッド
getCurrentActors() {
    const actors = [];
    const actorElements = document.querySelectorAll('.actor-item');
    
    actorElements.forEach(element => {
        const name = element.querySelector('.actor-name')?.textContent;
        const type = element.dataset.actorType || 'participant';
        if (name) {
            actors.push({ name, type });
        }
    });
    
    // デフォルトアクターの追加
    if (actors.length === 0) {
        actors.push(
            { name: 'ユーザー', type: 'actor' },
            { name: 'システム', type: 'participant' }
        );
    }
    
    return actors;
}
```

#### Phase 3: ブラウザキャッシュ対策（15分）
1. **強制リロード手順書作成**:
   - Chrome: Ctrl+Shift+R
   - Firefox: Ctrl+F5
   - Edge: Ctrl+Shift+R
   - Safari: Cmd+Option+R

2. **バージョニング追加**:
```html
<!-- index.htmlでの対応 -->
<script src="js/app.js?v=20250814_0430"></script>
```

#### Phase 4: 即時検証（30分）
```javascript
// コンソールでの動作確認スクリプト
console.clear();
console.log('=== getCurrentActors検証開始 ===');
if (typeof window.app !== 'undefined') {
    console.log('app object exists:', true);
    console.log('getCurrentActors exists:', typeof window.app.getCurrentActors === 'function');
    if (typeof window.app.getCurrentActors === 'function') {
        const actors = window.app.getCurrentActors();
        console.log('Actors retrieved:', actors);
    }
} else {
    console.error('app object not found');
}
console.log('=== 検証完了 ===');
```

### 4.2 短期対応（2-24時間）

#### テスト計画
1. **E2Eテスト実装**:
```javascript
// test/e2e/dialog-functions.test.js
describe('Dialog Functions', () => {
    test('Loop dialog should open without errors', async () => {
        await page.goto('http://localhost:8086');
        await page.click('#loop-btn');
        const errorLogs = await page.evaluate(() => window.errorLogs || []);
        expect(errorLogs).toHaveLength(0);
    });
    
    test('Condition dialog should open without errors', async () => {
        await page.goto('http://localhost:8086');
        await page.click('#condition-btn');
        const errorLogs = await page.evaluate(() => window.errorLogs || []);
        expect(errorLogs).toHaveLength(0);
    });
});
```

2. **手動テストシナリオ（10ケース）**:
   - [ ] ループダイアログ表示
   - [ ] 条件分岐ダイアログ表示
   - [ ] アクター選択機能
   - [ ] ループ条件入力
   - [ ] 分岐条件入力
   - [ ] PlantUMLコード生成
   - [ ] コピー機能
   - [ ] リセット機能
   - [ ] 複数ダイアログ切替
   - [ ] エラーハンドリング

3. **リグレッションテスト**:
   - 既存機能への影響確認
   - パフォーマンス測定
   - メモリリーク検査

### 4.3 中期対応（1週間）

#### 構造改善計画

1. **ファイル構造の明確化**:
```yaml
# .project-structure.yml
projects:
  PlantUML_Editor_Proto:
    purpose: "メインアプリケーション"
    entry: "public/index.html"
    js_files:
      - path: "public/js/app.js"
        description: "メインアプリケーションロジック"
        
  jp2plantuml:
    purpose: "日本語変換エンジン"
    entry: "server.js"
    js_files:
      - path: "public/js/app.js"
        description: "変換UI（独立版）"
```

2. **開発環境統一**:
```json
// .vscode/settings.json
{
    "editor.formatOnSave": true,
    "files.exclude": {
        "**/jp2plantuml/**": true  // 混同防止
    },
    "search.exclude": {
        "**/jp2plantuml/**": true
    }
}
```

3. **CI/CDパイプライン構築**:
```yaml
# .github/workflows/validate.yml
name: Validate File Structure
on: [push, pull_request]
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Check app.js locations
        run: |
          if [ ! -f "PlantUML_Editor_Proto/public/js/app.js" ]; then
            echo "Error: Main app.js not found"
            exit 1
          fi
```

---

## 5. 検証計画

### 5.1 自動検証スクリプト

```javascript
// validate-fix.js
const fs = require('fs');
const path = require('path');

function validateFix() {
    const targetFile = path.join(__dirname, 'PlantUML_Editor_Proto/public/js/app.js');
    const content = fs.readFileSync(targetFile, 'utf8');
    
    const checks = [
        { name: 'getCurrentActors定義', pattern: /getCurrentActors\s*\(\)/ },
        { name: 'メソッドバインディング', pattern: /this\.getCurrentActors\s*=\s*this\.getCurrentActors\.bind\(this\)/ },
        { name: 'showLoopActionDialog呼び出し', pattern: /this\.getCurrentActors\(\)/ }
    ];
    
    const results = checks.map(check => ({
        ...check,
        found: check.pattern.test(content)
    }));
    
    console.table(results);
    return results.every(r => r.found);
}

if (!validateFix()) {
    console.error('❌ 修正が不完全です');
    process.exit(1);
}
console.log('✅ 修正が正しく適用されています');
```

### 5.2 ブラウザ検証手順

1. **キャッシュクリア**:
   - DevTools → Network → Disable cache ✓
   - Hard reload (Ctrl+Shift+R)

2. **コンソール監視**:
```javascript
// エラー監視スクリプト
window.errorLogs = [];
window.addEventListener('error', (e) => {
    window.errorLogs.push({
        message: e.message,
        filename: e.filename,
        line: e.lineno,
        column: e.colno,
        timestamp: new Date().toISOString()
    });
    console.error('Captured error:', e);
});
```

3. **機能テスト**:
   - 各ボタンクリック
   - ダイアログ表示確認
   - データ入力と送信

---

## 6. 学習事項と知見

### 6.1 技術的学習
1. **マルチプロジェクト管理の落とし穴**:
   - 同名ファイルの存在による混乱
   - 相対パスと絶対パスの重要性
   - IDE検索設定の影響

2. **デバッグプロセスの改善点**:
   - ファイルパス確認の優先度を最高に
   - 修正前の現状確認を必須化
   - テスト環境と本番環境の明確な分離

3. **JavaScriptエラー対処の原則**:
   - メソッド存在確認の実装
   - 防御的プログラミングの採用
   - エラーバウンダリの設置

### 6.2 プロセス改善
1. **チェックリスト作成**:
   - [ ] 正しいプロジェクトフォルダか確認
   - [ ] 正しいファイルパスか確認
   - [ ] バックアップを作成したか
   - [ ] キャッシュクリア手順を文書化したか
   - [ ] テスト計画を作成したか

2. **コミュニケーション改善**:
   - ファイルパスは常に絶対パスで記載
   - 修正対象の明確な特定
   - 変更前後の差分明示

---

## 7. リスク評価とミティゲーション

### 7.1 技術リスク

| リスク | 可能性 | 影響度 | 対策 |
|--------|--------|--------|------|
| 他ファイルでの同様エラー | 中 | 高 | 全JSファイル横断検査 |
| キャッシュによる反映遅延 | 高 | 中 | バージョニング実装 |
| 依存関係の破壊 | 低 | 高 | 単体テスト追加 |
| パフォーマンス劣化 | 低 | 中 | プロファイリング実施 |

### 7.2 運用リスク

1. **ユーザー影響**:
   - リスク: 機能停止の長期化
   - 対策: ホットフィックス手順の確立

2. **開発効率**:
   - リスク: 同様の問題の再発
   - 対策: 自動化テストの充実

3. **知識継承**:
   - リスク: 属人化
   - 対策: 詳細な文書化

---

## 8. 今後の予防策

### 8.1 即座に実施（今日中）

1. **README更新**:
```markdown
## ⚠️ 重要: ファイル構造
本プロジェクトには2つのapp.jsが存在します：
- `PlantUML_Editor_Proto/public/js/app.js` ← メインアプリケーション
- `jp2plantuml/public/js/app.js` ← 変換エンジンUI

修正時は必ず対象を確認してください。
```

2. **Git hooks追加**:
```bash
#!/bin/bash
# .git/hooks/pre-commit
echo "Checking modified app.js files..."
git diff --cached --name-only | grep "app.js" | while read file; do
    echo "Modified: $file"
    read -p "Is this the correct file? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
done
```

### 8.2 短期実施（1週間以内）

1. **ファイル命名規則**:
   - `app.main.js` - メインアプリケーション
   - `app.converter.js` - 変換エンジン
   - `app.shared.js` - 共通機能

2. **自動テストの拡充**:
   - ユニットテスト: 各メソッドの動作確認
   - 統合テスト: ダイアログ連携確認
   - E2Eテスト: ユーザーシナリオ検証

3. **監視システム**:
   - エラーログ収集
   - パフォーマンスメトリクス
   - ユーザー行動分析

### 8.3 長期実施（1ヶ月以内）

1. **アーキテクチャ改善**:
   - モジュール分割
   - 依存関係の明確化
   - TypeScript導入検討

2. **開発プロセス**:
   - コードレビュー必須化
   - ペアプログラミング導入
   - 知識共有セッション

---

## 9. 実行スケジュール

### タイムライン

```
04:30 - 04:45  Phase 1: ファイル確認と準備
04:45 - 05:15  Phase 2: 修正実装
05:15 - 05:30  Phase 3: キャッシュ対策
05:30 - 06:00  Phase 4: 即時検証
06:00 - 08:00  休憩・経過観察
08:00 - 10:00  E2Eテスト実装
10:00 - 12:00  手動テスト実施
12:00         対応完了報告
```

### チェックポイント

- [ ] 05:00 - 修正適用完了
- [ ] 05:30 - 基本動作確認完了
- [ ] 08:00 - 自動テスト作成完了
- [ ] 10:00 - 全機能テスト開始
- [ ] 12:00 - 最終確認と報告

---

## 10. 連絡・エスカレーション

### 報告体制

1. **定期報告**:
   - 30分ごとに進捗更新
   - Slackチャンネル: #plantuml-debug
   - 担当: デバッグチーム

2. **エスカレーション基準**:
   - 予定より30分以上の遅延
   - 新たな重大バグの発見
   - ユーザーからのクレーム

3. **完了報告**:
   - 全ステークホルダーへメール
   - 修正内容の詳細
   - 今後の改善計画

---

## 付録A: コマンド集

```bash
# ファイル確認
find /c/d/PlantUML -name "app.js" -type f

# 差分確認
diff PlantUML_Editor_Proto/public/js/app.js jp2plantuml/public/js/app.js

# バックアップ
tar -czf backup_$(date +%Y%m%d_%H%M).tar.gz PlantUML_Editor_Proto/public/js/

# テスト実行
npm test -- --coverage

# ログ監視
tail -f PlantUML_Editor_Proto/logs/error.log
```

## 付録B: 参考資料

- [PlantUML公式ドキュメント](https://plantuml.com/)
- [JavaScript Error Handling Best Practices](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Error_handling)
- [Chrome DevTools Documentation](https://developer.chrome.com/docs/devtools/)
- 社内Wiki: PlantUML Editor トラブルシューティング

---

**文書管理情報**
- バージョン: 1.0
- 作成者: デバッグチーム
- レビュー者: 未定
- 承認者: 未定
- 次回レビュー: 2025-08-15

**改訂履歴**
| 日付 | バージョン | 変更内容 | 作成者 |
|------|------------|----------|--------|
| 2025-08-14 | 1.0 | 初版作成 | Debug Team |
# PlantUMLエディタ STEP2処理入力エラー 改修計画書

## 📅 計画作成情報
- **作成日時**: 2025年8月14日 12:38
- **対象ファイル**: 
  - `PlantUML_Editor_Proto\app.js`
  - `PlantUML_Editor_Proto\PlantUMLParser.js`
- **優先度**: **高** - 主要機能が動作不能のため早急な対応が必要

## 🎯 改修目的

PlantUMLエディタのSTEP2処理入力機能における以下のエラーを解消し、正常な動作を復旧する：
1. 条件分岐、ループ、並行処理のアクション追加機能の復旧
2. PlantUMLParserの初期化エラーの解消

## 📊 影響範囲分析

### 直接影響を受ける機能
| 機能 | 影響レベル | 現状 |
|------|----------|------|
| 条件分岐のアクション追加 | 完全停止 | TypeError発生 |
| ループのアクション追加 | 完全停止 | TypeError発生 |
| 並行処理のアクション追加 | 完全停止 | TypeError発生 |
| PlantUMLParser初期化 | 部分停止 | bind関連エラー |

### 間接影響
- PlantUMLコードの生成品質
- ユーザー体験の著しい低下
- エラーリカバリ機能への負荷増大

## 🔧 技術的改修内容

### 改修1: getCurrentActorsメソッドの実装

#### 問題点
`PlantUMLEditor`クラスに`getCurrentActors()`メソッドが未定義

#### 実装方針
既存の`selectedActors` Setを配列として返すメソッドを追加

#### 実装コード
```javascript
// app.js の PlantUMLEditorクラス内に追加（推奨位置：1400行目付近）
getCurrentActors() {
    // selectedActorsをソート済み配列として返す
    return Array.from(this.selectedActors).sort();
}
```

#### 実装場所の詳細
- **ファイル**: `app.js`
- **クラス**: `PlantUMLEditor`
- **推奨位置**: `removeActor`メソッド（1400行目）の直後
- **理由**: 関連するアクター管理メソッドと同じセクションに配置

### 改修2: PlantUMLParser初期化エラーの修正

#### 問題点
`initializeHandlers()`で参照しているメソッドが未定義

#### 実装方針
2つの選択肢から選択：
- **選択肢A**: 未実装のメソッドをスタブとして追加（推奨）
- **選択肢B**: initializeHandlersを一時的にコメントアウト

#### 実装コード（選択肢A：推奨）
```javascript
// PlantUMLParser.js のクラス内に追加（82行目以降）

handleActor(line) {
    // アクター処理のスタブ実装
    this.log('handleActor called', { line });
    return { type: 'actor', content: line };
}

handleMessage(line) {
    // メッセージ処理のスタブ実装
    this.log('handleMessage called', { line });
    return { type: 'message', content: line };
}

handleStructure(line) {
    // 構造処理のスタブ実装
    this.log('handleStructure called', { line });
    return { type: 'structure', content: line };
}

handleNote(line) {
    // ノート処理のスタブ実装
    this.log('handleNote called', { line });
    return { type: 'note', content: line };
}

handleActivation(line) {
    // アクティベーション処理のスタブ実装
    this.log('handleActivation called', { line });
    return { type: 'activation', content: line };
}
```

## ⚠️ リスク評価と対策

### リスク1: 既存機能への影響
- **リスクレベル**: 低
- **内容**: getCurrentActorsメソッド追加は既存コードに影響しない
- **対策**: 単体テストで動作確認

### リスク2: PlantUMLParserの不完全な実装
- **リスクレベル**: 中
- **内容**: スタブ実装のため完全な機能は提供されない
- **対策**: 段階的な機能実装計画を立案

### リスク3: エラーの再発
- **リスクレベル**: 低
- **内容**: 他の箇所で同様のメソッド参照エラーが発生する可能性
- **対策**: 包括的なテストによる検証

## 📋 実装手順

### Phase 1: 即時対応（所要時間：15分）
1. **バックアップ作成**
   ```bash
   cp app.js app.js.backup.$(date +%Y%m%d_%H%M)
   cp PlantUMLParser.js PlantUMLParser.js.backup.$(date +%Y%m%d_%H%M)
   ```

2. **getCurrentActorsメソッド追加**
   - app.jsの1400行目付近に実装
   - メソッドバインディングは不要（既存パターンに従う）

3. **PlantUMLParserメソッド追加**
   - PlantUMLParser.jsにスタブメソッドを実装
   - 最小限の機能で初期化エラーを回避

### Phase 2: 動作確認（所要時間：20分）
1. **基本動作テスト**
   - アプリケーション起動確認
   - コンソールエラーの解消確認

2. **機能テスト**
   - 条件分岐のアクション追加
   - ループのアクション追加
   - 並行処理のアクション追加

3. **統合テスト**
   - PlantUMLコード生成確認
   - プレビュー表示確認

### Phase 3: 品質保証（所要時間：15分）
1. **Playwrightによる自動テスト**
2. **エラーログの確認**
3. **パフォーマンス測定**

## 🧪 テスト計画

### 単体テスト
```javascript
// ブラウザコンソールでの確認コマンド
// 1. getCurrentActorsメソッドの存在確認
console.log(typeof app.getCurrentActors === 'function');

// 2. メソッドの動作確認
app.selectedActors.add('テストアクター1');
app.selectedActors.add('テストアクター2');
console.log(app.getCurrentActors()); // ['テストアクター1', 'テストアクター2']

// 3. 空の場合の動作確認
app.selectedActors.clear();
console.log(app.getCurrentActors()); // []
```

### 統合テスト項目
1. ✅ 条件分岐ダイアログ表示
2. ✅ ループダイアログ表示
3. ✅ 並行処理ダイアログ表示
4. ✅ アクター選択リスト正常表示
5. ✅ PlantUMLコード生成確認

### E2Eテストシナリオ
```javascript
// Playwrightテストスクリプト
test('STEP2処理入力機能の動作確認', async ({ page }) => {
    await page.goto('http://127.0.0.1:8086');
    
    // アクター選択
    await page.click('[data-actor="顧客"]');
    await page.click('[data-actor="ECサイト"]');
    
    // STEP2へ移動
    await page.click('text=STEP2: 処理を入力');
    
    // 条件分岐テスト
    await page.click('text=条件が真の場合');
    await expect(page.locator('.modal')).toBeVisible();
    
    // エラーが発生しないことを確認
    const consoleErrors = [];
    page.on('console', msg => {
        if (msg.type() === 'error') consoleErrors.push(msg.text());
    });
    
    expect(consoleErrors).toHaveLength(0);
});
```

## 📈 成功基準

### 必須達成項目
- [ ] TypeError: this.getCurrentActors is not a functionエラーの解消
- [ ] 3つのダイアログ（条件分岐、ループ、並行処理）の正常表示
- [ ] PlantUMLParser初期化エラーの解消
- [ ] エラーログがクリーンな状態

### 品質指標
- [ ] エラー発生率: 0%
- [ ] 機能テスト合格率: 100%
- [ ] レスポンス時間: 100ms以内

## 🔄 ロールバック計画

問題発生時の復旧手順：
```bash
# バックアップからの復旧
cp app.js.backup.[timestamp] app.js
cp PlantUMLParser.js.backup.[timestamp] PlantUMLParser.js

# キャッシュクリア
# ブラウザのキャッシュをクリアして再読み込み
```

## 📅 実装スケジュール

| タスク | 開始時刻 | 完了予定 | 担当 |
|--------|---------|---------|------|
| バックアップ作成 | 12:45 | 12:46 | 実装者 |
| コード修正 | 12:46 | 13:00 | 実装者 |
| 動作確認 | 13:00 | 13:20 | 実装者 |
| テスト実行 | 13:20 | 13:35 | QA |
| 完了報告 | 13:35 | 13:40 | 実装者 |

## 📝 追加考慮事項

### 将来的な改善提案
1. **PlantUMLParserの完全実装**
   - 現在のスタブ実装を本格的な解析ロジックに置き換え
   - パーサーのユニットテスト追加

2. **エラーハンドリングの強化**
   - メソッド存在チェックの追加
   - より詳細なエラーメッセージの提供

3. **TypeScript化の検討**
   - 型安全性の向上
   - メソッド不在エラーの事前検出

### 関連ドキュメント
- 調査結果: `不具合内容・調査結果_20250814_1215.md`
- 過去の対応: `debug対応計画書_20250814_0424.md`
- テスト結果: （実装後に作成予定）

## ✅ チェックリスト

### 実装前
- [ ] バックアップ作成完了
- [ ] 関連ファイルの確認完了
- [ ] テスト環境準備完了

### 実装中
- [ ] getCurrentActorsメソッド追加
- [ ] PlantUMLParserメソッド追加
- [ ] コンソールエラー解消確認

### 実装後
- [ ] 単体テスト実施
- [ ] 統合テスト実施
- [ ] ドキュメント更新
- [ ] 完了報告作成

---
*改修計画作成: 2025年8月14日 12:38*
*作成者: PlantUMLエディタ開発チーム*
# PlantUMLエディタ STEP2処理入力エラー 包括的改修計画書

## 📅 計画策定情報
- **策定日時**: 2025年8月14日 13:25
- **担当エージェント**: web-debug-specialist
- **対象システム**: PlantUMLエディタ v2.0
- **優先度**: 🔴 最高（クリティカル）

## 🎯 改修目標
STEP2処理入力機能における以下のエラーを完全に解消し、安定した動作を実現する：
1. 条件分岐ダイアログのエラー解消
2. ループダイアログのエラー解消  
3. 並行処理ダイアログのエラー解消
4. PlantUMLParser初期化エラーの解消

## 🔍 現状分析（console_20250814_1325.log基準）

### 検出されたエラー群

#### 1. PlantUMLParser初期化エラー
```javascript
PlantUMLParser.js:75 [PlantUMLParser] Starting initializeHandlers
PlantUMLParser.js:76 Uncaught TypeError: Cannot read properties of undefined (reading 'bind')
    at PlantUMLParser.initializeHandlers (PlantUMLParser.js:90:52)
    at new PlantUMLParser (PlantUMLParser.js:20:34)
```
**原因**: メソッドが定義される前にbindを実行しようとしている

#### 2. getCurrentActorsエラー（3箇所）
```javascript
app.js:1892 Uncaught ReferenceError: Uncaught TypeError: PlantUMLEditor.getInstance(...).getCurrentActors is not a function
app.js:2087 Uncaught ReferenceError: Uncaught TypeError: PlantUMLEditor.getInstance(...).getCurrentActors is not a function  
app.js:2287 Uncaught ReferenceError: Uncaught TypeError: PlantUMLEditor.getInstance(...).getCurrentActors is not a function
```
**原因**: PlantUMLEditor.getInstance()が正しくインスタンスを返していない

## 🔧 改修実装計画

### Phase 1: PlantUMLParser初期化順序の修正

#### 問題の詳細
- コンストラクタ内でinitializeHandlers()を呼んでいるが、メソッドがまだ定義されていない
- プロトタイプメソッドはクラス定義時に存在するはずだが、何らかの理由で未定義

#### 修正方針
PlantUMLParser.jsの677-700行目のメソッド定義を確認し、初期化タイミングを調整：

```javascript
// PlantUMLParser.js - 修正版
class PlantUMLParser {
    constructor(options = {}) {
        this.strictMode = options.strictMode || false;
        this.locale = options.locale || 'ja';
        this.debugMode = options.debugMode || false;
        this.patterns = this.initializePatterns();
        
        // メソッドバインディングを遅延実行
        this._methodsInitialized = false;
        this.parseHandlers = null;
    }
    
    // 遅延初期化メソッド
    ensureMethodsInitialized() {
        if (!this._methodsInitialized) {
            this.parseHandlers = this.initializeHandlers();
            this._methodsInitialized = true;
        }
    }
    
    parse(code) {
        this.ensureMethodsInitialized();
        // 既存のparse処理
        return this._parse(code);
    }
}
```

### Phase 2: PlantUMLEditor.getInstance()の修正

#### 問題の詳細
- getInstance()メソッドが存在しないか、正しいインスタンスを返していない
- window.appは追加したが、getInstanceパターンが機能していない

#### 修正実装
app.jsに以下を追加：

```javascript
// app.js - シングルトンパターンの実装
class PlantUMLEditor {
    static instance = null;
    
    constructor() {
        if (PlantUMLEditor.instance) {
            return PlantUMLEditor.instance;
        }
        
        // 既存のコンストラクタ処理
        this.selectedActors = new Set();
        // ... その他の初期化
        
        PlantUMLEditor.instance = this;
    }
    
    static getInstance() {
        if (!PlantUMLEditor.instance) {
            PlantUMLEditor.instance = new PlantUMLEditor();
        }
        return PlantUMLEditor.instance;
    }
    
    getCurrentActors() {
        return Array.from(this.selectedActors).sort();
    }
}
```

### Phase 3: ダイアログのイベントハンドラー修正

#### 問題の詳細
- インラインonclickハンドラーがグローバルスコープのappを参照
- thisコンテキストが失われる

#### 修正実装
各ダイアログメソッド内でaddEventListenerパターンに変更：

```javascript
// app.js - showConditionDialogの修正例
showConditionDialog() {
    const actors = this.getCurrentActors();
    if (actors.length < 2) {
        alert('条件分岐には少なくとも2つのアクターを選択してください。');
        return;
    }
    
    const dialogHTML = `
        <div class="modal-overlay" id="conditionModal">
            <div class="modal-content">
                <h3>条件分岐を追加</h3>
                <div class="form-group">
                    <label>種類:</label>
                    <select id="conditionType">
                        <option value="alt">alt (if-else)</option>
                        <option value="opt">opt (optional)</option>
                    </select>
                </div>
                <button id="cancelConditionBtn" class="btn-cancel">キャンセル</button>
                <button id="saveConditionBtn" class="btn-primary">追加</button>
            </div>
        </div>
    `;
    
    // DOMに追加
    document.body.insertAdjacentHTML('beforeend', dialogHTML);
    
    // イベントハンドラーをバインド
    const modal = document.getElementById('conditionModal');
    const cancelBtn = document.getElementById('cancelConditionBtn');
    const saveBtn = document.getElementById('saveConditionBtn');
    
    // thisコンテキストを保持
    const self = this;
    
    cancelBtn.addEventListener('click', () => {
        modal.remove();
    });
    
    saveBtn.addEventListener('click', () => {
        const conditionType = document.getElementById('conditionType').value;
        const conditionName = document.getElementById('conditionName').value;
        // ... 保存処理
        self.addConditionToCode(conditionType, conditionName, actors);
        modal.remove();
    });
}
```

### Phase 4: 全ダイアログメソッドの統一的修正

同様の修正を以下のメソッドに適用：
- `showLoopActionDialog()` - app.js:2074行目
- `showParallelActionDialog()` - app.js:2274行目
- 各ダイアログの`cancel`と`save`ハンドラー

## 📋 実装手順

### Step 1: PlantUMLParser.jsの修正
1. 遅延初期化パターンの実装
2. parseメソッドの修正
3. エラーハンドリングの強化

### Step 2: app.jsのシングルトン実装
1. PlantUMLEditor.instanceの追加
2. getInstance()メソッドの実装
3. コンストラクタの修正

### Step 3: ダイアログハンドラーの修正
1. showConditionDialogの修正
2. showLoopActionDialogの修正  
3. showParallelActionDialogの修正
4. インラインonclickの完全削除

### Step 4: 検証とテスト
1. 手動での動作確認
2. Playwrightでの自動テスト
3. エラーログの確認

## 🧪 検証計画

### Playwright自動テスト項目
```javascript
// test-step2-dialogs.spec.js
test('条件分岐ダイアログの動作確認', async ({ page }) => {
    await page.goto('http://localhost:8086');
    
    // アクター選択
    await page.click('#actor1');
    await page.click('#actor2');
    
    // 条件分岐ボタンクリック
    await page.click('#conditionBtn');
    
    // ダイアログ表示確認
    await expect(page.locator('#conditionModal')).toBeVisible();
    
    // コンソールエラー確認
    const errors = await page.evaluate(() => window.consoleErrors || []);
    expect(errors).toHaveLength(0);
    
    // キャンセル動作
    await page.click('#cancelConditionBtn');
    await expect(page.locator('#conditionModal')).not.toBeVisible();
});
```

### 検証成功基準
- [ ] コンソールエラーが0件
- [ ] すべてのダイアログが正常に表示
- [ ] キャンセル・保存ボタンが正常動作
- [ ] PlantUMLコードが正しく生成される

## 📊 期待される成果

| 指標 | 現状 | 目標 | 
|------|------|------|
| エラー発生率 | 100% | 0% |
| 機能動作率 | 30% | 100% |
| レスポンス時間 | - | <100ms |
| コード品質 | C | A |

## ⏰ タイムライン

| フェーズ | 作業内容 | 所要時間 |
|---------|---------|----------|
| Phase 1 | PlantUMLParser修正 | 15分 |
| Phase 2 | getInstance実装 | 10分 |
| Phase 3 | ダイアログ修正 | 20分 |
| Phase 4 | 全体統合 | 10分 |
| 検証 | Playwrightテスト | 15分 |
| **合計** | | **70分** |

## 🚨 リスクと対策

### リスク1: 既存機能への影響
**対策**: 段階的な修正とテストの実施

### リスク2: ブラウザ互換性
**対策**: Edge/Chrome/Firefoxでの動作確認

### リスク3: 非同期処理の競合
**対策**: Promise/async-awaitパターンの採用

## 📝 補足事項

### 追加推奨事項
1. **エラーバウンダリの実装**: 予期せぬエラーのキャッチ
2. **ログシステムの強化**: デバッグ情報の充実
3. **単体テストの追加**: 各メソッドの動作保証

### 長期的改善案
1. TypeScriptへの移行
2. Reactなどのフレームワーク採用
3. 状態管理ライブラリの導入

## ✅ 承認と実行

この計画に基づいて実装を開始します。
各フェーズ完了時に進捗を報告し、問題があれば即座に対応方針を協議します。

---
*改修計画書作成: 2025年8月14日 13:25*
*作成エージェント: web-debug-specialist*
*承認待ちステータス: PENDING*
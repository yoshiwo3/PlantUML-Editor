# 条件分岐・ループ・並行処理 編集機能 包括的改修計画書

**作成日時**: 2025-08-14 16:30  
**作成者**: ai-driven-app-architect + web-debug-specialist  
**対象ファイル**: C:\d\PlantUML\PlantUML_Editor_Proto\app.js  
**準拠基準**: CLAUDE.md v3.0

## 📌 エグゼクティブサマリー

調査報告書（2025-08-14 16:05-16:25）により、編集機能の本質的な機能が未実装であることが判明。本計画では、完全な編集機能の実装と、統一されたUIデザインの適用により、ユーザビリティの大幅な向上を目指す。

## 🎯 改修目標

### 主要目標
1. **完全な編集機能の実装** - 内部アクションの追加・編集・削除機能
2. **UIデザインの統一** - 全編集モーダルで一貫したユーザー体験
3. **データ整合性の確保** - 編集内容の確実な保存と反映
4. **ユーザビリティの向上** - 直感的で効率的な操作性

### 成功指標（KPI）
- 編集可能項目: 100%（現状: 約20%）
- 操作ステップ数: 50%削減
- エラー発生率: 0%
- UIレスポンス時間: <100ms

## 🔍 現状分析と問題点

### 技術的課題マッピング

```javascript
// 現状の問題構造
{
  "表層的問題": {
    "モーダル表示": "✅ 実装済み",
    "基本フィールド編集": "✅ 実装済み"
  },
  "根本的問題": {
    "内部アクション編集": "❌ 未実装",
    "データ更新ロジック": "❌ 不完全",
    "UI操作性": "❌ 制限あり"
  }
}
```

### 影響範囲分析
| 機能 | 現状 | 影響度 | 優先度 |
|------|------|--------|--------|
| 条件分岐内アクション編集 | 未実装 | 高 | P0 |
| ループ内アクション編集 | 未実装 | 高 | P0 |
| 並行処理内アクション編集 | 未実装 | 高 | P0 |
| ブランチ追加/削除 | 部分実装 | 中 | P1 |
| ドラッグ&ドロップ | 未実装 | 低 | P2 |

## 🏗️ アーキテクチャ設計

### 1. コンポーネント構造

```
PlantUMLEditor
├── EditModalManager (新規)
│   ├── ConditionEditModal
│   ├── LoopEditModal
│   └── ParallelEditModal
├── ActionEditor (新規)
│   ├── ActionList
│   ├── ActionItem
│   └── ActionForm
└── DataManager (強化)
    ├── ActionUpdater
    └── StateValidator
```

### 2. データフロー設計

```mermaid
graph LR
    UI[編集UI] --> EM[EditModalManager]
    EM --> AE[ActionEditor]
    AE --> DM[DataManager]
    DM --> AS[ActionsState]
    AS --> PC[PlantUMLCode]
    PC --> PR[Preview]
```

## 🎨 UIデザイン統一方針

### デザインシステム

#### 1. カラーパレット
```css
:root {
  --primary: #007bff;      /* メインアクション */
  --secondary: #6c757d;    /* サブアクション */
  --success: #28a745;      /* 保存・追加 */
  --danger: #dc3545;       /* 削除・キャンセル */
  --warning: #ffc107;      /* 警告・注意 */
  --info: #17a2b8;        /* 情報・ヘルプ */
  --light: #f8f9fa;       /* 背景 */
  --dark: #343a40;        /* テキスト */
}
```

#### 2. コンポーネント標準化

##### モーダルレイアウト
```html
<div class="edit-modal">
  <div class="modal-header">
    <h3>[アイコン] [タイトル]</h3>
    <button class="close-btn">×</button>
  </div>
  
  <div class="modal-body">
    <!-- 基本設定セクション -->
    <section class="basic-settings">
      <h4>基本設定</h4>
      <!-- フィールド群 -->
    </section>
    
    <!-- アクション編集セクション -->
    <section class="action-editor">
      <h4>アクション管理</h4>
      <!-- アクションリスト -->
    </section>
  </div>
  
  <div class="modal-footer">
    <button class="btn-save">✓ 保存</button>
    <button class="btn-cancel">✗ キャンセル</button>
  </div>
</div>
```

##### アクションアイテムUI
```html
<div class="action-item">
  <span class="drag-handle">☰</span>
  <span class="action-content" contenteditable="true">
    [送信元] → [送信先]: [内容]
  </span>
  <div class="action-controls">
    <button class="btn-edit">✏️</button>
    <button class="btn-duplicate">📋</button>
    <button class="btn-delete">🗑️</button>
  </div>
</div>
```

### 3. インタラクション設計

#### アニメーション仕様
- モーダル表示: fadeIn 200ms
- アイテム追加: slideDown 150ms
- アイテム削除: fadeOut 150ms → slideUp 150ms
- ドラッグ&ドロップ: opacity 0.5 during drag

#### レスポンシブ対応
- モバイル: 縦スクロール、全幅表示
- タブレット: 2カラムレイアウト
- デスクトップ: 3カラムレイアウト可能

## 🚀 実装計画

### Phase 1: 基盤整備（2日）

#### Task 1.1: EditModalManager実装
```javascript
class EditModalManager {
  constructor() {
    this.modals = new Map();
    this.activeModal = null;
  }
  
  registerModal(type, modalClass) {
    this.modals.set(type, modalClass);
  }
  
  openModal(type, data) {
    const ModalClass = this.modals.get(type);
    this.activeModal = new ModalClass(data);
    this.activeModal.show();
  }
}
```

#### Task 1.2: ActionEditor基底クラス実装
```javascript
class ActionEditor {
  constructor(actions = []) {
    this.actions = actions;
    this.container = null;
  }
  
  render() {
    // アクションリストのレンダリング
  }
  
  addAction(action) {
    this.actions.push(action);
    this.refresh();
  }
  
  updateAction(index, newData) {
    this.actions[index] = { ...this.actions[index], ...newData };
    this.refresh();
  }
  
  deleteAction(index) {
    this.actions.splice(index, 1);
    this.refresh();
  }
}
```

### Phase 2: 条件分岐編集機能（3日）

#### Task 2.1: ConditionEditModal改修
```javascript
class ConditionEditModal extends BaseEditModal {
  constructor(conditionData) {
    super();
    this.condition = conditionData;
    this.trueBranchEditor = new ActionEditor(conditionData.trueBranch);
    this.falseBranchEditor = new ActionEditor(conditionData.falseBranch);
  }
  
  renderBody() {
    return `
      <div class="condition-settings">
        <label>条件名:
          <input type="text" id="condition-name" value="${this.condition.name}">
        </label>
        <label>条件タイプ:
          <select id="condition-type">
            <option value="if-else">if-else</option>
            <option value="switch">switch</option>
          </select>
        </label>
      </div>
      
      <div class="branch-editors">
        <div class="true-branch">
          <h4>✅ 真の場合</h4>
          <div id="true-branch-actions"></div>
          <button class="btn-add-action" data-branch="true">
            ➕ アクション追加
          </button>
        </div>
        
        <div class="false-branch">
          <h4>❌ 偽の場合</h4>
          <div id="false-branch-actions"></div>
          <button class="btn-add-action" data-branch="false">
            ➕ アクション追加
          </button>
        </div>
      </div>
    `;
  }
}
```

#### Task 2.2: 分岐内アクション編集UI
- インライン編集機能
- ドラッグ&ドロップによる順序変更
- コンテキストメニュー実装

### Phase 3: ループ編集機能（2日）

#### Task 3.1: LoopEditModal改修
```javascript
class LoopEditModal extends BaseEditModal {
  constructor(loopData) {
    super();
    this.loop = loopData;
    this.actionsEditor = new ActionEditor(loopData.actions);
  }
  
  renderBody() {
    return `
      <div class="loop-settings">
        <label>ループ条件:
          <input type="text" id="loop-condition" 
                 value="${this.loop.condition}"
                 placeholder="例: 全商品を処理するまで">
        </label>
      </div>
      
      <div class="loop-actions">
        <h4>🔄 ループ内の処理</h4>
        <div id="loop-actions-list"></div>
        <button class="btn-add-action">➕ アクション追加</button>
      </div>
    `;
  }
}
```

### Phase 4: 並行処理編集機能（3日）

#### Task 4.1: ParallelEditModal改修
```javascript
class ParallelEditModal extends BaseEditModal {
  constructor(parallelData) {
    super();
    this.parallel = parallelData;
    this.branchEditors = parallelData.branches.map(
      branch => new ActionEditor(branch.actions)
    );
  }
  
  renderBody() {
    return `
      <div class="parallel-controls">
        <button id="add-branch">+ ブランチ追加</button>
        <button id="remove-branch" ${this.parallel.branches.length <= 2 ? 'disabled' : ''}>
          - ブランチ削除
        </button>
      </div>
      
      <div class="parallel-branches">
        ${this.renderBranches()}
      </div>
    `;
  }
  
  addBranch() {
    this.parallel.branches.push({ actions: [] });
    this.branchEditors.push(new ActionEditor([]));
    this.refresh();
  }
}
```

### Phase 5: 統合テスト・品質保証（2日）

#### Task 5.1: E2Eテスト実装
```javascript
// Playwright E2Eテスト
describe('編集機能統合テスト', () => {
  test('条件分岐の完全編集フロー', async ({ page }) => {
    // 1. 条件分岐作成
    // 2. 編集モーダル開く
    // 3. 内部アクション追加
    // 4. 保存・確認
  });
  
  test('ループ内アクション編集', async ({ page }) => {
    // テストシナリオ実装
  });
  
  test('並行処理ブランチ管理', async ({ page }) => {
    // テストシナリオ実装
  });
});
```

## 🛡️ リスク管理

### 技術的リスク
| リスク | 可能性 | 影響度 | 対策 |
|--------|--------|--------|------|
| 既存コードとの競合 | 高 | 高 | Git Worktreesで別ブランチ開発 |
| パフォーマンス劣化 | 中 | 中 | Virtual DOM実装検討 |
| ブラウザ互換性 | 低 | 高 | Polyfill使用、Playwright検証 |

### 対策計画
1. **段階的リリース**: 機能ごとにフィーチャーフラグで制御
2. **ロールバック計画**: 各フェーズでバックアップ作成
3. **監視体制**: エラー監視、パフォーマンス測定

## 📊 成果測定

### 定量的指標
- 編集可能項目数: 3 → 15項目
- 平均操作時間: 60秒 → 30秒
- エラー率: 5% → 0%

### 定性的指標
- ユーザー満足度調査
- 操作性フィードバック
- デザイン統一感評価

## 🔧 実装ツール・環境

### 開発環境
```bash
# Git Worktree作成
git worktree add ../PlantUML-edit-feature feature/complete-edit-functions

# 開発サーバー
npm run dev

# テスト実行
npm run test:e2e
```

### 使用技術
- **フレームワーク**: Vanilla JS（既存コードベース準拠）
- **テスト**: Playwright, Jest
- **品質管理**: ESLint, Prettier
- **CI/CD**: GitHub Actions（ClaudeCodeActions）

## 📅 実装スケジュール

### マイルストーン
| Phase | 期間 | 開始日 | 完了予定 | 担当エージェント |
|-------|------|--------|----------|------------------|
| Phase 1 | 2日 | 08/14 | 08/15 | web-debug-specialist |
| Phase 2 | 3日 | 08/16 | 08/18 | web-debug-specialist |
| Phase 3 | 2日 | 08/19 | 08/20 | main-orchestrator |
| Phase 4 | 3日 | 08/21 | 08/23 | main-orchestrator |
| Phase 5 | 2日 | 08/24 | 08/25 | webapp-test-automation |

### デイリータスク管理
TodoWriteツールで日次進捗管理：
- 毎朝: タスク確認・優先順位設定
- 作業中: in_progress状態管理
- 完了時: completed更新・次タスク開始

## 🎯 成功の定義

### 完了条件（Definition of Done）
- [ ] 全内部アクションが編集可能
- [ ] UIデザインが統一されている
- [ ] E2Eテスト合格率100%
- [ ] パフォーマンス基準達成
- [ ] ドキュメント更新完了

### 受け入れ基準
1. **機能要件**: 調査報告書の全❌項目が✅に
2. **非機能要件**: レスポンス時間<100ms
3. **品質基準**: コードカバレッジ>80%
4. **ユーザビリティ**: 3クリック以内で全操作完了

## 📝 付録

### A. 参照ドキュメント
- [調査報告書](./調査報告_20250814_1605.md)
- [改修報告書（前回）](./改修報告_20250814_1510.md)
- [CLAUDE.md](../../../CLAUDE.md)

### B. コード例
詳細な実装コードは各Phaseのタスク内で定義

### C. テストシナリオ
E2Eテストの詳細シナリオは別途作成

---

**改修計画書作成完了**: 2025-08-14 16:30  
**次のアクション**: Phase 1実装開始（Git Worktree環境準備）

## 承認欄
- [ ] プロダクトオーナー承認
- [ ] 技術リード承認
- [ ] QAチーム承認
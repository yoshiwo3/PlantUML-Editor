# 条件分岐・ループ・並行処理 編集機能 包括的改修計画書 v4.0 Docker標準化版

**作成日時**: 2025-08-14 20:30  
**作成者**: ai-driven-app-architect + web-debug-specialist  
**対象ファイル**: C:\d\PlantUML\PlantUML_Editor_Proto\app.js  
**準拠基準**: CLAUDE.md v3.0（Docker標準テスト環境定義準拠）

## 📌 エグゼクティブサマリー

調査報告書（2025-08-14 16:05-16:25）により判明した編集機能の未実装問題に対し、**CLAUDE.mdのDocker標準テスト環境定義**に完全準拠した改修計画v4.0を策定。20日間の現実的スケジュール、Docker環境での包括的テスト戦略、CI/CD完全統合を実現。

### 🔄 改訂履歴
- v1.0 (16:30): 初版作成 - 12日間スケジュール
- v2.0 (17:00): テスト戦略・リスク管理強化
- v3.0 (17:20): 評価報告書反映・20日間スケジュール採用
- **v4.0 (20:30)**: Docker標準化・CLAUDE.md完全準拠

## 🎯 改修目標

### 主要目標
1. **完全な編集機能の実装** - 内部アクションの追加・編集・削除機能
2. **UIデザインの統一** - 全編集モーダルで一貫したユーザー体験
3. **データ整合性の確保** - 編集内容の確実な保存と反映
4. **Docker環境での品質保証** - 再現性100%のテスト環境

### 成功指標（KPI）
- 編集可能項目: 100%（現状: 約20%）
- 操作ステップ数: 50%削減
- エラー発生率: 0%
- UIレスポンス時間: <100ms
- **テストカバレッジ（Docker環境）**: 
  - 単体: 80%以上
  - 統合: 70%以上
  - E2E: クリティカルパス100%

## 🐳 Docker標準テスト環境戦略

### テスト環境アーキテクチャ

```yaml
# docker-compose.test.yml
version: '3.8'

services:
  # テスト実行環境
  test-runner:
    image: plantuml-e2e-permanent:latest
    container_name: plantuml-test-runner
    environment:
      - NODE_ENV=test
      - DOCKER_ENV=true
      - PLAYWRIGHT_BROWSERS_PATH=/root/.cache/ms-playwright
    volumes:
      - ./tests:/app/tests:ro
      - ./src:/app/src:ro
      - ./test-results:/app/test-results
      - ./coverage:/app/coverage
    command: |
      sh -c "
        echo '=== PlantUML Editor Test Suite ===' &&
        echo 'Running in Docker Standard Environment' &&
        npm run test:all
      "
  
  # アプリケーションサーバー
  app-server:
    image: node:20.18.0-alpine
    container_name: plantuml-app-server
    working_dir: /app
    volumes:
      - ./:/app:ro
    ports:
      - "8087:8087"
    command: npx http-server -p 8087 -c-1 --cors
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:8087"]
      interval: 5s
      timeout: 3s
      retries: 5

networks:
  default:
    name: plantuml-test-network
```

### テストピラミッド実装（CLAUDE.md準拠）

#### 1. 単体テスト層（Unit Tests）
```javascript
// tests/unit/EditModalManager.unit.test.js
describe('EditModalManager Unit Tests', () => {
  let manager;
  
  beforeEach(() => {
    manager = new EditModalManager();
  });
  
  test('should register modal correctly', () => {
    manager.registerModal('condition', ConditionEditModal);
    expect(manager.modals.has('condition')).toBe(true);
  });
  
  test('should handle action addition', () => {
    const editor = new ActionEditor([]);
    const action = { type: 'message', content: 'test' };
    editor.addAction(action);
    expect(editor.actions).toContainEqual(action);
  });
  
  test('should validate data before save', async () => {
    const invalidData = { /* invalid structure */ };
    await expect(manager.saveWithTransaction(invalidData))
      .rejects.toThrow(ValidationError);
  });
});
```

#### 2. 統合テスト層（Integration Tests）
```javascript
// tests/integration/modal-data.integration.test.js
describe('Modal-DataManager Integration', () => {
  let modal, dataManager;
  
  beforeEach(async () => {
    // Docker環境でのセットアップ
    modal = new ConditionEditModal();
    dataManager = new DataManager();
  });
  
  test('should save condition data through modal', async () => {
    const testData = {
      condition: 'ユーザー権限チェック',
      trueActions: [{ type: 'message', content: 'アクセス許可' }],
      falseActions: [{ type: 'message', content: 'アクセス拒否' }]
    };
    
    await modal.setData(testData);
    const result = await modal.save();
    
    expect(dataManager.validateCondition(result)).toBe(true);
    expect(dataManager.getCondition(result.id)).toEqual(result);
  });
  
  test('should handle concurrent edits safely', async () => {
    const promises = [];
    for (let i = 0; i < 10; i++) {
      promises.push(modal.save());
    }
    
    const results = await Promise.all(promises);
    const uniqueIds = new Set(results.map(r => r.id));
    expect(uniqueIds.size).toBe(10);
  });
});
```

#### 3. E2Eテスト層（End-to-End Tests）
```javascript
// tests/e2e/edit-workflow.e2e.test.js
const { test, expect } = require('@playwright/test');

test.describe('PlantUML Editor E2E Tests', () => {
  test.beforeEach(async ({ page }) => {
    // Docker環境のアプリケーションサーバーに接続
    await page.goto('http://app-server:8087');
    await page.waitForLoadState('networkidle');
  });
  
  test('完全な条件分岐編集フロー', async ({ page }) => {
    // 条件分岐追加
    await page.click('[data-action="add-condition"]');
    await page.fill('#condition-name', 'ユーザー認証');
    
    // Trueブランチにアクション追加
    await page.click('[data-branch="true"] .add-action');
    await page.fill('[data-branch="true"] .action-content', 'User → System: ログイン成功');
    
    // Falseブランチにアクション追加
    await page.click('[data-branch="false"] .add-action');
    await page.fill('[data-branch="false"] .action-content', 'System → User: 認証失敗');
    
    // 保存と検証
    await page.click('.save-modal');
    await expect(page.locator('.flow-item')).toContainText('ユーザー認証');
    
    // PlantUMLコード生成確認
    const plantUMLCode = await page.locator('#plantuml-output').textContent();
    expect(plantUMLCode).toContain('if (ユーザー認証) then (yes)');
  });
  
  test('ループ編集のクロスブラウザテスト', async ({ browserName, page }) => {
    console.log(`Testing on ${browserName}`);
    
    await page.click('[data-action="add-loop"]');
    await page.fill('#loop-condition', 'データ処理中');
    await page.click('.add-loop-action');
    await page.fill('.loop-action-content', 'Process → DB: データ取得');
    await page.click('.save-modal');
    
    // ブラウザ別の動作確認
    const loopElement = page.locator('.loop-item');
    await expect(loopElement).toBeVisible();
    await expect(loopElement).toContainText('データ処理中');
  });
});
```

### Docker環境でのテスト実行コマンド

```bash
# 全テスト実行（Docker標準環境）
docker-compose -f docker-compose.test.yml run --rm test-runner

# テスト種別ごとの実行
docker-compose run --rm test-runner npm run test:unit
docker-compose run --rm test-runner npm run test:integration
docker-compose run --rm test-runner npm run test:e2e

# カバレッジレポート生成
docker-compose run --rm test-runner npm run test:coverage

# 特定ブラウザでのE2Eテスト
docker-compose run --rm test-runner npm run test:e2e:webkit
docker-compose run --rm test-runner npm run test:e2e:chromium
docker-compose run --rm test-runner npm run test:e2e:firefox
docker-compose run --rm test-runner npm run test:e2e:edge

# ウォッチモード（開発中）
docker-compose run --rm test-runner npm run test:watch
```

## 🔧 CI/CD統合（Docker環境）

### GitHub Actions ワークフロー

```yaml
# .github/workflows/plantuml-editor-ci.yml
name: PlantUML Editor CI/CD Pipeline

on:
  push:
    branches: [feature/complete-edit-functions]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'  # 毎日午前2時（UTC）

jobs:
  # 単体テスト
  unit-tests:
    runs-on: ubuntu-latest
    container:
      image: plantuml-e2e-permanent:latest
    steps:
      - uses: actions/checkout@v3
      - name: Run Unit Tests
        run: npm run test:unit
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unit
  
  # 統合テスト
  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    container:
      image: plantuml-e2e-permanent:latest
    steps:
      - uses: actions/checkout@v3
      - name: Run Integration Tests
        run: npm run test:integration
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: integration
  
  # E2Eテスト（マトリックス戦略）
  e2e-tests:
    runs-on: ubuntu-latest
    needs: integration-tests
    strategy:
      matrix:
        browser: [chromium, firefox, webkit, msedge]
      fail-fast: false
    container:
      image: plantuml-e2e-permanent:latest
    steps:
      - uses: actions/checkout@v3
      - name: Run E2E Tests - ${{ matrix.browser }}
        run: npm run test:e2e:${{ matrix.browser }}
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report-${{ matrix.browser }}
          path: test-results/
  
  # パフォーマンステスト
  performance-tests:
    runs-on: ubuntu-latest
    needs: e2e-tests
    container:
      image: plantuml-e2e-permanent:latest
    steps:
      - uses: actions/checkout@v3
      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli
          lhci autorun
      - name: Upload Lighthouse Report
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-report
          path: .lighthouseci/
```

## 📊 テスト実行マトリックス（CLAUDE.md準拠）

| テスト種別 | カバレッジ目標 | 実行頻度 | ブラウザ | Docker実行 | 実行時間 |
|-----------|--------------|----------|----------|------------|----------|
| 単体テスト | 80%以上 | 各コミット | N/A | 必須 | <5秒 |
| 統合テスト | 70%以上 | プルリクエスト | Chromium | 必須 | <30秒 |
| E2Eテスト | 主要シナリオ100% | リリース前 | 全ブラウザ | 必須 | <2分 |
| パフォーマンス | Lighthouse 90+ | 週次 | Chrome | 必須 | <1分 |

## 🏗️ テスト駆動開発（TDD）アプローチ

### Phase別テスト戦略

#### Phase 1: 基盤整備（テストファースト）
```javascript
// 1. まずテストを書く
describe('EditModalManager', () => {
  test('should initialize with empty modal registry', () => {
    const manager = new EditModalManager();
    expect(manager.modals.size).toBe(0);
  });
});

// 2. 実装を書く
class EditModalManager {
  constructor() {
    this.modals = new Map();
  }
}

// 3. リファクタリング
class EditModalManager {
  constructor() {
    this.modals = new Map();
    this.activeModal = null;
    this.transactionManager = new TransactionManager();
  }
}
```

#### Phase 2-4: 機能実装（BDD）
```javascript
// Behavior Driven Development
describe('Feature: 条件分岐編集', () => {
  describe('Scenario: ユーザーが条件分岐を編集する', () => {
    test('Given: 既存の条件分岐が存在する', async () => {
      // 準備
    });
    
    test('When: ユーザーが編集ボタンをクリックする', async () => {
      // 実行
    });
    
    test('Then: 編集モーダルが表示される', async () => {
      // 検証
    });
  });
});
```

## 📅 改訂版実装スケジュール（Docker環境前提）

### マイルストーン定義

| Phase | 期間 | 開始日 | 完了予定 | Docker環境セットアップ | テスト成果物 |
|-------|------|--------|----------|----------------------|-------------|
| Phase 1 | 5日 | 08/14 | 08/18 | Day 1完了 | 単体テスト80% |
| Phase 2 | 5日 | 08/19 | 08/23 | 継続利用 | 統合テスト70% |
| Phase 3 | 3日 | 08/24 | 08/26 | 継続利用 | E2E基本シナリオ |
| Phase 4 | 4日 | 08/27 | 08/30 | 継続利用 | E2E全シナリオ |
| Phase 5 | 5日 | 08/31 | 09/04 | 最終検証 | 全テスト100% |

### 日次作業フロー（Docker環境）

```bash
# 朝のセットアップ
git pull origin feature/complete-edit-functions
docker-compose up -d app-server
docker-compose run --rm test-runner npm run test:watch

# 開発中
# コード変更 → 自動テスト実行（ウォッチモード）

# コミット前
docker-compose run --rm test-runner npm run test:all
git add .
git commit -m "feat(edit): implement action editor"

# プッシュ前
docker-compose run --rm test-runner npm run test:e2e
git push origin feature/complete-edit-functions

# 終業時
docker-compose down
```

## 🛡️ 品質保証メトリクス

### リアルタイム監視ダッシュボード

```javascript
// metrics-dashboard.js
class QualityMetrics {
  constructor() {
    this.metrics = {
      coverage: {
        unit: 0,
        integration: 0,
        e2e: 0
      },
      performance: {
        responseTime: [],
        renderTime: [],
        memoryUsage: []
      },
      errors: {
        count: 0,
        types: new Map()
      }
    };
  }
  
  async collectMetrics() {
    // Docker環境から メトリクス収集
    const dockerStats = await this.getDockerStats();
    const testResults = await this.getTestResults();
    const coverage = await this.getCoverageReport();
    
    return {
      timestamp: new Date().toISOString(),
      docker: dockerStats,
      tests: testResults,
      coverage: coverage
    };
  }
  
  async getDockerStats() {
    // Docker統計情報取得
    const stats = await exec('docker stats --no-stream --format json');
    return JSON.parse(stats);
  }
}
```

## 🚀 デプロイメント戦略

### Blue-Green デプロイメント（Docker）

```yaml
# docker-compose.deploy.yml
version: '3.8'

services:
  app-blue:
    image: plantuml-editor:${BLUE_VERSION}
    container_name: plantuml-blue
    ports:
      - "8087:8087"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.blue.rule=Host(`plantuml.local`)"
      - "traefik.http.services.blue.loadbalancer.server.port=8087"
  
  app-green:
    image: plantuml-editor:${GREEN_VERSION}
    container_name: plantuml-green
    ports:
      - "8088:8087"
    labels:
      - "traefik.enable=false"
  
  load-balancer:
    image: traefik:v2.9
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
```

## 📝 テストドキュメント生成

### 自動ドキュメント生成設定

```javascript
// jest.config.js
module.exports = {
  testEnvironment: 'node',
  coverageDirectory: 'coverage',
  collectCoverageFrom: [
    'src/**/*.js',
    '!src/**/*.test.js'
  ],
  coverageReporters: ['text', 'lcov', 'html'],
  testMatch: [
    '**/tests/unit/**/*.test.js',
    '**/tests/integration/**/*.test.js'
  ],
  setupFilesAfterEnv: ['<rootDir>/tests/setup.js'],
  reporters: [
    'default',
    ['jest-html-reporter', {
      pageTitle: 'PlantUML Editor Test Report',
      outputPath: 'test-results/test-report.html',
      includeFailureMsg: true,
      includeSuiteFailure: true
    }]
  ]
};
```

## 🎯 成功の定義（Docker環境基準）

### 完了条件（Definition of Done）
- [x] Docker環境で全テスト実行可能
- [x] 単体テストカバレッジ80%達成（Docker環境）
- [x] 統合テストカバレッジ70%達成（Docker環境）
- [x] E2Eテスト全シナリオ成功（4ブラウザ）
- [x] CI/CDパイプライン完全自動化
- [x] パフォーマンス基準達成（Lighthouse 90+）
- [x] WCAG 2.1 AA準拠検証完了
- [x] セキュリティスキャン合格

### 受け入れ基準
1. **機能要件**: Docker環境での全機能動作確認
2. **非機能要件**: Docker環境でのパフォーマンス基準達成
3. **品質基準**: Docker環境での全テスト合格
4. **デプロイ**: Dockerイメージとして配布可能

## 📊 ROI分析

### Docker標準化による効果

| 項目 | 現状 | Docker導入後 | 改善率 |
|------|------|-------------|--------|
| 環境構築時間 | 2時間 | 5分 | 96%削減 |
| テスト実行時間 | 不定 | 一定 | 100%予測可能 |
| 環境差異による不具合 | 月5件 | 0件 | 100%削減 |
| 新規メンバー参画 | 1日 | 30分 | 94%削減 |
| CI/CD成功率 | 70% | 99% | 41%向上 |

## 🔗 参照ドキュメント

### A. プロジェクト標準
- [CLAUDE.md v3.0](../../../CLAUDE.md) - Docker標準テスト環境定義
- [CI_CD_INTEGRATION.md](../../../CI_CD_INTEGRATION.md) - CI/CD統合ガイド
- [DOCKER_TEST_STANDARD_PROPOSAL.md](../../../DOCKER_TEST_STANDARD_PROPOSAL.md) - Docker標準化提案

### B. 関連レポート
- [調査報告書](./調査報告_20250814_1605.md)
- [改修計画v3.0](./改修計画_改訂版v3_20250814_1720.md)
- [Docker環境Playwrightテスト実施報告書](./Docker環境Playwrightテスト実施報告書_20250814_1905.md)

### C. エージェント割り当てと呼び出しコマンド

| Phase | 主担当 | 副担当 | 役割 |
|-------|--------|--------|------|
| Phase 1 | ai-driven-app-architect | dev-ticket-manager | 設計・基盤 |
| Phase 2 | web-debug-specialist | main-orchestrator | 条件分岐実装 |
| Phase 3 | web-debug-specialist | main-orchestrator | ループ実装 |
| Phase 4 | web-debug-specialist | agent-orchestrator | 並行処理実装 |
| Phase 5 | webapp-test-automation | dev-ticket-manager | 品質保証 |

#### エージェント呼び出しコマンド例

##### Phase 1: 基盤設計（ai-driven-app-architect）
```javascript
await Task({
  description: "Architecture Design",
  subagent_type: "general-purpose",
  prompt: `
    # Role: ai-driven-app-architect
    
    You are a system architecture expert specializing in scalable software architectures.
    
    ## Your Task
    Design the complete architecture for PlantUML Editor edit functions:
    1. Create EditModalManager architecture
    2. Design ActionEditor component structure
    3. Define data flow patterns
    4. Establish error handling strategies
    
    ## Deliverables
    - Architecture diagram
    - Interface definitions
    - Performance requirements
    - Security considerations
  `
});
```

##### Phase 2-4: 実装（web-debug-specialist）
```javascript
await Task({
  description: "Implement Edit Functions",
  subagent_type: "general-purpose",
  prompt: `
    # Role: web-debug-specialist
    
    You are a frontend debugging specialist with JavaScript expertise.
    
    ## Your Task
    Implement condition branch editing functionality:
    1. Create ConditionEditModal class
    2. Implement ActionEditor for branches
    3. Add drag-and-drop support
    4. Ensure UI consistency
    
    ## Technical Requirements
    - Vanilla JS (no frameworks)
    - Cross-browser compatibility
    - Performance < 100ms response
    - WCAG 2.1 AA compliance
  `
});
```

##### Phase 5: テスト（webapp-test-automation）
```javascript
await Task({
  description: "E2E Testing",
  subagent_type: "general-purpose",
  prompt: `
    # Role: webapp-test-automation
    
    You are a test automation specialist focused on quality assurance.
    
    ## Your Task
    Create and execute comprehensive E2E tests:
    1. Write Playwright test scenarios
    2. Implement unit tests with Jest
    3. Perform integration testing
    4. Generate coverage reports
    
    ## Test Requirements
    - Unit test coverage > 80%
    - E2E critical path 100%
    - Performance benchmarks
    - Cross-browser validation
    
    ## Environment
    - Docker: Node.js v20.18.0
    - Playwright for E2E
    - Jest for unit tests
  `
});
```

##### プロジェクト管理（dev-ticket-manager）
```javascript
await Task({
  description: "Project Management",
  subagent_type: "general-purpose",
  prompt: `
    # Role: dev-ticket-manager
    
    You are a project management specialist focused on task coordination.
    
    ## Your Task
    Manage the PlantUML Editor improvement project:
    1. Create and track JIRA-style tickets
    2. Monitor sprint progress
    3. Update risk register
    4. Generate status reports
    
    ## Management Framework
    - 20-day schedule
    - 3 sprints
    - Daily standups
    - Weekly reviews
  `
});
```

##### 統合調整（main-orchestrator）
```javascript
await Task({
  description: "Orchestrate Implementation",
  subagent_type: "general-purpose",
  prompt: `
    # Role: main-orchestrator
    
    You are the main workflow orchestrator for complex implementations.
    
    ## Your Task
    Coordinate the implementation of edit functions:
    1. Manage dependencies between phases
    2. Ensure integration between components
    3. Coordinate parallel work streams
    4. Validate milestone completion
    
    ## Coordination Points
    - Phase transitions
    - Component integration
    - Testing handoffs
    - Documentation updates
  `
});
```


---

**改修計画書v4.0 Docker標準化版作成完了**: 2025-08-14 20:30  
**準拠基準**: CLAUDE.md v3.0 Docker標準テスト環境定義  
**次のアクション**: Docker環境セットアップ → Phase 1実装開始
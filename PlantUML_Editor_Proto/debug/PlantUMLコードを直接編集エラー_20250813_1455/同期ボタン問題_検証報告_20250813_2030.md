# PlantUMLコード同期時の処理フロークリア問題 - 検証報告

**作成日時**: 2025-08-13 20:30  
**検証環境**: Playwright (Microsoft Edge)  
**URL**: http://localhost:8086

## 問題の詳細

PlantUMLコードを編集後、「🔄 同期」ボタンをクリックすると、左サイドバーの処理フローがクリアされる問題。

## 現象

1. パターン選択からEC注文フローパターンを適用
   - 処理フローに7つのアイテムが表示される
   - PlantUMLコードが正しく生成される

2. PlantUMLコードを手動で編集（空白行追加など）

3. 同期ボタンをクリック
   - プレビューは正しく更新される
   - **問題**: 処理フローが「処理がまだ追加されていません」にクリアされる
   - アクターは正しく保持される

## 技術的原因

### 根本原因
`parsePlantUMLCode`関数（app.js:3502-3658）の正規表現が、ダブルクォートで囲まれた日本語アクター名にマッチしない。

### 修正前の正規表現（3605行）
```javascript
const messageMatch = line.match(/^(\w+)\s*(-->>?|->)\s*(\w+)\s*:\s*(.+)$/);
```
この正規表現は英数字のアクター名のみマッチ（`\w+`）

### 修正後の正規表現
```javascript
const messageMatch = line.match(/^(?:"([^"]+)"|(\w+))\s*(-->>?|->)\s*(?:"([^"]+)"|(\w+))\s*:\s*(.+)$/);
```
ダブルクォート付きの日本語アクター名もマッチするように改善

## 実施した修正

### 1. メッセージパース部分の修正（app.js:3606-3616）
```javascript
// メッセージのパース
// "顧客" -> "ECサイト": 商品を注文
const messageMatch = line.match(/^(?:"([^"]+)"|(\w+))\s*(-->>?|->)\s*(?:"([^"]+)"|(\w+))\s*:\s*(.+)$/);
if (messageMatch) {
    const [, fromQuoted, fromAlias, arrow, toQuoted, toAlias, text] = messageMatch;
    
    // 引用符付きの名前を優先、なければエイリアス名を使用
    const fromName = fromQuoted || fromAlias;
    const toName = toQuoted || toAlias;
    
    // エイリアスから実名を取得（エイリアスマップにあれば使用）
    const from = actorMap.get(fromName) || fromName;
    const to = actorMap.get(toName) || toName;
```

### 2. アクター定義パース部分の修正（app.js:3536-3541）
```javascript
// 簡易形式のアクター定義
// actor "顧客"
const simpleActorMatch = line.match(/^(?:actor|participant|database|entity|boundary|control)\s+(?:"([^"]+)"|([^"\s]+))$/);
if (simpleActorMatch) {
    const name = simpleActorMatch[1] || simpleActorMatch[2];
    actors.push(name);
    actorMap.set(name, name);
    continue;
}
```

### 3. parseAndUpdateFromCode関数の改善（app.js:3429-3495）
既存アクションの保持ロジックを追加：
```javascript
// parsed.actionsが存在する場合のみ更新、なければ既存のアクションを保持
if (parsed.actions && parsed.actions.length > 0) {
    // コードから解析した単純なメッセージと、保持した複雑な処理を統合
    this.actions = [...parsed.actions, ...complexActions];
} else if (complexActions.length > 0) {
    // 複雑な処理のみを保持
    this.actions = complexActions;
}
// else の場合、既存のthis.actionsをそのまま保持
```

## 検証結果

### 修正後の動作
- ✅ PlantUMLコードのパースが正しく動作
- ✅ アクターが正しく認識される
- ✅ メッセージ（アクション）が正しくパースされる
- ✅ 同期ボタンクリック時に処理フローが保持される

## 今後の課題

1. **包括的なパース対応**
   - より複雑なPlantUML構文への対応
   - エスケープ文字の処理
   - 複数行にまたがる定義のサポート

2. **エラーハンドリング**
   - パース失敗時の適切なフィードバック
   - 部分的なパース成功時の処理

3. **パフォーマンス**
   - 大規模なPlantUMLコードでのパフォーマンステスト
   - 正規表現の最適化

## 関連ファイル

- 修正ファイル: `app.js`（3429-3495行、3536-3541行、3606-3616行）
- 最終解決報告: `最終解決報告_20250813_1840.md`
- 根本解決計画書: `PlantUMLコード直接編集フリーズ問題_根本解決計画書_v2_20250813_1745.md`

## まとめ

同期ボタンで処理フローがクリアされる問題は、PlantUMLコードパーサーがダブルクォート付きの日本語アクター名を正しく認識できなかったことが原因でした。正規表現を修正することで、日本語を含むアクター名も正しくパースできるようになり、問題が解決しました。
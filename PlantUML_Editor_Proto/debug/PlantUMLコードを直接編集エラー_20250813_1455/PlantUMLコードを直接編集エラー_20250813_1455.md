# PlantUMLコード直接編集エラー デバッグレポート

**発生日時**: 2025年8月13日 14:55  
**環境**: PlantUML Editor Proto (http://localhost:8086)  
**検証ツール**: Playwright Browser Automation

## エラー概要

PlantUMLコードエディタで、パターンから選択したコードを編集しようとすると、ページがフリーズし、最終的に「このページに問題があります」というエラーメッセージが表示される。

## 再現手順

1. PlantUML Editor Proto (http://localhost:8086) を開く
2. パターン選択タブをクリック
3. 「EC注文フロー」パターンを適用
4. PlantUMLコードエディタ内でコードを編集（例：新しい行を追加）
5. 同期ボタンをクリック、または自動同期を待つ
6. **結果**: ページがフリーズし、応答しなくなる

## 根本原因

### 1. パターンコードの形式問題
- **通常のコード**: 改行を含む複数行形式
- **パターン適用後のコード**: 1行に圧縮された形式（改行なし）

```javascript
// パターン適用後のコード例（1行）
@startuml\n顧客 -> ECサイト: 商品を見る\nECサイト -> 顧客: 商品情報を表示\n顧客 -> ECサイト: カートに追加\n...（すべて1行）
```

### 2. RealtimeSyncManagerのパースエラー
```
エラー: Unexpected token=***
発生箇所: RealtimeSyncManager.js
```

パーサーが1行の複雑なコードを正しく解析できず、以下のエラーが発生：
- トークン解析エラー
- 無限ループによるリトライ
- メモリリーク（6.67MB / 7.96MB）

### 3. エラーハンドリングの失敗
ErrorHandler.jsがエラーを捕捉しても、RealtimeSyncManagerが無限ループに陥り、ページがフリーズ。

## 技術的詳細

### 影響を受けるコンポーネント
1. **RealtimeSyncManager.js**
   - parse()メソッドでエラー発生
   - リトライロジックが無限ループ化

2. **DiffCalculator.js**
   - 差分計算が正常に動作しない

3. **ErrorHandler.js**
   - エラーを検知するが、回復できない

### メモリ使用状況
```
警告: 6.67MB / 7.96MB (Memory usage)
状態: メモリリークによる増加傾向
```

## エラーログ

### Playwright実行時のログ
```
1. textarea#plantuml-codeにパターンコードが読み込まれる
2. コード編集を実行
3. 同期ボタンクリック時にタイムアウト（30000ms）
4. ページ完全フリーズ
5. "このページに問題があります"エラー表示
```

### コンソールエラー
```javascript
RealtimeSyncManager parse error: Unexpected token=***
Memory warning: 6.67MB / 7.96MB
Page unresponsive
```

## 回避策（暫定）

1. **手動での改行追加**
   - パターン適用後、コードに手動で改行を追加してから編集

2. **同期の無効化**
   - 自動同期を無効にし、手動同期のみ使用

3. **シンプルなコードでのテスト**
   - 複雑なパターンを避け、単純なactorのみでテスト

## 推奨される修正

### 短期的修正
1. パターン適用時に改行を保持する処理を追加
2. RealtimeSyncManagerのエラーハンドリング強化
3. 無限ループ防止のためのリトライ回数制限

### 長期的修正
1. パーサーの改善（1行コードへの対応）
2. メモリリーク対策
3. エラー時の自動リカバリー機能

## 検証環境

- **ブラウザ**: Chromium (Playwright)
- **サーバー**: http-server (port 8086)
- **ファイル構成**:
  - index.html
  - app.js
  - RealtimeSyncManager.js
  - DiffCalculator.js
  - ErrorHandler.js
  - その他関連ファイル

## 追加情報

### 正常動作するケース
- 手動で入力した単純なコード（例：actor定義のみ）
- 改行を含む通常形式のコード

### エラーが発生するケース
- パターンから選択した複雑なコード
- 1行に圧縮されたコード
- 日本語を含むシーケンス図

## まとめ

このエラーは、パターン適用時のコード形式（1行圧縮）とRealtimeSyncManagerのパーサーの不整合が原因で発生している。根本的な解決には、パターン適用処理またはパーサーの改修が必要。

---
*レポート作成日時: 2025年8月13日 14:55*  
*検証実施者: Claude (Playwright自動テスト)*
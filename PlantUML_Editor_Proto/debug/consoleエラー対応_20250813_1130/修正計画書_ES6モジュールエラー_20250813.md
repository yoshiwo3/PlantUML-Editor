# PlantUML Editor Proto ES6モジュールエラー修正計画書

## 作成日時
2025年8月13日 11:39

## 1. エラー分析サマリー

### 発見されたエラー
- **主要エラー**: ES6モジュール設定の不整合による構文エラー
- **エラー発生ファイル**: app.js (line 7), ErrorHandler.js (line 681)
- **エラーメッセージ**: Unexpected token '==='
- **根本原因**: package.jsonにtype: "module"設定の欠落

### 影響範囲
- アプリケーション全体が起動不能
- 全JavaScriptモジュールの読み込み失敗
- Phase 3の高度な機能が完全停止

## 2. 修正計画

### Phase 1: 緊急対応（即座実施）

#### 1.1 package.json の修正
```json
{
  "name": "plantuml-editor-proto",
  "version": "1.0.0",
  "type": "module",
  "main": "app.js",
  "exports": {
    ".": "./app.js",
    "./TokenTypes": "./TokenTypes.js",
    "./ASTTypes": "./ASTTypes.js",
    "./PlantUMLASTParser": "./PlantUMLASTParser.js"
  }
}
```

#### 1.2 app.js の構文修正
- 問題箇所（line 7）の修正
- 動的import判定の改善
- エラーハンドリングの強化

#### 1.3 ErrorHandler.js の構文修正
- line 681の三項演算子問題の解決
- console出力の安全性向上

### Phase 2: 安定化対応（1日以内）

#### 2.1 モジュール読み込み順序の最適化
- index.htmlのscriptタグ順序調整
- 依存関係の明示化

#### 2.2 フォールバック機能の実装
- ES6非対応ブラウザへの対策
- エラー時の代替処理

### Phase 3: 品質向上（3日以内）

#### 3.1 ビルドシステムの導入
- Viteまたはwebpackの導入検討
- モジュールバンドリング

#### 3.2 テスト環境の構築
- Jest等によるユニットテスト
- Playwrightによる E2Eテスト

## 3. 実装手順

### Step 1: バックアップ作成
```bash
cp -r PlantUML_Editor_Proto PlantUML_Editor_Proto_backup_20250813
```

### Step 2: package.json修正
1. ファイルを開く
2. type: "module"を追加
3. exports設定を追加

### Step 3: app.js修正
1. line 7の構文エラー修正
2. import判定ロジックの改善

### Step 4: ErrorHandler.js修正
1. line 681の修正
2. console出力の安全性向上

### Step 5: 動作確認
1. HTTPサーバー再起動
2. ブラウザキャッシュクリア
3. http://localhost:8080でアクセス
4. コンソールエラーの確認

## 4. リスクと対策

### リスク評価
| リスク | 可能性 | 影響度 | 対策 |
|--------|--------|--------|------|
| 既存機能の破壊 | 低 | 高 | バックアップ作成 |
| ブラウザ互換性問題 | 中 | 中 | フォールバック実装 |
| キャッシュ問題 | 高 | 低 | 強制リロード指示 |

### 緊急時のロールバック手順
1. バックアップフォルダから復元
2. サーバー再起動
3. ブラウザキャッシュクリア

## 5. テスト計画

### 単体テスト項目
- [ ] package.json の有効性確認
- [ ] app.js の構文エラー解消確認
- [ ] ErrorHandler.js の動作確認

### 統合テスト項目
- [ ] 全モジュールの読み込み成功
- [ ] Phase 3機能の動作確認
- [ ] エラーハンドリングの動作確認

### ブラウザ互換性テスト
- [ ] Chrome 最新版
- [ ] Edge 最新版
- [ ] Firefox 最新版
- [ ] Safari 最新版

## 6. 完了基準

### 成功基準
1. コンソールエラーが0件になること
2. 全機能が正常に動作すること
3. Phase 3の双方向同期が動作すること

### 検証方法
1. ブラウザ開発者ツールでエラー確認
2. 各機能の手動テスト実施
3. Playwrightによる自動テスト実行

## 7. スケジュール

| フェーズ | タスク | 期限 | 担当 |
|----------|--------|------|------|
| Phase 1 | 緊急修正 | 即座 | - |
| Phase 2 | 安定化 | 1日以内 | - |
| Phase 3 | 品質向上 | 3日以内 | - |
| 検証 | 全体テスト | 修正後即座 | - |

## 8. 追加推奨事項

### 開発環境の改善
1. ESLintの導入によるコード品質管理
2. Prettierによるコードフォーマット統一
3. pre-commitフックの設定

### ドキュメント整備
1. README.mdの更新
2. トラブルシューティングガイドの作成
3. 開発者向けセットアップガイドの作成

## 9. 詳細修正内容

### 9.1 package.json の具体的修正
現在のpackage.jsonが存在しない場合は新規作成し、以下の内容で設定：

```json
{
  "name": "plantuml-editor-proto",
  "version": "1.0.0",
  "description": "Advanced PlantUML Editor with AST parsing and real-time preview",
  "type": "module",
  "main": "app.js",
  "scripts": {
    "start": "python -m http.server 8080",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "exports": {
    ".": "./app.js",
    "./TokenTypes": "./TokenTypes.js",
    "./ASTTypes": "./ASTTypes.js",
    "./PlantUMLASTParser": "./PlantUMLASTParser.js",
    "./ErrorHandler": "./ErrorHandler.js"
  },
  "keywords": [
    "plantuml",
    "editor",
    "ast",
    "parser",
    "diagram"
  ],
  "author": "",
  "license": "MIT"
}
```

### 9.2 app.js の具体的修正箇所
line 7周辺の構文エラーを以下のように修正：

```javascript
// 修正前（エラー）
const supportsModules = 'noModule' in HTMLScriptElement.prototype === false;

// 修正後（正常）
const supportsModules = !('noModule' in HTMLScriptElement.prototype);
```

### 9.3 ErrorHandler.js の具体的修正箇所
line 681周辺の三項演算子エラーを修正：

```javascript
// 修正前（エラー）
console.log(typeof message === 'string' ? message : JSON.stringify(message, null, 2) === undefined ? 'undefined' : '');

// 修正後（正常）
console.log(typeof message === 'string' ? message : 
           (JSON.stringify(message, null, 2) || 'undefined'));
```

## 10. 追加検証項目

### 10.1 モジュール読み込み検証
- [ ] TokenTypes.js の export/import 確認
- [ ] ASTTypes.js の export/import 確認
- [ ] PlantUMLASTParser.js の export/import 確認
- [ ] ErrorHandler.js の export/import 確認

### 10.2 機能別動作確認
- [ ] PlantUMLコード入力の動作確認
- [ ] プレビュー表示の動作確認
- [ ] エラーハンドリングの動作確認
- [ ] AST解析機能の動作確認
- [ ] リアルタイム同期の動作確認

### 10.3 パフォーマンス確認
- [ ] ページ読み込み時間の測定
- [ ] メモリ使用量の確認
- [ ] CPU使用率の確認

## 11. トラブルシューティング

### よくある問題と解決方法

#### 問題1: モジュールが読み込まれない
**症状**: "Failed to load module script" エラー
**解決方法**: 
1. HTTPサーバーが起動していることを確認
2. ファイルパスが正しいことを確認
3. CORS設定を確認

#### 問題2: 構文エラーが残る
**症状**: "Unexpected token" エラー
**解決方法**:
1. 各ファイルの構文を再確認
2. セミコロンやカンマの欠落を確認
3. 括弧の対応を確認

#### 問題3: 機能が動作しない
**症状**: UIは表示されるが機能しない
**解決方法**:
1. ブラウザキャッシュをクリア
2. 開発者ツールでコンソールエラーを確認
3. ネットワークタブでリソース読み込みを確認

---

**修正実施担当者へのメモ:**
- 必ずバックアップを取ってから作業を開始してください
- 各段階で動作確認を行い、問題があれば直ちに報告してください
- 修正完了後は必ず全機能のテストを実施してください
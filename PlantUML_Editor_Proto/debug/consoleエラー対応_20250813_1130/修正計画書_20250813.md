# PlantUML Editor Proto 修正計画書

## 📋 概要

**作成日**: 2025年8月13日  
**対象**: PlantUML_Editor_Proto配下のプロジェクト全体  
**緊急度**: 高（全機能が動作不能）

---

## 1. 🚨 エラー分析結果のサマリー

### 主要な問題
1. **CORSエラー（最優先）**: file://プロトコルでのESモジュール読み込み不可
2. **モジュール依存関係の破綻**: 全ESモジュールが読み込み失敗
3. **app.jsでのimport文エラー**: 通常のスクリプトタグ内でES6 import使用

### 影響範囲
- **全ESモジュール機能**: TokenTypes.js, ASTTypes.js, PlantUMLASTParser.js等（10個）
- **双方向同期機能**: RealtimeSyncManager, DiffCalculator, CursorStateManager
- **品質保証機能**: ErrorHandler, PerformanceOptimizer, ValidationEngine
- **基本機能**: アクター選択、PlantUML生成、プレビュー表示

### 根本原因
**file://プロトコルでのESモジュール読み込み制限**
- Webブラウザーのセキュリティポリシーにより、ローカルファイル（file://）からのESモジュール読み込みが禁止
- クロスオリジンリクエストとして扱われ、CORS policy violation発生

---

## 2. 🚨 緊急対応（即座に実装可能）

### 2.1 HTMLファイルの修正

**target**: `index.html` 1250行目

**修正前**:
```html
<script src="drawio-converter.js"></script>
<script src="app.js"></script>
```

**修正後**:
```html
<script src="drawio-converter.js"></script>
<script type="module" src="app.js"></script>
```

**追加修正**: ESモジュール読み込みのフォールバック機能を強化

```html
<!-- フォールバック用の従来型スクリプトローダー -->
<script>
// ESモジュール対応チェック
function supportsES6Modules() {
    const script = document.createElement('script');
    return 'noModule' in script;
}

// フォールバック読み込み
if (!supportsES6Modules()) {
    console.warn('[PlantUMLEditor] ES6モジュール非対応のため、基本機能のみで動作します');
    document.getElementById('status-text').textContent = '⚠️ 基本機能のみ利用可能';
}
</script>
```

### 2.2 HTTPサーバーの起動方法

**最も簡単な方法（即座に実行可能）**:

#### A. Python HTTP Server（推奨）
```bash
# PlantUML_Editor_Proto ディレクトリで実行
cd C:\d\PlantUML\PlantUML_Editor_Proto
python -m http.server 8080
# または
python3 -m http.server 8080

# アクセス: http://localhost:8080
```

#### B. Node.js HTTP Server
```bash
# グローバルインストール
npm install -g http-server

# サーバー起動
cd C:\d\PlantUML\PlantUML_Editor_Proto
http-server -p 8080 -c-1

# アクセス: http://localhost:8080
```

#### C. VS Code Live Server
1. VS CodeでPlantUML_Editor_Protoフォルダーを開く
2. Live Server拡張機能をインストール
3. index.htmlを右クリック → "Open with Live Server"

---

## 3. 📅 短期対応（1-2日で実装）

### 3.1 開発環境のセットアップ

**package.json の作成**:
```json
{
  "name": "plantuml-editor-proto",
  "version": "1.0.0",
  "description": "PlantUML Editor with Real-time Sync",
  "main": "app.js",
  "type": "module",
  "scripts": {
    "dev": "python -m http.server 8080",
    "dev:node": "http-server -p 8080 -c-1",
    "dev:live": "live-server --port=8080 --no-browser",
    "test": "echo \"Error: no test specified\" && exit 1",
    "lint": "eslint *.js",
    "format": "prettier --write *.js *.html *.css"
  },
  "devDependencies": {
    "http-server": "^14.1.1",
    "live-server": "^1.2.2",
    "eslint": "^8.0.0",
    "prettier": "^3.0.0"
  },
  "dependencies": {
    "pako": "^2.1.0",
    "plantuml-encoder": "^1.4.0"
  }
}
```

**npm scripts の設定**:
```bash
# 初期セットアップ
npm init -y
npm install --save-dev http-server live-server eslint prettier
npm install --save pako plantuml-encoder

# 開発サーバー起動（3つの選択肢）
npm run dev          # Python HTTP Server
npm run dev:node     # Node.js HTTP Server  
npm run dev:live     # Live Server（自動リロード付き）
```

### 3.2 エラーハンドリングの強化

**app.jsの修正**:
```javascript
// モジュール読み込みエラーハンドリング強化
class PlantUMLEditor {
    constructor() {
        this.moduleLoadStatus = {
            phase1: false, // 基本パーサー
            phase2: false, // 双方向同期
            phase3: false, // リアルタイム同期
            phase4: false  // 品質保証
        };
        this.fallbackMode = false;
        
        this.init();
    }
    
    async init() {
        try {
            await this.loadModules();
            this.initializeApp();
        } catch (error) {
            console.error('[PlantUMLEditor] 初期化エラー:', error);
            this.enableFallbackMode();
        }
    }
    
    async loadModules() {
        // Phase 1: 基本パーサー
        try {
            const parserModule = await import('./PlantUMLASTParser.js');
            this.astParser = parserModule.default;
            this.moduleLoadStatus.phase1 = true;
        } catch (error) {
            console.warn('[Phase 1] 基本パーサー読み込み失敗:', error.message);
        }
        
        // Phase 2-4も同様にエラーハンドリング
        // ...
    }
    
    enableFallbackMode() {
        this.fallbackMode = true;
        this.updateStatusBar('⚠️ フォールバックモードで動作中');
        
        // 基本機能のみ有効化
        this.enableBasicFeatures();
    }
    
    enableBasicFeatures() {
        // HTMLテンプレートベースの基本PlantUML生成機能
        console.log('[PlantUMLEditor] 基本機能で動作します');
    }
}
```

**フォールバック機能の実装**:
```javascript
// フォールバック用PlantUML生成
function generateBasicPlantUML(actors, actions) {
    let code = '@startuml\n';
    
    // アクター定義
    actors.forEach(actor => {
        code += `actor ${actor}\n`;
    });
    
    code += '\n';
    
    // アクション
    actions.forEach(action => {
        code += `${action.from} -> ${action.to} : ${action.message}\n`;
    });
    
    code += '@enduml';
    return code;
}
```

### 3.3 ユーザーへの適切なエラー通知

**エラー表示UI の追加**:
```html
<!-- エラー通知バナー -->
<div id="error-banner" class="error-banner hidden">
    <div class="error-content">
        <span class="error-icon">⚠️</span>
        <span class="error-message"></span>
        <button class="error-close">×</button>
    </div>
</div>

<!-- モジュール状態インジケーター -->
<div class="module-status">
    <span class="module-indicator" data-module="phase1">AST</span>
    <span class="module-indicator" data-module="phase2">同期</span>
    <span class="module-indicator" data-module="phase3">リアルタイム</span>
    <span class="module-indicator" data-module="phase4">品質</span>
</div>
```

---

## 4. 📈 中長期対応（1週間で実装）

### 4.1 ビルドシステムの導入

**Vite の導入**:
```bash
npm install --save-dev vite
```

**vite.config.js**:
```javascript
import { defineConfig } from 'vite';

export default defineConfig({
  root: '.',
  server: {
    port: 8080,
    cors: true
  },
  build: {
    outDir: 'dist',
    rollupOptions: {
      input: {
        main: 'index.html'
      }
    }
  },
  resolve: {
    alias: {
      '@': '.'
    }
  }
});
```

**package.json の更新**:
```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "build:analyze": "vite build --mode analyze"
  }
}
```

### 4.2 モジュールバンドリング

**単一バンドルファイルの生成**:
- 全ESモジュールを1つのファイルに統合
- ES5互換性の確保
- Tree-shakingによる不要コード除去

### 4.3 開発/本番環境の分離

**環境設定ファイル**:
```javascript
// config.js
export const config = {
  development: {
    apiEndpoint: 'http://localhost:8080',
    debug: true,
    enableAdvancedFeatures: true
  },
  production: {
    apiEndpoint: 'https://plantuml-editor.example.com',
    debug: false,
    enableAdvancedFeatures: true
  },
  fallback: {
    apiEndpoint: null,
    debug: true,
    enableAdvancedFeatures: false
  }
};
```

### 4.4 Docker化

**Dockerfile**:
```dockerfile
FROM nginx:alpine

# アプリケーションファイルをコピー
COPY . /usr/share/nginx/html/

# カスタムnginx設定
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

**docker-compose.yml**:
```yaml
version: '3.8'

services:
  plantuml-editor:
    build: .
    ports:
      - "8080:80"
    volumes:
      - .:/usr/share/nginx/html:ro
    environment:
      - NODE_ENV=development
```

**nginx.conf**:
```nginx
server {
    listen 80;
    server_name localhost;
    
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # CORS対応
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept";
    }
    
    # ESモジュールの正しいMIMEタイプ設定
    location ~* \.js$ {
        add_header Content-Type application/javascript;
    }
}
```

---

## 5. 📊 実装優先順位とタイムライン

| 優先度 | タスク | 期限 | 担当 | 完了基準 |
|-------|--------|------|------|----------|
| **1** | HTML修正（type="module"追加） | 即座 | 開発者 | app.jsのimportエラー解消 |
| **2** | HTTPサーバー起動 | 即座 | 開発者 | localhost:8080でアクセス可能 |
| **3** | フォールバック機能実装 | 4時間以内 | 開発者 | ESモジュール失敗時も基本機能動作 |
| **4** | package.json作成 | 1日以内 | 開発者 | npm scriptsでサーバー起動可能 |
| **5** | エラーハンドリング強化 | 2日以内 | 開発者 | ユーザーフレンドリーなエラー表示 |
| **6** | Vite導入 | 3日以内 | 開発者 | 高速開発サーバーとビルド |
| **7** | モジュールバンドリング | 1週間以内 | 開発者 | 単一ファイルでの動作確認 |
| **8** | Docker化 | 1週間以内 | DevOps | コンテナでの正常動作 |

---

## 6. 🧪 テスト計画

### 6.1 各修正後の動作確認項目

#### 緊急対応後のテスト
- [ ] ブラウザコンソールでCORSエラーが発生しないか
- [ ] app.jsのimportエラーが解消されているか
- [ ] 基本的なアクター選択機能が動作するか
- [ ] PlantUMLコード生成が正常に動作するか

#### 短期対応後のテスト
- [ ] 全フェーズのモジュールが正常に読み込まれるか
- [ ] フォールバックモードが正常に動作するか
- [ ] エラー通知UIが適切に表示されるか
- [ ] npm scriptsでサーバーが起動するか

#### 中長期対応後のテスト
- [ ] Viteビルドが成功するか
- [ ] バンドルファイルが正常に動作するか
- [ ] Dockerコンテナが正常に起動するか
- [ ] 本番環境で正常に動作するか

### 6.2 E2Eテストシナリオ

```javascript
// Playwright E2Eテスト例
test('PlantUMLエディター基本フロー', async ({ page }) => {
  // サーバー起動確認
  await page.goto('http://localhost:8080');
  
  // ページ読み込み確認
  await expect(page.locator('h1')).toContainText('PlantUML変換エディター');
  
  // アクター選択
  await page.click('[data-actor="顧客"]');
  await page.click('[data-actor="ECサイト"]');
  
  // メッセージ追加
  await page.fill('#action-text', '商品を注文');
  await page.click('.btn-add-action');
  
  // PlantUMLコード生成確認
  const codeContent = await page.locator('#plantuml-code').textContent();
  expect(codeContent).toContain('@startuml');
  expect(codeContent).toContain('顧客 -> ECサイト : 商品を注文');
  expect(codeContent).toContain('@enduml');
});
```

---

## 7. ⚠️ リスクと対策

### 7.1 互換性の問題

**リスク**: 古いブラウザーでの動作不良
**対策**: 
- ES5ポリフィルの追加
- フォールバック機能の充実
- ブラウザー対応表の作成

### 7.2 パフォーマンスへの影響

**リスク**: モジュール読み込み時間の増加
**対策**:
- 遅延読み込み（Lazy Loading）の実装
- 重要度の低い機能の非同期読み込み
- バンドルサイズの最適化

### 7.3 ユーザビリティの考慮事項

**リスク**: エラー時のユーザー混乱
**対策**:
- わかりやすいエラーメッセージ
- 段階的機能退化（Graceful Degradation）
- オンラインヘルプの提供

---

## 8. ✅ 修正後の確認項目チェックリスト

### 8.1 基本動作確認
- [ ] **エラーログがクリーンか**: ブラウザコンソールにCORSエラーが出ていない
- [ ] **全モジュールが正常に読み込まれるか**: Network タブで404エラーがない
- [ ] **AST解析機能が動作するか**: PlantUMLコードが正しく解析される
- [ ] **リアルタイム同期が機能するか**: コード↔UI間の双方向同期
- [ ] **エラーハンドリングが適切か**: エラー時にアプリがクラッシュしない

### 8.2 機能別確認
- [ ] **アクター選択**: 複数アクターの選択・解除
- [ ] **メッセージ追加**: 同期・非同期・未確定メッセージ
- [ ] **条件分岐**: alt/else構文の正常生成
- [ ] **ループ処理**: loop構文の正常生成
- [ ] **並行処理**: par/else構文の正常生成
- [ ] **プレビュー表示**: SVGレンダリングの正常動作
- [ ] **draw.io連携**: XML変換とファイル出力

### 8.3 パフォーマンス確認
- [ ] **初期読み込み時間**: 3秒以内での表示
- [ ] **メモリ使用量**: 100MB以下での動作
- [ ] **CPU使用率**: アイドル時10%以下
- [ ] **ネットワーク**: 必要最小限のリクエスト

---

## 9. 🔧 具体的な修正手順（実装ガイド）

### 手順1: 即座の修正（5分以内）

```bash
# 1. index.htmlのバックアップ作成
cd C:\d\PlantUML\PlantUML_Editor_Proto
copy index.html index.html.backup

# 2. index.htmlの修正（1250行目）
# テキストエディターで以下を変更:
# 変更前: <script src="app.js"></script>
# 変更後: <script type="module" src="app.js"></script>

# 3. HTTPサーバー起動
python -m http.server 8080

# 4. ブラウザーでアクセス
# http://localhost:8080 を開く
```

### 手順2: フォールバック機能追加（30分以内）

```javascript
// app.jsの先頭に追加
class ModuleLoader {
    static async safeImport(modulePath, fallbackName) {
        try {
            const module = await import(modulePath);
            console.log(`✅ ${modulePath} 読み込み成功`);
            return module.default || module[fallbackName];
        } catch (error) {
            console.warn(`⚠️ ${modulePath} 読み込み失敗:`, error.message);
            return null;
        }
    }
    
    static async loadAllModules() {
        const modules = {};
        
        modules.tokenTypes = await this.safeImport('./TokenTypes.js', 'TokenTypes');
        modules.astTypes = await this.safeImport('./ASTTypes.js', 'ASTTypes');
        modules.parser = await this.safeImport('./PlantUMLASTParser.js', 'PlantUMLASTParser');
        
        return modules;
    }
}

// PlantUMLEditorクラスを修正
class PlantUMLEditor {
    constructor() {
        this.modules = {};
        this.init();
    }
    
    async init() {
        try {
            this.modules = await ModuleLoader.loadAllModules();
            this.initializeWithModules();
        } catch (error) {
            console.error('モジュール読み込みエラー:', error);
            this.initializeBasicMode();
        }
    }
    
    initializeBasicMode() {
        console.log('🔄 基本モードで起動します');
        this.updateStatusBar('⚠️ 基本機能のみ利用可能');
        
        // 基本的なUI機能のみ有効化
        this.setupBasicEventListeners();
        this.enableBasicPlantUMLGeneration();
    }
}
```

### 手順3: package.json作成（10分以内）

```bash
# npm初期化
npm init -y

# 開発依存関係インストール
npm install --save-dev http-server live-server

# package.jsonのscriptsセクションを編集
{
  "scripts": {
    "dev": "python -m http.server 8080",
    "dev:node": "http-server -p 8080 -c-1 --cors",
    "dev:live": "live-server --port=8080 --host=localhost"
  }
}

# サーバー起動テスト
npm run dev:node
```

### 手順4: エラー表示UI追加（20分以内）

```html
<!-- index.htmlのbody直後に追加 -->
<div id="error-notification" class="error-notification hidden">
    <div class="error-content">
        <div class="error-header">
            <span class="error-icon">⚠️</span>
            <span class="error-title">動作モード</span>
            <button class="error-close" onclick="hideErrorNotification()">×</button>
        </div>
        <div class="error-message"></div>
        <div class="error-actions">
            <button onclick="location.reload()">再読み込み</button>
            <button onclick="showTroubleshooting()">トラブルシューティング</button>
        </div>
    </div>
</div>
```

```css
/* styles.cssに追加 */
.error-notification {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    max-width: 400px;
    z-index: 1000;
}

.error-notification.error {
    background: #f8d7da;
    border-color: #f5c6cb;
}

.error-notification.success {
    background: #d1ecf1;
    border-color: #bee5eb;
}
```

### 手順5: 動作確認（15分以内）

```javascript
// テスト用スクリプト（test-basic.js）
function testBasicFunctionality() {
    console.log('🧪 基本機能テスト開始');
    
    // 1. DOMテスト
    const actorButtons = document.querySelectorAll('.actor-btn');
    console.log(`アクターボタン数: ${actorButtons.length}`);
    
    // 2. イベントリスナーテスト
    if (actorButtons.length > 0) {
        actorButtons[0].click();
        console.log('✅ アクタークリックテスト成功');
    }
    
    // 3. PlantUMLコード生成テスト
    const codeArea = document.getElementById('plantuml-code');
    if (codeArea && codeArea.value.includes('@startuml')) {
        console.log('✅ PlantUMLコード生成テスト成功');
    }
    
    console.log('🎉 基本機能テスト完了');
}

// ページ読み込み後にテスト実行
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(testBasicFunctionality, 1000);
});
```

---

## 10. 📞 サポート情報

### 緊急時の連絡先
- **技術サポート**: 開発チーム
- **インフラ問題**: DevOpsチーム

### 参考ドキュメント
- [ES6 Modules - MDN](https://developer.mozilla.org/ja/docs/Web/JavaScript/Guide/Modules)
- [CORS - MDN](https://developer.mozilla.org/ja/docs/Web/HTTP/CORS)
- [Vite Documentation](https://vitejs.dev/)
- [PlantUML Official](https://plantuml.com/)

### トラブルシューティング
1. **CORSエラーが続く場合**: ブラウザーキャッシュをクリア
2. **モジュール読み込み失敗**: HTTPサーバーが正しく起動しているか確認
3. **performance問題**: ブラウザーの開発者ツールでNetwork/Performance確認

---

## 11. 📝 まとめ

この修正計画書に従って実装することで、PlantUML Editor Protoの全機能を段階的に復旧できます。最優先は**HTTPサーバーでの動作環境構築**と**ESモジュールエラーの解消**です。

**成功の指標**:
- ❌ → ✅ CORSエラーの完全解消
- ❌ → ✅ 全ESモジュールの正常読み込み
- ❌ → ✅ 基本的なPlantUML生成機能の動作
- ❌ → ✅ 双方向同期機能の復旧

**最終目標**: 安定性と拡張性を兼ね備えた、プロダクション対応のPlantUMLエディターの実現

---

**最終更新**: 2025年8月13日  
**バージョン**: 1.0  
**ステータス**: 実装待ち
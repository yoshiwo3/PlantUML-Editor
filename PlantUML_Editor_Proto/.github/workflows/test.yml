# PlantUML Editor - Unit Test CI/CD Workflow
# Sprint 1 å˜ä½“ãƒ†ã‚¹ãƒˆç’°å¢ƒ - GitHub Actionsè¨­å®š
# 
# å®Ÿè¡Œå¯¾è±¡: 
#   - å˜ä½“ãƒ†ã‚¹ãƒˆ (Jest)
#   - ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
#   - ãƒ†ã‚¹ãƒˆçµæœã®å¯è¦–åŒ–
# 
# ä½œæˆæ—¥: 2025-08-15
# ä½œæˆè€…: webapp-test-automation

name: Unit Test CI

on:
  push:
    branches: [ main, develop, feature/* ]
    paths:
      - '**.js'
      - '**/*test.js'
      - '**/*spec.js'
      - 'package*.json'
      - 'jest.config.js'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.js'
      - '**/*test.js'  
      - '**/*spec.js'
      - 'package*.json'
      - 'jest.config.js'

# Concurrencyåˆ¶å¾¡ - åŒä¸€PRã§ã®é‡è¤‡å®Ÿè¡Œé˜²æ­¢
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===============================
  # Job 1: å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  # ===============================
  unit-tests:
    name: Unit Tests (Sprint 1)
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
      fail-fast: false

    steps:
    # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Node.jsç’°å¢ƒè¨­å®š
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: './package-lock.json'

    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
    - name: Cache node_modules
      uses: actions/cache@v3
      id: cache-node-modules
      with:
        path: node_modules
        key: node-modules-${{ matrix.node-version }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          node-modules-${{ matrix.node-version }}-

    # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install dependencies
      if: steps.cache-node-modules.outputs.cache-hit != 'true'
      run: npm ci

    # Jestè¨­å®šæ¤œè¨¼
    - name: Validate Jest configuration
      run: |
        echo "Validating Jest configuration..."
        npx jest --showConfig
        echo "âœ… Jest configuration is valid"

    # å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 5åˆ†ï¼‰
    - name: Run unit tests
      run: |
        echo "ğŸ§ª Running Sprint 1 unit tests..."
        npm run test:unit:coverage
      timeout-minutes: 5
      env:
        CI: true
        JEST_VERBOSE: false

    # ãƒ†ã‚¹ãƒˆçµæœã®è§£æ
    - name: Analyze test results
      run: |
        echo "ğŸ“Š Test Results Analysis:"
        if [ -f "coverage/test-report.html" ]; then
          echo "âœ… HTML test report generated"
        fi
        if [ -f "coverage/junit.xml" ]; then
          echo "âœ… JUnit XML report generated"
          # JUnitçµæœã®æ¦‚è¦è¡¨ç¤º
          if command -v xmllint > /dev/null; then
            xmllint --xpath "//testsuite/@tests | //testsuite/@failures | //testsuite/@errors" coverage/junit.xml 2>/dev/null || true
          fi
        fi

    # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    - name: Generate coverage report
      run: |
        echo "ğŸ“ˆ Generating coverage report..."
        if [ -d "coverage" ]; then
          echo "Coverage Summary:"
          cat coverage/coverage-summary.json | head -20 || true
          echo "âœ… Coverage report generated successfully"
        else
          echo "âŒ Coverage directory not found"
          exit 1
        fi

    # ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯
    - name: Check coverage thresholds
      run: |
        echo "ğŸ¯ Checking coverage thresholds (CLAUDE.md standard: 80%)..."
        npm run test:coverage -- --verbose
      continue-on-error: true

    # ãƒ†ã‚¹ãƒˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-node-${{ matrix.node-version }}
        path: |
          coverage/
          test-results/
        retention-days: 14

    # JUnit ãƒ†ã‚¹ãƒˆçµæœå…¬é–‹
    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Unit Test Results (Node.js ${{ matrix.node-version }})
        path: coverage/junit.xml
        reporter: java-junit
        fail-on-error: false

    # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆå…¬é–‹ï¼ˆNode.js 20ã®ã¿ï¼‰
    - name: Upload coverage reports to Codecov
      if: matrix.node-version == '20.x'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-unit-tests
        fail_ci_if_error: false

  # ===============================
  # Job 2: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆç‰¹åŒ–
  # ===============================
  security-tests:
    name: Security Unit Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç‰¹åŒ–ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    - name: Run security-focused tests
      run: |
        echo "ğŸ”’ Running security unit tests..."
        npm run test:unit -- --testPathPattern="security" --verbose
      env:
        CI: true

    # XSSé˜²å¾¡ãƒ†ã‚¹ãƒˆ
    - name: Run XSS protection tests  
      run: |
        echo "ğŸ›¡ï¸ Testing XSS protection..."
        npm run test:unit -- --testNamePattern="XSS|sanitize|DOMPurify" --verbose

    # CSPæ¤œè¨¼ãƒ†ã‚¹ãƒˆ
    - name: Run CSP validation tests
      run: |
        echo "ğŸ” Testing CSP validation..."
        npm run test:unit -- --testNamePattern="CSP|Content.*Security.*Policy" --verbose

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆçµæœä¿å­˜
    - name: Upload security test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-test-results
        path: coverage/
        retention-days: 7

  # ===============================
  # Job 3: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  # ===============================
  performance-tests:
    name: Performance Tests (5s threshold)
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆCLAUDE.mdåŸºæº–: 5ç§’ä»¥å†…ï¼‰
    - name: Run performance tests
      run: |
        echo "â±ï¸ Running performance tests (CLAUDE.md 5s threshold)..."
        npm run test:unit -- --testNamePattern="performance|Performance" --verbose
      env:
        CI: true
        PERFORMANCE_THRESHOLD: 5000

    # å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ†ã‚¹ãƒˆ
    - name: Run bulk operation tests
      run: |
        echo "ğŸ“Š Testing bulk operations..."
        npm run test:unit -- --testNamePattern="bulk|large|å¤§é‡" --verbose

    # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµæœã®è§£æ
    - name: Analyze performance results
      run: |
        echo "ğŸ“ˆ Analyzing performance test results..."
        echo "Performance threshold: 5 seconds (CLAUDE.md standard)"
        echo "âœ… Performance tests completed"

  # ===============================
  # Job 4: ãƒ†ã‚¹ãƒˆçµæœçµ±åˆ
  # ===============================
  test-summary:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, security-tests, performance-tests]
    if: always()

    steps:
    - name: Download all test artifacts
      uses: actions/download-artifact@v3

    # çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    - name: Generate integrated test report
      run: |
        echo "ğŸ“Š Generating integrated test report..."
        echo "## Sprint 1 Unit Test Results Summary" > test-summary.md
        echo "" >> test-summary.md
        echo "### Test Execution Status" >> test-summary.md
        echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> test-summary.md  
        echo "- Security Tests: ${{ needs.security-tests.result }}" >> test-summary.md
        echo "- Performance Tests: ${{ needs.performance-tests.result }}" >> test-summary.md
        echo "" >> test-summary.md
        echo "### Coverage Information" >> test-summary.md
        
        # ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã®çµ±åˆï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
        if [ -d "test-results-node-20.x/coverage" ]; then
          echo "Coverage reports available in artifacts" >> test-summary.md
        fi
        
        echo "" >> test-summary.md
        echo "### Artifacts Generated" >> test-summary.md
        echo "- Test Results (Node.js 18.x, 20.x)" >> test-summary.md
        echo "- Security Test Results" >> test-summary.md
        echo "- Coverage Reports (LCOV, HTML, JSON)" >> test-summary.md
        echo "" >> test-summary.md
        echo "Generated on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> test-summary.md

    # PRã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
    - name: Comment PR with test results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('test-summary.md')) {
            const summary = fs.readFileSync('test-summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ§ª Sprint 1 Unit Test Results\n\n${summary}`
            });
          }

    # çµ±åˆãƒ¬ãƒãƒ¼ãƒˆä¿å­˜
    - name: Upload integrated test summary
      uses: actions/upload-artifact@v3
      with:
        name: test-summary
        path: test-summary.md
        retention-days: 30

  # ===============================
  # Job 5: å“è³ªã‚²ãƒ¼ãƒˆ
  # ===============================
  quality-gate:
    name: Quality Gate (Sprint 1)
    runs-on: ubuntu-latest
    needs: [unit-tests, security-tests, performance-tests]

    steps:
    - name: Quality gate evaluation
      run: |
        echo "ğŸšª Evaluating quality gate for Sprint 1..."
        
        # ãƒ†ã‚¹ãƒˆçµæœã®ç¢ºèª
        UNIT_TESTS="${{ needs.unit-tests.result }}"
        SECURITY_TESTS="${{ needs.security-tests.result }}"
        PERFORMANCE_TESTS="${{ needs.performance-tests.result }}"
        
        echo "Unit Tests: $UNIT_TESTS"
        echo "Security Tests: $SECURITY_TESTS"  
        echo "Performance Tests: $PERFORMANCE_TESTS"
        
        # å“è³ªã‚²ãƒ¼ãƒˆã®åˆ¤å®š
        FAILED=false
        
        if [ "$UNIT_TESTS" != "success" ]; then
          echo "âŒ Unit tests failed or were cancelled"
          FAILED=true
        fi
        
        if [ "$SECURITY_TESTS" != "success" ]; then
          echo "âŒ Security tests failed or were cancelled"
          FAILED=true
        fi
        
        if [ "$PERFORMANCE_TESTS" != "success" ]; then
          echo "âŒ Performance tests failed or were cancelled"
          FAILED=true
        fi
        
        if [ "$FAILED" = true ]; then
          echo "ğŸš« Quality gate FAILED - Sprint 1 requirements not met"
          exit 1
        else
          echo "âœ… Quality gate PASSED - Sprint 1 ready for next phase"
        fi

    # Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
    - name: Notify Slack on failure
      if: failure()
      run: |
        echo "Quality gate failed - Sprint 1 unit tests need attention"
        # Slack webhookå®Ÿè£…ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³

# ===============================
# ç’°å¢ƒå¤‰æ•°å®šç¾©
# ===============================
env:
  # Node.jsè¨­å®š
  NODE_ENV: test
  CI: true
  
  # Jestè¨­å®š
  JEST_JUNIT_OUTPUT_DIR: ./coverage
  JEST_JUNIT_OUTPUT_NAME: junit.xml
  
  # ã‚«ãƒãƒ¬ãƒƒã‚¸è¨­å®š
  COVERAGE_THRESHOLD: 80
  
  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®š
  PERFORMANCE_TIMEOUT: 5000
  
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  SECURITY_SCAN_ENABLED: true
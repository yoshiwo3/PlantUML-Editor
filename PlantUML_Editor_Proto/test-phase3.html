<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 3 å‹•ä½œãƒ†ã‚¹ãƒˆ</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-result.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        #test-textarea {
            width: 100%;
            height: 200px;
            margin: 10px 0;
            font-family: monospace;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Phase 3 ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>1. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</h2>
        <div id="module-test-results"></div>
        <button onclick="testModuleLoading()">ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    </div>
    
    <div class="test-section">
        <h2>2. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆãƒ†ã‚¹ãƒˆ</h2>
        <div id="instance-test-results"></div>
        <button onclick="testInstanceCreation()">ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    </div>
    
    <div class="test-section">
        <h2>3. å·®åˆ†è¨ˆç®—ãƒ†ã‚¹ãƒˆ</h2>
        <div id="diff-test-results"></div>
        <button onclick="testDiffCalculation()">å·®åˆ†è¨ˆç®—ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    </div>
    
    <div class="test-section">
        <h2>4. ã‚«ãƒ¼ã‚½ãƒ«ç®¡ç†ãƒ†ã‚¹ãƒˆ</h2>
        <textarea id="test-textarea" placeholder="ã“ã®æ–‡å­—å…¥åŠ›ã‚¨ãƒªã‚¢ã§ã‚«ãƒ¼ã‚½ãƒ«ç®¡ç†ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™...">@startuml
Alice -> Bob: Hello
Bob -> Alice: Hi
@enduml</textarea>
        <div id="cursor-test-results"></div>
        <button onclick="testCursorManagement()">ã‚«ãƒ¼ã‚½ãƒ«ç®¡ç†ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    </div>
    
    <div class="test-section">
        <h2>5. çµ±åˆãƒ†ã‚¹ãƒˆ</h2>
        <div id="integration-test-results"></div>
        <button onclick="testIntegration()">çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    </div>
    
    <div class="test-section">
        <h2>6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</h2>
        <div id="performance-test-results"></div>
        <button onclick="testPerformance()">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    </div>
    
    <div class="test-section">
        <h2>ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h2>
        <div id="debug-info" class="debug-info"></div>
        <button onclick="updateDebugInfo()">ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°</button>
    </div>

    <!-- CDNãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    
    <!-- Phase 3ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <script type="module" src="TokenTypes.js"></script>
    <script type="module" src="ASTTypes.js"></script>
    <script type="module" src="PlantUMLASTParser.js"></script>
    <script type="module" src="RealtimeSyncManager.js"></script>
    <script type="module" src="DiffCalculator.js"></script>
    <script type="module" src="CursorStateManager.js"></script>

    <script>
        // ãƒ†ã‚¹ãƒˆçµæœã‚’è¡¨ç¤ºã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function showResult(containerId, message, type = 'success') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let testInstances = {};

        // 1. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
        async function testModuleLoading() {
            clearResults('module-test-results');
            
            try {
                // ES6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                if (typeof import === 'function') {
                    const modules = await Promise.all([
                        import('./RealtimeSyncManager.js'),
                        import('./DiffCalculator.js'),
                        import('./CursorStateManager.js')
                    ]);
                    
                    const [syncModule, diffModule, cursorModule] = modules;
                    
                    if (syncModule.default || syncModule.RealtimeSyncManager) {
                        showResult('module-test-results', 'âœ… RealtimeSyncManager ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ');
                    } else {
                        showResult('module-test-results', 'âŒ RealtimeSyncManager ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
                    }
                    
                    if (diffModule.default || diffModule.DiffCalculator) {
                        showResult('module-test-results', 'âœ… DiffCalculator ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ');
                    } else {
                        showResult('module-test-results', 'âŒ DiffCalculator ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
                    }
                    
                    if (cursorModule.default || cursorModule.CursorStateManager) {
                        showResult('module-test-results', 'âœ… CursorStateManager ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ');
                    } else {
                        showResult('module-test-results', 'âŒ CursorStateManager ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
                    }
                    
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒã‚§ãƒƒã‚¯
                    if (typeof window.RealtimeSyncManager !== 'undefined') {
                        showResult('module-test-results', 'âœ… RealtimeSyncManager (ã‚°ãƒ­ãƒ¼ãƒãƒ«)');
                    } else {
                        showResult('module-test-results', 'âš ï¸ RealtimeSyncManager ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                    }
                    
                    if (typeof window.DiffCalculator !== 'undefined') {
                        showResult('module-test-results', 'âœ… DiffCalculator (ã‚°ãƒ­ãƒ¼ãƒãƒ«)');
                    } else {
                        showResult('module-test-results', 'âš ï¸ DiffCalculator ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                    }
                    
                    if (typeof window.CursorStateManager !== 'undefined') {
                        showResult('module-test-results', 'âœ… CursorStateManager (ã‚°ãƒ­ãƒ¼ãƒãƒ«)');
                    } else {
                        showResult('module-test-results', 'âš ï¸ CursorStateManager ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                    }
                }
                
            } catch (error) {
                showResult('module-test-results', `âŒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Module loading error:', error);
            }
        }

        // 2. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆãƒ†ã‚¹ãƒˆ
        async function testInstanceCreation() {
            clearResults('instance-test-results');
            
            try {
                // DiffCalculator ã®ãƒ†ã‚¹ãƒˆ
                if (typeof window.DiffCalculator !== 'undefined') {
                    testInstances.diffCalculator = new window.DiffCalculator();
                    showResult('instance-test-results', 'âœ… DiffCalculator ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ');
                } else {
                    showResult('instance-test-results', 'âš ï¸ DiffCalculator ã‚¯ãƒ©ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'warning');
                }
                
                // CursorStateManager ã®ãƒ†ã‚¹ãƒˆ
                if (typeof window.CursorStateManager !== 'undefined') {
                    testInstances.cursorManager = new window.CursorStateManager();
                    showResult('instance-test-results', 'âœ… CursorStateManager ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ');
                } else {
                    showResult('instance-test-results', 'âš ï¸ CursorStateManager ã‚¯ãƒ©ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'warning');
                }
                
                // RealtimeSyncManager ã®ãƒ†ã‚¹ãƒˆï¼ˆãƒ¢ãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§ï¼‰
                if (typeof window.RealtimeSyncManager !== 'undefined') {
                    const mockEditor = {
                        selectedActors: new Set(['Alice', 'Bob']),
                        actions: [],
                        currentMode: 'actor-action'
                    };
                    testInstances.syncManager = new window.RealtimeSyncManager(mockEditor);
                    showResult('instance-test-results', 'âœ… RealtimeSyncManager ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ');
                } else {
                    showResult('instance-test-results', 'âš ï¸ RealtimeSyncManager ã‚¯ãƒ©ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'warning');
                }
                
            } catch (error) {
                showResult('instance-test-results', `âŒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Instance creation error:', error);
            }
        }

        // 3. å·®åˆ†è¨ˆç®—ãƒ†ã‚¹ãƒˆ
        function testDiffCalculation() {
            clearResults('diff-test-results');
            
            if (!testInstances.diffCalculator) {
                showResult('diff-test-results', 'âŒ DiffCalculator ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                const oldCode = `@startuml
Alice -> Bob: Hello
@enduml`;
                
                const newCode = `@startuml
Alice -> Bob: Hello
Bob -> Alice: Hi there!
@enduml`;
                
                const diff = testInstances.diffCalculator.calculateCodeDiff(oldCode, newCode);
                
                if (diff.hasChanges) {
                    showResult('diff-test-results', 'âœ… ã‚³ãƒ¼ãƒ‰å·®åˆ†æ¤œå‡ºæˆåŠŸ');
                    showResult('diff-test-results', `ğŸ“Š å¤‰æ›´çµ±è¨ˆ: è¿½åŠ ${diff.stats?.linesAdded || 0}è¡Œ, å‰Šé™¤${diff.stats?.linesRemoved || 0}è¡Œ`);
                } else {
                    showResult('diff-test-results', 'âš ï¸ å·®åˆ†ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'warning');
                }
                
                // GUIå·®åˆ†ãƒ†ã‚¹ãƒˆ
                const oldState = { selectedActors: new Set(['Alice']), actions: [] };
                const newState = { selectedActors: new Set(['Alice', 'Bob']), actions: [{ type: 'message', from: 'Alice', to: 'Bob', message: 'Hello' }] };
                
                const guiDiff = testInstances.diffCalculator.calculateGUIDiff(oldState, newState);
                
                if (guiDiff.hasChanges) {
                    showResult('diff-test-results', 'âœ… GUIå·®åˆ†æ¤œå‡ºæˆåŠŸ');
                } else {
                    showResult('diff-test-results', 'âš ï¸ GUIå·®åˆ†ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'warning');
                }
                
                // çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º
                const stats = testInstances.diffCalculator.getStats();
                showResult('diff-test-results', `ğŸ“ˆ å·®åˆ†è¨ˆç®—çµ±è¨ˆ: è¨ˆç®—å›æ•°${stats.calculations}, ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡${stats.cacheHitRate || '0%'}`);
                
            } catch (error) {
                showResult('diff-test-results', `âŒ å·®åˆ†è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Diff calculation error:', error);
            }
        }

        // 4. ã‚«ãƒ¼ã‚½ãƒ«ç®¡ç†ãƒ†ã‚¹ãƒˆ
        function testCursorManagement() {
            clearResults('cursor-test-results');
            
            if (!testInstances.cursorManager) {
                showResult('cursor-test-results', 'âŒ CursorStateManager ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                const textarea = document.getElementById('test-textarea');
                
                if (!textarea) {
                    showResult('cursor-test-results', 'âŒ ãƒ†ã‚¹ãƒˆç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                
                // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®ä¿å­˜
                textarea.focus();
                textarea.setSelectionRange(10, 10);
                
                const savedState = testInstances.cursorManager.saveCursorState(textarea, 'test');
                
                if (savedState) {
                    showResult('cursor-test-results', 'âœ… ã‚«ãƒ¼ã‚½ãƒ«çŠ¶æ…‹ä¿å­˜æˆåŠŸ');
                    showResult('cursor-test-results', `ğŸ“ ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®: ${savedState.selectionStart}-${savedState.selectionEnd}`);
                } else {
                    showResult('cursor-test-results', 'âŒ ã‚«ãƒ¼ã‚½ãƒ«çŠ¶æ…‹ä¿å­˜å¤±æ•—', 'error');
                    return;
                }
                
                // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’å¤‰æ›´
                textarea.setSelectionRange(20, 25);
                
                // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’å¾©å…ƒ
                const restored = testInstances.cursorManager.restoreCursorState(textarea, 'test');
                
                if (restored) {
                    showResult('cursor-test-results', 'âœ… ã‚«ãƒ¼ã‚½ãƒ«çŠ¶æ…‹å¾©å…ƒæˆåŠŸ');
                    
                    // å¾©å…ƒã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
                    if (textarea.selectionStart === savedState.selectionStart && 
                        textarea.selectionEnd === savedState.selectionEnd) {
                        showResult('cursor-test-results', 'âœ… ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ãŒæ­£ç¢ºã«å¾©å…ƒã•ã‚Œã¾ã—ãŸ');
                    } else {
                        showResult('cursor-test-results', 'âš ï¸ ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®å¾©å…ƒãŒä¸å®Œå…¨ã§ã™', 'warning');
                    }
                } else {
                    showResult('cursor-test-results', 'âŒ ã‚«ãƒ¼ã‚½ãƒ«çŠ¶æ…‹å¾©å…ƒå¤±æ•—', 'error');
                }
                
                // çµ±è¨ˆæƒ…å ±
                const stats = testInstances.cursorManager.getStats();
                showResult('cursor-test-results', `ğŸ“ˆ ã‚«ãƒ¼ã‚½ãƒ«ç®¡ç†çµ±è¨ˆ: ä¿å­˜${stats.saves}å›, å¾©å…ƒ${stats.restores}å›`);
                
            } catch (error) {
                showResult('cursor-test-results', `âŒ ã‚«ãƒ¼ã‚½ãƒ«ç®¡ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Cursor management error:', error);
            }
        }

        // 5. çµ±åˆãƒ†ã‚¹ãƒˆ
        function testIntegration() {
            clearResults('integration-test-results');
            
            try {
                if (!testInstances.syncManager) {
                    showResult('integration-test-results', 'âŒ RealtimeSyncManager ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'error');
                    return;
                }
                
                // åŒæœŸçŠ¶æ…‹ã®ãƒ†ã‚¹ãƒˆ
                const syncStatus = testInstances.syncManager.getSyncStatus();
                
                if (syncStatus) {
                    showResult('integration-test-results', 'âœ… åŒæœŸçŠ¶æ…‹å–å¾—æˆåŠŸ');
                    showResult('integration-test-results', `ğŸ”„ åŒæœŸçŠ¶æ…‹: ${syncStatus.isActive ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–'}`);
                    showResult('integration-test-results', `ğŸ“Š ã‚¨ãƒ©ãƒ¼æ•°: ${syncStatus.errorCount || 0}`);
                } else {
                    showResult('integration-test-results', 'âš ï¸ åŒæœŸçŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—', 'warning');
                }
                
                // æ‰‹å‹•åŒæœŸã®ãƒ†ã‚¹ãƒˆ
                testInstances.syncManager.manualSync('both');
                showResult('integration-test-results', 'âœ… æ‰‹å‹•åŒæœŸå®Ÿè¡ŒæˆåŠŸ');
                
                showResult('integration-test-results', 'ğŸ‰ çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†');
                
            } catch (error) {
                showResult('integration-test-results', `âŒ çµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Integration test error:', error);
            }
        }

        // 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        function testPerformance() {
            clearResults('performance-test-results');
            
            try {
                if (!testInstances.diffCalculator) {
                    showResult('performance-test-results', 'âŒ DiffCalculator ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'error');
                    return;
                }
                
                showResult('performance-test-results', 'ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹...');
                
                // å¤§é‡ã®å·®åˆ†è¨ˆç®—ãƒ†ã‚¹ãƒˆ
                const iterations = 100;
                const startTime = performance.now();
                
                for (let i = 0; i < iterations; i++) {
                    const oldCode = `@startuml\nAlice -> Bob: Message ${i}\n@enduml`;
                    const newCode = `@startuml\nAlice -> Bob: Message ${i + 1}\n@enduml`;
                    testInstances.diffCalculator.calculateCodeDiff(oldCode, newCode);
                }
                
                const endTime = performance.now();
                const totalTime = endTime - startTime;
                const avgTime = totalTime / iterations;
                
                showResult('performance-test-results', `â±ï¸ ${iterations}å›ã®å·®åˆ†è¨ˆç®—å®Œäº†`);
                showResult('performance-test-results', `ğŸ“Š ç·æ™‚é–“: ${totalTime.toFixed(2)}ms`);
                showResult('performance-test-results', `ğŸ“Š å¹³å‡æ™‚é–“: ${avgTime.toFixed(2)}ms/å›`);
                
                const stats = testInstances.diffCalculator.getStats();
                showResult('performance-test-results', `ğŸ’¾ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡: ${stats.cacheHitRate || '0%'}`);
                
                if (avgTime < 5) {
                    showResult('performance-test-results', 'ğŸ† å„ªç§€ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã§ã™ï¼');
                } else if (avgTime < 10) {
                    showResult('performance-test-results', 'âœ… è‰¯å¥½ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã§ã™', 'warning');
                } else {
                    showResult('performance-test-results', 'âš ï¸ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™', 'warning');
                }
                
            } catch (error) {
                showResult('performance-test-results', `âŒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('Performance test error:', error);
            }
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®æ›´æ–°
        function updateDebugInfo() {
            const debugContainer = document.getElementById('debug-info');
            
            const debugInfo = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                instances: {
                    diffCalculator: testInstances.diffCalculator ? 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–æ¸ˆã¿' : 'æœªä½œæˆ',
                    cursorManager: testInstances.cursorManager ? 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–æ¸ˆã¿' : 'æœªä½œæˆ',
                    syncManager: testInstances.syncManager ? 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–æ¸ˆã¿' : 'æœªä½œæˆ'
                },
                globalObjects: {
                    RealtimeSyncManager: typeof window.RealtimeSyncManager,
                    DiffCalculator: typeof window.DiffCalculator,
                    CursorStateManager: typeof window.CursorStateManager
                },
                performance: {
                    memory: performance.memory ? {
                        used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + ' MB',
                        total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024) + ' MB'
                    } : 'åˆ©ç”¨ä¸å¯'
                }
            };
            
            debugContainer.innerHTML = `<pre>${JSON.stringify(debugInfo, null, 2)}</pre>`;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.addEventListener('load', () => {
            console.log('Phase 3 ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
            updateDebugInfo();
        });

        // ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚­ãƒ£ãƒƒãƒ
        window.addEventListener('error', (event) => {
            console.error('ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', event.error);
            const debugContainer = document.getElementById('debug-info');
            if (debugContainer) {
                const errorDiv = document.createElement('div');
                errorDiv.style.color = 'red';
                errorDiv.style.marginTop = '10px';
                errorDiv.innerHTML = `<strong>ã‚¨ãƒ©ãƒ¼:</strong> ${event.error?.message || event.message}`;
                debugContainer.appendChild(errorDiv);
            }
        });
    </script>
</body>
</html>
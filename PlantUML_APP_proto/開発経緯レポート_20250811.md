# PlantUML変換アプリ 開発経緯レポート

## 📋 概要
- **プロジェクト名**: 日本語→PlantUML変換アプリ（かんたん図メーカー）
- **開発日**: 2025年8月11日
- **目的**: EC/SaaS運用担当者が日本語で書くだけで業務フロー図を作成できるツール
- **目標**: 従来3時間かかっていた作業を10分に短縮

## 🔍 発生した問題と解決経緯

### 問題1: PlantUMLエンコーディングエラー
#### 症状
- `PlantUmlEncoder is not defined` エラー
- `Failed to execute 'btoa' on 'Window': The string to be encoded contains characters outside of the Latin1 range` エラー

#### 原因
- PlantUMLEncoderライブラリが読み込まれていない
- UTF-8文字列をそのままbtoa()でエンコードしようとしていた
- Kroki APIはdeflate圧縮 + Base64エンコーディングが必要

#### 解決策
```javascript
// Pako.jsライブラリを使用してdeflate圧縮を実装
function encodeForKroki(str) {
    // UTF-8エンコード
    const utf8 = new TextEncoder().encode(str);
    // deflate圧縮（level 9）
    const compressed = pako.deflate(utf8, { level: 9 });
    // Base64エンコード（バイナリセーフな方法）
    let binary = '';
    const bytes = new Uint8Array(compressed);
    for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    const base64 = btoa(binary);
    // URL安全な文字に変換
    return base64
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=/g, '');
}
```

### 問題2: undefinedアクターの表示
#### 症状
- PlantUML図に「undefined」という謎のアクターが表示される
- 「商品」「在庫」「適正レベル」などの概念がアクターとして表示される

#### 原因
- targetが未定義の場合の処理が不完全
- 日本語パターンマッチングで概念・モノをアクターと誤認識

#### 解決策
```javascript
// 非アクター（概念、モノ、状態）のリスト定義
const nonActors = [
    '商品', '在庫', '適正レベル', '問題', '解決', '結果', 
    '状態', '完了', '金額', '売上', '注文', '見積', '請求', 
    '契約', '安全在庫', '納期', '製造', '入荷', '検品', 
    '入庫', '返品'
];

// 非アクターチェックを追加
if (nonActors.includes(actor) || nonActors.some(na => actor.includes(na))) {
    // 前のメッセージのコンテキストでアクションとして処理
    if (messages.length > 0) {
        const lastMsg = messages[messages.length - 1];
        messages.push({
            from: lastMsg.to,
            to: lastMsg.to,
            action: cleanLine.replace(/[。、]$/, ''),
            isUncertain: cleanLine.includes('？')
        });
    }
    return;
}

// undefined対策
if (!target || target === 'undefined' || target === '') {
    target = 'システム'; // 最終的なフォールバック
}
```

### 問題3: 日本語パターンマッチングの限界
#### 症状
- 複雑な業務フローの正確な解析が困難
- 文脈を理解できない
- 主語省略への対応が不完全

#### 原因
- 単純な正規表現パターンマッチングの限界
- 日本語特有の文法（主語省略、助詞の複雑さ）
- ドメイン知識の不足

#### 現在の実装
```javascript
// パターンマッチング例
// パターン1: 「AがBに〜する」「AからBへ〜」
let match = cleanLine.match(/^([^がをに]+?)が([^がをに]+?)に(.+)/);

// パターン2: 「AがBを〜する」
match = cleanLine.match(/^([^がをに]+?)が([^がをに]+?)を(.+)/);

// パターン3: 「Aが〜する」（動作主体のみ）
match = cleanLine.match(/^([^がをに]+?)が(.+)/);
```

## 📊 テスト結果

### 成功したケース
✅ 見積サンプル - 正常に変換・表示
✅ 契約サンプル - 正常に変換・表示
✅ 請求サンプル - 正常に変換・表示
✅ 在庫管理 - 非アクター除外後、正常に表示

### 実装した機能
1. **10種類の複雑な業務フローサンプル**
   - 見積、契約、請求、承認フロー、EC注文処理
   - 返品処理、在庫管理、問合せ対応、採用フロー、経費精算

2. **リアルタイム変換**
   - 入力から1秒後に自動変換

3. **不確定要素の表現**
   - 「？」付きの文は点線で表示

4. **Kroki API連携**
   - SVG形式での高品質な図の生成

## 🚀 今後の改善提案

### 短期的改善（現実的）
1. **編集可能なプレビュー**
   - 生成後に手動で調整できるUI
   - ドラッグ&ドロップでアクター順序変更

2. **テンプレート強化**
   - よく使うパターンの登録機能
   - 業界別テンプレート

3. **エラーハンドリング改善**
   - より分かりやすいエラーメッセージ
   - 修正候補の提示

### 中期的改善
1. **形態素解析導入**
   ```javascript
   // kuromoji.jsを使用した例
   kuromoji.builder({ dicPath: "/dict" }).build((err, tokenizer) => {
       const tokens = tokenizer.tokenize(text);
       // より正確な文法解析が可能
   });
   ```

2. **文脈理解の強化**
   - 前後の文から主語を推測
   - ドメイン辞書の構築

### 長期的改善（理想的）
1. **AI API連携**
   ```javascript
   // OpenAI/Claude APIを使用
   async function parseWithAI(text) {
       const response = await fetch('/api/ai-parse', {
           method: 'POST',
           body: JSON.stringify({ text, mode: 'plantuml' })
       });
       return response.json();
   }
   ```

2. **機械学習モデル**
   - ユーザーの修正から学習
   - 業界特化モデルの開発

## 💡 学んだこと

### 技術的な学び
1. **Kroki APIの仕様**
   - deflate圧縮が必須
   - URL安全なBase64エンコーディングが必要

2. **日本語処理の難しさ**
   - 主語省略への対応
   - 文脈理解の重要性
   - ドメイン知識の必要性

3. **PlantUMLのベストプラクティス**
   - アクターは人・部署・システムのみ
   - 概念やモノはアクターにしない
   - 不確定要素は点線（-->）で表現

### プロジェクト管理の学び
1. **段階的アプローチの重要性**
   - 完璧を求めず、80%の精度で価値提供
   - 残り20%は手動調整で対応

2. **ユーザー視点の重要性**
   - 「3時間→10分」の時短が最優先
   - 100%の精度より使いやすさ

## 📈 成果と評価

### 達成したこと
✅ 基本的な日本語→PlantUML変換機能の実装
✅ 10種類の複雑な業務フローサンプル
✅ エラーなしでの動作
✅ 非エンティティの適切な除外

### 未達成・課題
❌ 100%正確な日本語解析
❌ 複雑な条件分岐の完全対応
❌ 文脈を考慮した主語推測

### 総合評価
- **目標達成度**: 30-40%
- **実用性**: 限定的（大幅な手動修正が必要）
- **ユーザー価値**: 低い（期待した時短効果は得られない）

## 🔧 技術仕様

### 使用技術
- **フロントエンド**: Vanilla JavaScript (ES6+)
- **スタイリング**: CSS3
- **図生成**: Kroki API (PlantUML)
- **圧縮**: Pako.js (deflate)
- **テスト**: Playwright

### ファイル構成
```
PlantUML_APP_proto/
├── index.html           # メインアプリケーション
├── 開発経緯レポート_20250811.md  # このドキュメント
└── スクリーンショット/
    ├── test_estimate_sample.png
    ├── test_inventory_sample.png
    └── test_billing_sample.png
```

## 📝 結論と現実的な評価

### 厳しい現実
現在のパターンマッチングベースの実装では、実務で使える精度には程遠い状態です。

**精度の現実**：
- 単純な「AがBに〜する」パターン: 60-70%程度
- 主語省略のある文: 20-30%程度
- 複雑な条件分岐: ほぼ0%
- 文脈を考慮した解釈: 0%
- **総合精度: 30-40%程度**

### なぜこれほど難しいのか

1. **日本語の特性**
   - 主語の省略が頻繁
   - 助詞の使い方が多様
   - 文脈依存度が高い

2. **業務フローの複雑さ**
   - 暗黙の前提知識が必要
   - 部署間の関係性の理解が必要
   - 業界特有の用語や慣習

3. **技術的限界**
   - 正規表現では文脈理解は不可能
   - 単純なルールベースでは柔軟性がない
   - ドメイン知識の組み込みが困難

### 本当に必要なもの

1. **大規模言語モデル（LLM）の活用**
   ```javascript
   // これが現実的な解決策
   const result = await callGPT4API({
       prompt: "以下の日本語をPlantUMLに変換してください",
       text: japaneseText,
       examples: trainingExamples
   });
   ```

2. **専門的な自然言語処理**
   - 形態素解析
   - 構文解析
   - 意味解析
   - 文脈理解

3. **機械学習ベースのアプローチ**
   - 大量の学習データ
   - ファインチューニング
   - 継続的な改善

### 正直な結論

**現在の実装では「3時間→10分」の目標達成は不可能です。**

むしろ：
- 生成された図の修正に1-2時間
- PlantUMLの文法を理解する必要あり
- 結果的に手作業とあまり変わらない

**本当に価値のあるツールにするには**：
- AI API（GPT-4、Claude）の統合が必須
- または、PlantUMLの直接編集を支援するエディタ機能
- あるいは、より単純な図表記法への変更

このプロトタイプは「技術的な実験」としては意味がありますが、実務での使用には適していません。

---

*作成日: 2025年8月11日*
*作成者: Claude Code & ユーザー*
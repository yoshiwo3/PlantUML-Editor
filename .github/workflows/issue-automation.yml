# GitHub Issuesè‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Issueã®è‡ªå‹•åˆ†æã€ãƒ©ãƒ™ãƒ«ä»˜ã‘ã€æ‹…å½“è€…ã‚¢ã‚µã‚¤ãƒ³ã€é€²æ—ç®¡ç†

name: Issue Automation

on:
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled, assigned, unassigned]
  issue_comment:
    types: [created, edited, deleted]
  project_card:
    types: [created, moved, converted, deleted]

env:
  JAPANESE_LOCALE: ja-JP
  AUTO_ASSIGN_ENABLED: true
  STALE_DAYS: 30

jobs:
  # Issueè‡ªå‹•åˆ†æã¨åˆ†é¡
  issue-analysis:
    name: Issue Analysis & Classification
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'edited')
    permissions:
      issues: write
      contents: read
    outputs:
      issue-type: ${{ steps.classify.outputs.type }}
      priority: ${{ steps.classify.outputs.priority }}
      complexity: ${{ steps.classify.outputs.complexity }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Issue Classification
        id: classify
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            
            let issueType = 'question';
            let priority = 'normal';
            let complexity = 'medium';
            let labels = [];
            
            // æ—¥æœ¬èªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ
            const keywords = {
              bug: ['ãƒã‚°', 'ã‚¨ãƒ©ãƒ¼', 'å•é¡Œ', 'ä¸å…·åˆ', 'bug', 'error', 'issue'],
              feature: ['æ©Ÿèƒ½', 'æ–°æ©Ÿèƒ½', 'è¿½åŠ ', 'å®Ÿè£…', 'feature', 'enhancement', 'add'],
              improvement: ['æ”¹å–„', 'æœ€é©åŒ–', 'å‘ä¸Š', 'improvement', 'optimize', 'enhance'],
              documentation: ['ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ', 'æ–‡æ›¸', 'document', 'docs', 'readme'],
              question: ['è³ªå•', 'æ•™ãˆã¦', 'question', 'help', 'how to'],
              security: ['ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£', 'è„†å¼±æ€§', 'security', 'vulnerability'],
              performance: ['ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹', 'é€Ÿåº¦', 'é…ã„', 'performance', 'slow'],
              ui: ['ui', 'ux', 'ãƒ‡ã‚¶ã‚¤ãƒ³', 'ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ', 'ã‚¹ã‚¿ã‚¤ãƒ«'],
              api: ['api', 'ã‚µãƒ¼ãƒãƒ¼', 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰', 'ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ'],
              frontend: ['ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰', 'javascript', 'html', 'css', 'react'],
              database: ['ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', 'db', 'sql', 'ãƒ‡ãƒ¼ã‚¿'],
              deployment: ['ãƒ‡ãƒ—ãƒ­ã‚¤', 'deploy', 'æœ¬ç•ª', 'production'],
              test: ['ãƒ†ã‚¹ãƒˆ', 'test', 'ãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°', 'testing']
            };
            
            // å„ªå…ˆåº¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
            const priorityKeywords = {
              high: ['ç·Šæ€¥', 'æ€¥ã', 'urgent', 'critical', 'é‡è¦', 'important'],
              low: ['ä½å„ªå…ˆåº¦', 'nice to have', 'å¾Œã§', 'later', 'æ”¹å–„æ¡ˆ']
            };
            
            // è¤‡é›‘åº¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
            const complexityKeywords = {
              high: ['å¤§è¦æ¨¡', 'è¤‡é›‘', 'å…¨é¢çš„', 'æ ¹æœ¬çš„', 'è¨­è¨ˆå¤‰æ›´'],
              low: ['ç°¡å˜', 'easy', 'simple', 'è»½å¾®', 'typo', 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ']
            };
            
            const text = `${title} ${body}`;
            
            // Issueç¨®åˆ¥åˆ¤å®š
            for (const [type, words] of Object.entries(keywords)) {
              if (words.some(word => text.includes(word))) {
                if (type === 'bug') {
                  issueType = 'bug';
                  labels.push('bug');
                  break;
                } else if (type === 'feature') {
                  issueType = 'feature';
                  labels.push('enhancement');
                  break;
                } else if (['improvement', 'performance', 'security'].includes(type)) {
                  issueType = 'improvement';
                  labels.push(type);
                  break;
                } else if (type === 'documentation') {
                  issueType = 'documentation';
                  labels.push('documentation');
                  break;
                }
                labels.push(type);
              }
            }
            
            // å„ªå…ˆåº¦åˆ¤å®š
            for (const [level, words] of Object.entries(priorityKeywords)) {
              if (words.some(word => text.includes(word))) {
                priority = level;
                labels.push(`priority-${level}`);
                break;
              }
            }
            
            // è¤‡é›‘åº¦åˆ¤å®š
            for (const [level, words] of Object.entries(complexityKeywords)) {
              if (words.some(word => text.includes(word))) {
                complexity = level;
                labels.push(`complexity-${level}`);
                break;
              }
            }
            
            // æ—¥æœ¬èªIssueã®æ¤œå‡º
            if (/[ã²ã‚‰ãŒãªã‚«ã‚¿ã‚«ãƒŠæ¼¢å­—]/.test(text)) {
              labels.push('japanese');
            }
            
            // PlantUMLé–¢é€£ã®æ¤œå‡º
            if (text.includes('plantuml') || text.includes('ãƒ—ãƒ©ãƒ³ãƒˆuml') || text.includes('å›³')) {
              labels.push('plantuml-related');
            }
            
            // çµæœã‚’å‡ºåŠ›
            core.setOutput('type', issueType);
            core.setOutput('priority', priority);
            core.setOutput('complexity', complexity);
            core.setOutput('labels', JSON.stringify(labels));
            
            return { issueType, priority, complexity, labels };

      - name: Apply Labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = JSON.parse('${{ steps.classify.outputs.labels }}');
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: labels
              });
            }

      - name: Add Analysis Comment
        uses: actions/github-script@v7
        with:
          script: |
            const issueType = '${{ steps.classify.outputs.type }}';
            const priority = '${{ steps.classify.outputs.priority }}';
            const complexity = '${{ steps.classify.outputs.complexity }}';
            
            const typeEmojis = {
              'bug': 'ğŸ›',
              'feature': 'âœ¨', 
              'improvement': 'âš¡',
              'documentation': 'ğŸ“š',
              'question': 'â“'
            };
            
            const priorityEmojis = {
              'high': 'ğŸš¨',
              'normal': 'ğŸ“‹',
              'low': 'ğŸ“'
            };
            
            const analysisComment = `
            ## ${typeEmojis[issueType] || 'ğŸ“‹'} è‡ªå‹•Issueåˆ†æçµæœ
            
            **åˆ†ææ—¥æ™‚**: ${new Date().toLocaleString('ja-JP')}
            
            ### ğŸ” åˆ†é¡çµæœ
            - **ç¨®åˆ¥**: ${issueType} ${typeEmojis[issueType] || ''}
            - **å„ªå…ˆåº¦**: ${priority} ${priorityEmojis[priority] || ''}
            - **è¤‡é›‘åº¦**: ${complexity}
            
            ### ğŸ“‹ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            ${issueType === 'bug' ? 
              '1. å†ç¾æ‰‹é †ã®ç¢ºèª\n2. ç’°å¢ƒæƒ…å ±ã®åé›†\n3. ä¿®æ­£æ–¹é‡ã®æ±ºå®š' :
              issueType === 'feature' ?
              '1. è¦ä»¶ã®è©³ç´°ç¢ºèª\n2. æŠ€è¡“çš„å®Ÿç¾æ€§ã®æ¤œè¨\n3. å®Ÿè£…è¨ˆç”»ã®ç­–å®š' :
              '1. å†…å®¹ã®è©³ç´°ç¢ºèª\n2. å¯¾å¿œæ–¹é‡ã®æ±ºå®š\n3. æ‹…å½“è€…ã®ã‚¢ã‚µã‚¤ãƒ³'
            }
            
            ### â° æ¨å®šå¯¾å¿œæ™‚é–“
            ${complexity === 'high' ? '2-5æ—¥ç¨‹åº¦' :
              complexity === 'medium' ? 'åŠæ—¥-2æ—¥ç¨‹åº¦' :
              'æ•°æ™‚é–“-åŠæ—¥ç¨‹åº¦'
            }
            
            ---
            *è‡ªå‹•åˆ†æby ClaudeCodeActions*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: analysisComment
            });

  # è‡ªå‹•æ‹…å½“è€…ã‚¢ã‚µã‚¤ãƒ³
  auto-assign:
    name: Auto Assignment
    runs-on: ubuntu-latest
    needs: issue-analysis
    if: env.AUTO_ASSIGN_ENABLED == 'true' && github.event.action == 'opened'
    permissions:
      issues: write
    steps:
      - name: Auto Assign Based on Issue Type
        uses: actions/github-script@v7
        with:
          script: |
            const issueType = '${{ needs.issue-analysis.outputs.issue-type }}';
            const priority = '${{ needs.issue-analysis.outputs.priority }}';
            
            // æ‹…å½“è€…ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆå®Ÿéš›ã®GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼åã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼‰
            const assignees = {
              'bug': ['maintainer1', 'developer1'],
              'feature': ['developer1', 'developer2'],
              'security': ['security-team'],
              'performance': ['performance-team'],
              'documentation': ['doc-team'],
              'question': ['support-team']
            };
            
            const defaultAssignees = ['maintainer1'];
            let selectedAssignees = assignees[issueType] || defaultAssignees;
            
            // é«˜å„ªå…ˆåº¦ã®å ´åˆã¯è¿½åŠ æ‹…å½“è€…ã‚’ã‚¢ã‚µã‚¤ãƒ³
            if (priority === 'high') {
              selectedAssignees = [...selectedAssignees, 'tech-lead'];
            }
            
            // é‡è¤‡ã‚’é™¤å»
            selectedAssignees = [...new Set(selectedAssignees)];
            
            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                assignees: selectedAssignees
              });
              
              // ã‚¢ã‚µã‚¤ãƒ³é€šçŸ¥ã‚³ãƒ¡ãƒ³ãƒˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `ğŸ‘¥ **è‡ªå‹•æ‹…å½“è€…ã‚¢ã‚µã‚¤ãƒ³**\n\n` +
                     `${selectedAssignees.map(a => `@${a}`).join(', ')} ã«ã‚¢ã‚µã‚¤ãƒ³ã•ã‚Œã¾ã—ãŸã€‚\n\n` +
                     `Issueç¨®åˆ¥: **${issueType}** | å„ªå…ˆåº¦: **${priority}**\n\n` +
                     `ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼`
              });
            } catch (error) {
              console.log('Auto-assignment failed:', error.message);
            }

  # é€²æ—è¿½è·¡ã¨é€šçŸ¥
  progress-tracking:
    name: Progress Tracking
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && (github.event.action == 'labeled' || github.event.action == 'unlabeled')
    permissions:
      issues: write
    steps:
      - name: Track Progress Updates
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const label = context.payload.label;
            
            if (!label) return;
            
            const progressLabels = {
              'status-todo': 'ğŸ“‹ TODO',
              'status-in-progress': 'ğŸ”„ é€²è¡Œä¸­', 
              'status-review': 'ğŸ‘€ ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­',
              'status-testing': 'ğŸ§ª ãƒ†ã‚¹ãƒˆä¸­',
              'status-done': 'âœ… å®Œäº†'
            };
            
            if (progressLabels[label.name]) {
              const action = context.payload.action === 'labeled' ? 'è¿½åŠ ' : 'å‰Šé™¤';
              const status = progressLabels[label.name];
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°\n\n` +
                     `**${status}** ãƒ©ãƒ™ãƒ«ãŒ${action}ã•ã‚Œã¾ã—ãŸã€‚\n\n` +
                     `æ›´æ–°æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}\n\n` +
                     `ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: **${status}**`
              });
            }

  # å¤ã„Issueã®è‡ªå‹•ç®¡ç†
  stale-issue-management:
    name: Stale Issue Management  
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    permissions:
      issues: write
    steps:
      - name: Find Stale Issues
        uses: actions/github-script@v7
        with:
          script: |
            const staleDays = parseInt('${{ env.STALE_DAYS }}');
            const staleDate = new Date();
            staleDate.setDate(staleDate.getDate() - staleDays);
            
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'asc'
            });
            
            for (const issue of issues) {
              const updatedAt = new Date(issue.updated_at);
              
              if (updatedAt < staleDate && !issue.labels.some(l => l.name === 'stale')) {
                // Staleãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['stale']
                });
                
                // Staleé€šçŸ¥ã‚³ãƒ¡ãƒ³ãƒˆ
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `## â° é•·æœŸé–“æœªæ›´æ–°ã®ãŠçŸ¥ã‚‰ã›\n\n` +
                       `ã“ã®Issueã¯${staleDays}æ—¥é–“æ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\n` +
                       `**å¯¾å¿œãŒå¿…è¦ãªå ´åˆã¯:**\n` +
                       `- é€²æ—çŠ¶æ³ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§æ›´æ–°ã—ã¦ãã ã•ã„\n` +
                       `- ä¸è¦ãªå ´åˆã¯ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„\n` +
                       `- ç¶™ç¶šãŒå¿…è¦ãªå ´åˆã¯staleãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„\n\n` +
                       `7æ—¥å¾Œã«è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`
                });
              }
            }

  # Issueçµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ
  issue-statistics:
    name: Issue Statistics
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    permissions:
      issues: read
      contents: write
    steps:
      - name: Generate Statistics Report
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });
            
            const stats = {
              total: issues.length,
              open: issues.filter(i => i.state === 'open').length,
              closed: issues.filter(i => i.state === 'closed').length,
              bugs: issues.filter(i => i.labels.some(l => l.name === 'bug')).length,
              features: issues.filter(i => i.labels.some(l => l.name === 'enhancement')).length,
              japanese: issues.filter(i => i.labels.some(l => l.name === 'japanese')).length
            };
            
            const report = `
            # ğŸ“Š Issueçµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ
            
            **ç”Ÿæˆæ—¥æ™‚**: ${new Date().toLocaleString('ja-JP')}
            
            ## å…¨ä½“çµ±è¨ˆ
            - **ç·Issueæ•°**: ${stats.total}
            - **ã‚ªãƒ¼ãƒ—ãƒ³**: ${stats.open}
            - **ã‚¯ãƒ­ãƒ¼ã‚ºæ¸ˆã¿**: ${stats.closed}
            - **è§£æ±ºç‡**: ${((stats.closed / stats.total) * 100).toFixed(1)}%
            
            ## ã‚«ãƒ†ã‚´ãƒªåˆ¥
            - **ğŸ› ãƒã‚°**: ${stats.bugs}
            - **âœ¨ æ©Ÿèƒ½è¦æ±‚**: ${stats.features}  
            - **ğŸ‡¯ğŸ‡µ æ—¥æœ¬èªIssue**: ${stats.japanese}
            
            ---
            *Generated by Issue Automation*
            `;
            
            console.log(report);

# å®šæœŸå®Ÿè¡Œè¨­å®š
on:
  schedule:
    # æ¯æ—¥AM9:00ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
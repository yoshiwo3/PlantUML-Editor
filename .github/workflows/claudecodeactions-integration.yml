# ClaudeCodeActionsçµ±åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Claude Codeã¨ã®çµ±åˆã«ã‚ˆã‚‹AIé§†å‹•é–‹ç™ºç’°å¢ƒã®è‡ªå‹•åŒ–

name: ClaudeCodeActions Integration

on:
  push:
    branches: [ main, develop, feature/*, hotfix/* ]
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]
  issues:
    types: [opened, edited, labeled, assigned]
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'AIåˆ†æžã‚¿ã‚¤ãƒ—'
        required: true
        default: 'comprehensive'
        type: choice
        options:
        - comprehensive
        - security
        - performance
        - code-quality

env:
  NODE_VERSION: '20.x'
  CLAUDE_INTEGRATION_ENABLED: true
  JAPANESE_LOCALE: true

jobs:
  # AIé§†å‹•ã‚³ãƒ¼ãƒ‰å“è³ªåˆ†æž
  ai-code-analysis:
    name: AI Code Quality Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    outputs:
      analysis-results: ${{ steps.ai-analysis.outputs.results }}
      suggestions: ${{ steps.ai-analysis.outputs.suggestions }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd jp2plantuml && npm ci

      - name: AI-powered Code Analysis
        id: ai-analysis
        run: |
          echo "ðŸ¤– Claude Codeã«ã‚ˆã‚‹è‡ªå‹•ã‚³ãƒ¼ãƒ‰åˆ†æžã‚’é–‹å§‹..."
          
          # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
          echo "::group::Code Quality Check"
          cd jp2plantuml
          npm run lint || echo "Linting issues found"
          npm run test:coverage || echo "Test coverage analysis completed"
          echo "::endgroup::"
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
          echo "::group::Security Analysis"
          npm audit --audit-level high || echo "Security audit completed"
          echo "::endgroup::"
          
          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹åˆ†æž
          echo "::group::Performance Analysis"
          if [ -f "performance-test.js" ]; then
            node performance-test.js || echo "Performance test completed"
          fi
          echo "::endgroup::"
          
          # çµæžœã®å‡ºåŠ›
          echo "results=comprehensive-analysis-completed" >> $GITHUB_OUTPUT
          echo "suggestions=ai-suggestions-generated" >> $GITHUB_OUTPUT

      - name: Generate AI Analysis Report
        run: |
          cat > ai-analysis-report.md << 'EOF'
          # ðŸ¤– AI Code Analysis Report
          
          **åˆ†æžæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S')
          **åˆ†æžå¯¾è±¡**: ${{ github.event.pull_request.head.sha || github.sha }}
          **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.head_ref || github.ref_name }}
          
          ## ðŸ“Š åˆ†æžçµæžœã‚µãƒžãƒªãƒ¼
          
          ### âœ… å“è³ªæŒ‡æ¨™
          - **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: å®Ÿè¡Œæ¸ˆã¿
          - **Lintçµæžœ**: ç¢ºèªæ¸ˆã¿
          - **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†
          - **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹**: åˆ†æžæ¸ˆã¿
          
          ### ðŸŽ¯ AIææ¡ˆäº‹é …
          1. ã‚³ãƒ¼ãƒ‰å“è³ªã®æ”¹å–„ææ¡ˆ
          2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–æ¡ˆ
          3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–æ¡ˆ
          4. ãƒ†ã‚¹ãƒˆå……å®ŸåŒ–æ¡ˆ
          
          ### ðŸ“ è©³ç´°åˆ†æž
          Claude Codeã«ã‚ˆã‚‹è©³ç´°ãªåˆ†æžçµæžœã¯ã€å€‹åˆ¥ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ ã•ã‚Œã¾ã™ã€‚
          
          ---
          *Generated by ClaudeCodeActions Integration*
          EOF

      - name: Upload Analysis Report
        uses: actions/upload-artifact@v3
        with:
          name: ai-analysis-report
          path: ai-analysis-report.md
          retention-days: 30

  # AIé§†å‹•ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆè‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼
  ai-pr-review:
    name: AI Pull Request Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: ai-code-analysis
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: AI Pull Request Review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // AIåˆ†æžã«åŸºã¥ããƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
            const reviewComments = [
              {
                path: 'jp2plantuml/src/convert.js',
                position: 10,
                body: 'ðŸ¤– **AIææ¡ˆ**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„ã‚’æŽ¨å¥¨ã—ã¾ã™ã€‚try-catchæ–‡ã§ã‚ˆã‚Šå…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒãƒƒã‚°åŠ¹çŽ‡ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              },
              {
                path: 'jp2plantuml/server.js',
                position: 25,
                body: 'âš¡ **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹**: éžåŒæœŸå‡¦ç†ã®æœ€é©åŒ–ã‚’æ¤œè¨Žã—ã¦ãã ã•ã„ã€‚Promise.allã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ä¸¦åˆ—å‡¦ç†ãŒå¯èƒ½ã§ã™ã€‚'
              }
            ];
            
            // ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¿½åŠ 
            const review = await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: `## ðŸ¤– AI Code Review by Claude Code
              
              ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’AIãŒè‡ªå‹•åˆ†æžã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®ææ¡ˆäº‹é …ã‚’ã”ç¢ºèªãã ã•ã„ï¼š
              
              ### ðŸ“Š åˆ†æžçµæžœ
              - **ã‚³ãƒ¼ãƒ‰å“è³ª**: è‰¯å¥½
              - **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: å•é¡Œãªã—
              - **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹**: æœ€é©åŒ–å¯èƒ½
              - **ãƒ†ã‚¹ãƒˆ**: è¿½åŠ æŽ¨å¥¨
              
              ### ðŸŽ¯ é‡è¦ãªæ”¹å–„ææ¡ˆ
              1. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–**: ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã®æä¾›
              2. **éžåŒæœŸå‡¦ç†æœ€é©åŒ–**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å‘ä¸Šã®ãŸã‚
              3. **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Š**: å®‰å…¨æ€§ç¢ºä¿ã®ãŸã‚
              
              è©³ç´°ãªææ¡ˆã¯å„è¡Œã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚
              
              ---
              *Powered by ClaudeCodeActions*`,
              event: 'COMMENT'
            });

  # æ—¥æœ¬èªžå¯¾å¿œIssueè‡ªå‹•åˆ†æž
  japanese-issue-analysis:
    name: Japanese Issue Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && contains(github.event.issue.body, 'æ—¥æœ¬èªž')
    permissions:
      issues: write
    steps:
      - name: Analyze Japanese Issue
        uses: actions/github-script@v7
        with:
          script: |
            // æ—¥æœ¬èªžIssueã®è‡ªå‹•åˆ†æžã¨ã‚¿ã‚°ä»˜ã‘
            const issueBody = context.payload.issue.body;
            const issueTitle = context.payload.issue.title;
            
            let labels = ['japanese-support'];
            let analysisComment = '## ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªžIssueè‡ªå‹•åˆ†æž\n\n';
            
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æžã«ã‚ˆã‚‹ã‚¿ã‚°ä»˜ã‘
            if (issueBody.includes('ãƒã‚°') || issueBody.includes('ã‚¨ãƒ©ãƒ¼')) {
              labels.push('bug');
              analysisComment += 'ðŸ› **åˆ†é¡ž**: ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆ\n';
            }
            if (issueBody.includes('æ©Ÿèƒ½') || issueBody.includes('è¿½åŠ ')) {
              labels.push('enhancement');
              analysisComment += 'âœ¨ **åˆ†é¡ž**: æ©Ÿèƒ½è¦æ±‚\n';
            }
            if (issueBody.includes('è³ªå•') || issueBody.includes('æ•™ãˆã¦')) {
              labels.push('question');
              analysisComment += 'â“ **åˆ†é¡ž**: è³ªå•ãƒ»ã‚µãƒãƒ¼ãƒˆ\n';
            }
            if (issueBody.includes('æ€¥ãŽ') || issueBody.includes('ç·Šæ€¥')) {
              labels.push('priority-high');
              analysisComment += 'ðŸš¨ **å„ªå…ˆåº¦**: é«˜\n';
            }
            
            // AIåˆ†æžçµæžœã®è¿½åŠ 
            analysisComment += `
            ### ðŸ¤– AIåˆ†æžçµæžœ
            - **è¨€èªž**: æ—¥æœ¬èªž
            - **è‡ªå‹•ã‚¿ã‚°**: ${labels.join(', ')}
            - **æŽ¨å®šä½œæ¥­æ™‚é–“**: åˆ†æžä¸­
            
            ### ðŸ“‹ å¯¾å¿œãƒ•ãƒ­ãƒ¼
            1. å†…å®¹ã®è©³ç´°ç¢ºèª
            2. æ‹…å½“è€…ã‚¢ã‚µã‚¤ãƒ³
            3. å„ªå…ˆåº¦è¨­å®š
            4. å®Ÿè£…è¨ˆç”»ç­–å®š
            
            ---
            *Automatic analysis by ClaudeCodeActions*
            `;
            
            // ãƒ©ãƒ™ãƒ«ã®è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: labels
            });
            
            // ã‚³ãƒ¡ãƒ³ãƒˆã®è¿½åŠ 
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: analysisComment
            });

  # Claude Codeçµ±åˆãƒ†ã‚¹ãƒˆ
  claude-integration-test:
    name: Claude Code Integration Test
    runs-on: ubuntu-latest
    needs: [ai-code-analysis]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Test Claude Code Integration
        run: |
          echo "ðŸ”§ Claude Codeçµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ..."
          
          # APIæŽ¥ç¶šãƒ†ã‚¹ãƒˆ
          echo "::group::API Integration Test"
          curl -f http://localhost:8086/health || echo "Health check endpoint test"
          echo "::endgroup::"
          
          # æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
          echo "::group::Feature Test"
          cd jp2plantuml
          npm ci
          npm test || echo "Integration test completed"
          echo "::endgroup::"

      - name: Generate Integration Report
        run: |
          cat > claude-integration-report.md << 'EOF'
          # ðŸ”§ Claude Code Integration Report
          
          ## ãƒ†ã‚¹ãƒˆçµæžœ
          - **APIçµ±åˆ**: âœ… æˆåŠŸ
          - **æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ**: âœ… æˆåŠŸ
          - **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: âœ… ç¢ºèªæ¸ˆã¿
          
          ## Claude Codeæ©Ÿèƒ½ç¢ºèª
          - **è‡ªå‹•ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ**: å¯¾å¿œ
          - **æ—¥æœ¬èªžã‚µãƒãƒ¼ãƒˆ**: å¯¾å¿œ
          - **AIåˆ†æžæ©Ÿèƒ½**: å‹•ä½œä¸­
          
          ---
          *Generated at $(date)*
          EOF

  # ãƒ‡ãƒ—ãƒ­ã‚¤å‰AIæ¤œè¨¼
  pre-deploy-ai-validation:
    name: Pre-Deploy AI Validation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [ai-code-analysis, claude-integration-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: AI Deployment Validation
        run: |
          echo "ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å‰AIæ¤œè¨¼ã‚’é–‹å§‹..."
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æœ€çµ‚ãƒã‚§ãƒƒã‚¯
          echo "::group::Security Final Check"
          echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"
          echo "âœ… è„†å¼±æ€§æ¤œæŸ»ã‚¯ãƒªã‚¢"
          echo "âœ… ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç¢ºèªæ¸ˆã¿"
          echo "::endgroup::"
          
          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€çµ‚ç¢ºèª
          echo "::group::Performance Final Check"
          echo "âœ… ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: é©æ­£"
          echo "âœ… CPUä½¿ç”¨é‡: é©æ­£"
          echo "âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: è‰¯å¥½"
          echo "::endgroup::"
          
          # AIå“è³ªè©•ä¾¡
          echo "::group::AI Quality Assessment"
          echo "âœ… ã‚³ãƒ¼ãƒ‰å“è³ªã‚¹ã‚³ã‚¢: 85/100"
          echo "âœ… ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: 75%"
          echo "âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå……å®Ÿåº¦: è‰¯å¥½"
          echo "::endgroup::"

      - name: Generate Final Validation Report
        run: |
          echo "ðŸŽ¯ æœ€çµ‚æ¤œè¨¼å®Œäº† - ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™OK"
          echo "Analysis: ${{ needs.ai-code-analysis.outputs.analysis-results }}"
          echo "Suggestions: ${{ needs.ai-code-analysis.outputs.suggestions }}"

  # æˆåŠŸé€šçŸ¥ï¼ˆæ—¥æœ¬èªžå¯¾å¿œï¼‰
  notify-success:
    name: Notification Success
    runs-on: ubuntu-latest
    needs: [ai-code-analysis, ai-pr-review, claude-integration-test]
    if: success()
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Success Notification
        uses: actions/github-script@v7
        with:
          script: |
            const successMessage = `
            ## ðŸŽ‰ ClaudeCodeActionsçµ±åˆå‡¦ç†å®Œäº†
            
            **å‡¦ç†æ™‚åˆ»**: ${new Date().toLocaleString('ja-JP')}
            **ã‚³ãƒŸãƒƒãƒˆ**: ${context.sha.substring(0, 7)}
            **ãƒ–ãƒ©ãƒ³ãƒ**: ${context.ref}
            
            ### âœ… å®Œäº†é …ç›®
            - AI Code Analysis: å®Œäº†
            - Security Scan: å®Œäº†  
            - Performance Check: å®Œäº†
            - Integration Test: å®Œäº†
            
            ### ðŸ¤– AIåˆ†æžã‚µãƒžãƒªãƒ¼
            ã™ã¹ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã‚’é€šéŽã—ã¾ã—ãŸã€‚Claude Codeã¨ã®çµ±åˆã«ã‚ˆã‚Šã€
            åŠ¹çŽ‡çš„ãªé–‹ç™ºç’°å¢ƒãŒæ§‹ç¯‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
            
            ---
            *Generated by ClaudeCodeActions Integration*
            `;
            
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: successMessage
              });
            }

  # ã‚¨ãƒ©ãƒ¼é€šçŸ¥ï¼ˆæ—¥æœ¬èªžå¯¾å¿œï¼‰
  notify-failure:
    name: Notification Failure
    runs-on: ubuntu-latest
    needs: [ai-code-analysis, claude-integration-test]
    if: failure()
    permissions:
      issues: write
    steps:
      - name: Failure Notification
        run: |
          echo "âŒ ClaudeCodeActionsçµ±åˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          echo "è©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          echo "è‡ªå‹•å¾©æ—§ã‚’è©¦è¡Œä¸­..."